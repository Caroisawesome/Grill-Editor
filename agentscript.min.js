(function(){var XY,pt,s,u,_base,_i,_len,_ref,__indexOf=[].indexOf||function(t){for(var n=0,e=this.length;e>n;n++)if(n in this&&this[n]===t)return n;return-1},__slice=[].slice,__hasProp={}.hasOwnProperty,__extends=function(t,n){function e(){this.constructor=t}for(var r in n)__hasProp.call(n,r)&&(t[r]=n[r]);return e.prototype=n.prototype,t.prototype=new e,t.__super__=n.prototype,t},__bind=function(t,n){return function(){return t.apply(n,arguments)}};for(this.ABM={},ABM.root=this,function(){var t,n,e,r;for(this.requestAnimFrame=this.requestAnimationFrame||null,r=["ms","moz","webkit","o"],n=0,e=r.length;e>n;n++)t=r[n],this.requestAnimFrame||(this.requestAnimFrame=this[t+"RequestAnimationFrame"]);return this.requestAnimFrame||(this.requestAnimFrame=function(t){return window.setTimeout(t,1e3/60)})}(),(_base=Array.prototype).indexOf||(_base.indexOf=function(t){var n,e,r,i;for(n=r=0,i=this.length;i>r;n=++r)if(e=this[n],e===t)return n;return-1}),ABM.util={error:function(t){throw Error(t)},isArray:Array.isArray||function(t){return!(!(t&&t.concat&&t.unshift)||t.callee)},isFunction:function(t){return!!(t&&t.constructor&&t.call&&t.apply)},isString:function(t){return!!(""===t||t&&t.charCodeAt&&t.substr)},randomInt:function(t){return Math.floor(Math.random()*t)},randomInt2:function(t,n){return t+Math.floor(Math.random()*(n-t))},randomFloat:function(t){return Math.random()*t},randomFloat2:function(t,n){return t+Math.random()*(n-t)},randomCentered:function(t){return this.randomFloat2(-t/2,t/2)},log10:function(t){return Math.log(t)/Math.LN10},logN:function(t,n){return Math.log(t)/Math.log(n)},ln:function(t){return Math.log(t)},mod:function(t,n){return(t%n+n)%n},wrap:function(t,n,e){return n+this.mod(t-n,e-n)},clamp:function(t,n,e){return Math.max(Math.min(t,e),n)},sign:function(t){return 0>t?-1:1},aToFixed:function(t,n,e){var r;return null==n&&(n=2),null==e&&(e=", "),"["+function(){var e,i,o;for(o=[],e=0,i=t.length;i>e;e++)r=t[e],o.push(r.toFixed(n));return o}().join(e)+"]"},randomColor:function(){return[this.randomInt(256),this.randomInt(256),this.randomInt(256)]},randomGray:function(t,n){var e;return null==t&&(t=64),null==n&&(n=192),e=this.randomInt2(t,n),[e,e,e]},scaleColor:function(t,n,e){var r,i,o,s;for(null==e&&(e=[]),i=o=0,s=t.length;s>o;i=++o)r=t[i],e[i]=this.clamp(Math.round(r*n),0,255);return e},colorStr:function(t){return 3===t.length?"rgb("+t+")":"rgba("+t+")"},colorsEqual:function(t,n){return""+t==""+n},degToRad:function(t){return t*Math.PI/180},radToDeg:function(t){return 180*t/Math.PI},subtractRads:function(t,n){var e,r;return r=t-n,e=Math.PI,-e>=r&&(r+=2*e),r>e&&(r-=2*e),r},any:function(t){return 0!==t.length},empty:function(t){return 0===t.length},clone:function(t){return t.slice(0)},last:function(t){return this.empty(t)&&this.error("last: empty array"),t[t.length-1]},oneOf:function(t){return this.empty(t)&&this.error("oneOf: empty array"),t[this.randomInt(t.length)]},nOf:function(t,n){var e,r;for(n>t.length&&this.error("nOf: n > length"),r=[];n>r.length;)e=this.oneOf(t),0>__indexOf.call(r,e)&&r.push(e);return r},removeItem:function(t,n){var e;return-1!==(e=t.indexOf(n))&&t.splice(e,1),0>e&&this.error("removeItem: item not found"),e},shuffle:function(t){return t.sort(function(){return.5-Math.random()})},minOneOf:function(t,n,e){var r,i,o,s,a,u,h;for(null==e&&(e=!1),this.empty(t)&&this.error("minOneOf: empty array"),o=1/0,i=null,this.isString(n)&&(a=n,n=function(t){return t[a]}),u=0,h=t.length;h>u;u++)r=t[u],o>(s=n(r))&&(o=s,i=r);return e?[i,o]:i},maxOneOf:function(t,n,e){var r,i,o,s,a,u,h;for(null==e&&(e=!1),this.empty(t)&&this.error("maxOneOf: empty array"),o=-1/0,i=null,this.isString(n)&&(a=n,n=function(t){return t[a]}),u=0,h=t.length;h>u;u++)r=t[u],(s=n(r))>o&&(o=s,i=r);return e?[i,o]:i},histOf:function(t,n,e){var r,i,o,s,a,u,h,c,l,p;for(o=[],this.isString(e)&&(a=e,e=function(t){return t[a]}),h=0,l=t.length;l>h;h++)r=t[h],i=Math.floor(e(r)/n),o[i]=null!=(s=o[i])?s+1:1;for(i=c=0,p=o.length;p>c;i=++c)u=o[i],null==u&&(o[i]=0);return o},sortBy:function(t,n){return t.sort(function(t,e){return t[n]-e[n]})},uniq:function(t){var n,e,r;for(n=e=r=t.length-1;e>=1;n=e+=-1)t[n-1]===t[n]&&t.splice(n,1);return t},flatten:function(t){return t.reduce(function(t,n){return t.concat(n)})},binarySearch:function(t,n,e){var r,i,o,s;for(null==e&&(e=function(t){return t}),o=0,s=t.length-1,r=Math.floor((o+s)/2);(i=e(t[r]))!==n&&s>o;)i>n&&(s=r-1),n>i&&(o=r+1),r=Math.floor((s+o)/2);return e(t[r])===n?r:-1},aMax:function(t){return Math.max.apply(Math,t)},aMin:function(t){return Math.min.apply(Math,t)},aPush:function(t,n){return t.push.apply(t,n)},radsToward:function(t,n,e,r){var i,o,s;return i=Math.PI,o=e-t,s=r-n,0===o?0>s?3*i/2:s>0?i/2:0:Math.atan(s/o)+(0>o?i:0)},inCone:function(t,n,e,r,i,o,s){var a;return this.distance(r,i,o,s)>e?!1:(a=this.radsToward(r,i,o,s),n/2>=Math.abs(this.subtractRads(t,a)))},distance:function(t,n,e,r){var i,o;return i=t-e,o=n-r,Math.sqrt(i*i+o*o)},sqDistance:function(t,n,e,r){var i,o;return i=t-e,o=n-r,i*i+o*o},torusDistance:function(t,n,e,r,i,o){return Math.sqrt(this.torusSqDistance(t,n,e,r,i,o))},torusSqDistance:function(t,n,e,r,i,o){var s,a,u,h;return s=Math.abs(e-t),u=Math.abs(r-n),a=Math.min(s,i-s),h=Math.min(u,o-u),a*a+h*h},torusWraps:function(t,n,e,r,i,o){var s,a;return s=Math.abs(e-t),a=Math.abs(r-n),s>i-s||a>o-a},torus4Pts:function(t,n,e,r,i,o){var s,a;return s=t>e?e+i:e-i,a=n>r?r+o:r-o,[[e,r],[s,r],[e,a],[s,a]]},torusPt:function(t,n,e,r,i,o){var s,a,u,h;return a=t>e?e+i:e-i,h=n>r?r+o:r-o,s=Math.abs(a-t)<Math.abs(e-t)?a:e,u=Math.abs(h-n)<Math.abs(r-n)?h:r,[s,u]},torusRadsToward:function(t,n,e,r,i,o){var s;return s=this.torusPt(t,n,e,r,i,o),e=s[0],r=s[1],this.radsToward(t,n,e,r)},inTorusCone:function(t,n,e,r,i,o,s,a,u){var h,c,l,p;for(p=this.torus4Pts(r,i,o,s,a,u),c=0,l=p.length;l>c;c++)if(h=p[c],this.inCone(t,n,e,r,i,h[0],h[1]))return!0;return!1},createLayer:function(t,n,e,r,i,o,s){var a;return null==s&&(s="2d"),a=document.createElement("canvas"),a.setAttribute("style","position:fixed;top:"+n+";left:"+e+";z-index:"+o),a.width=r,a.height=i,a.ctx="2d"===s?a.getContext("2d"):a.getContext("webgl")||a.getContext("experimental-webgl"),document.getElementById(t).appendChild(a),a.ctx},clearCanvas:function(t){return null!=t.save?(t.save(),t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.restore()):(t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT))},fillCanvas:function(t,n){return null!=t.save?(t.save(),t.setTransform(1,0,0,1,0,0),t.fillStyle=this.colorStr(n),t.fillRect(0,0,t.canvas.width,t.canvas.height),t.restore()):(t.clearColor.apply(t,__slice.call(n).concat([1])),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT))},canvasDrawText:function(t,n,e,r){return null==r&&(r=[0,0,0]),t.fillStyle=this.colorStr(r),t.fillText(n,e[0],e[1])},canvasTextParams:function(t,n,e,r){return null==e&&(e="center"),null==r&&(r="middle"),t.font=n,t.textAlign=e,t.textBaseline=r},canvasLabelParams:function(t,n,e){return t.labelColor=n,t.labelXY=e}},ABM.shapes=s={"default":{rotate:!0,draw:function(t){return s.poly(t,[[.5,0],[-.5,-.5],[-.25,0],[-.5,.5]])}},triangle:{rotate:!0,draw:function(t){return s.poly(t,[[.5,0],[-.5,-.4],[-.5,.4]])}},arrow:{rotate:!0,draw:function(t){return s.poly(t,[[.5,0],[0,.5],[0,.2],[-.5,.2],[-.5,-.2],[0,-.2],[0,-.5]])}},bug:{rotate:!0,draw:function(t){var n;return n=Math.PI,t.strokeStyle=t.fillStyle,t.lineWidth=.05,t.moveTo(.4,.225),t.lineTo(.2,0),t.lineTo(.4,-.225),t.stroke(),t.beginPath(),t.arc(.12,0,.13,0,2*n),t.arc(-.05,0,.13,0,2*n),t.arc(-.27,0,.2,0,2*n)}},pyramid:{rotate:!1,draw:function(t){return s.poly(t,[[0,.5],[-.433,-.25],[.433,-.25]])}},circle:{rotate:!1,draw:function(t){return t.arc(0,0,.5,0,2*Math.PI)}},square:{rotate:!1,draw:function(t){return t.fillRect(-.5,-.5,1,1)}},pentagon:{rotate:!1,draw:function(t){return s.poly(t,[[0,.45],[-.45,.1],[-.3,-.45],[.3,-.45],[.45,.1]])}},ring:{rotate:!1,draw:function(t){return t.arc(0,0,.5,0,2*Math.PI,!0),t.closePath(),t.arc(0,0,.3,0,2*Math.PI,!1)}},person:{rotate:!1,draw:function(t){return s.poly(t,[[.15,.2],[.3,0],[.125,-.1],[.125,.05],[.1,-.15],[.25,-.5],[.05,-.5],[0,-.25],[-.05,-.5],[-.25,-.5],[-.1,-.15],[-.125,.05],[-.125,-.1],[-.3,0],[-.15,.2]]),t.closePath(),t.arc(0,.35,.15,0,2*Math.PI)}},names:function(){var t,n,e;e=[];for(t in this)__hasProp.call(this,t)&&(n=this[t],ABM.util.isFunction(n)||e.push(t));return e},add:function(t,n,e){return this[t]={rotate:n,draw:e}},poly:function(t,n){var e,r,i,o;for(e=i=0,o=n.length;o>i;e=++i)r=n[e],0===e?t.moveTo(r[0],r[1]):t.lineTo(r[0],r[1]);return null}},u=ABM.util,ABM.AgentSet=function(_super){function AgentSet(){AgentSet.__super__.constructor.call(this),this.ID=0}return __extends(AgentSet,_super),AgentSet.asSet=function(t,n){var e;return null==n&&(n=ABM.AgentSet),t.__proto__=null!=(e=n.prototype)?e:n.constructor.prototype,t},AgentSet.prototype.add=function(t){return t.id=this.ID++,t.hidden=!1,this.push(t),t},AgentSet.prototype.remove=function(t){var n;return t===this.last()?this.length--:-1!==(n=this.indexOfID(t.id))&&this.splice(n,1),this},AgentSet.prototype.uniq=function(){return u.uniq(this)},AgentSet.prototype.withID=function(t){var n;return-1!==(n=this.indexOfID(t))?this[n]:null},AgentSet.prototype.indexOfID=function(t,n){return null==n&&(n=!0),n||this.sortById(),t===this.last().id?this.length-1:u.binarySearch(this,t,function(t){return t.id})},AgentSet.prototype.asSet=function(t){return ABM.AgentSet.asSet(t)},AgentSet.prototype.asOrderedSet=function(t){return this.asSet(t).sortById()},AgentSet.prototype.toString=function(){var t;return"["+function(){var n,e,r;for(r=[],n=0,e=this.length;e>n;n++)t=this[n],r.push(""+t);return r}.call(this).join(", ")+"]"},AgentSet.prototype.getProp=function(t){var n,e,r,i;for(i=[],e=0,r=this.length;r>e;e++)n=this[e],i.push(n[t]);return i},AgentSet.prototype.getProps=function(t){var n,e,r,i,o;for(u.isString(t)&&(t=t.split(" ")),o=[],r=0,i=this.length;i>r;r++)n=this[r],o.push(function(){var r,i,o;for(o=[],r=0,i=t.length;i>r;r++)e=t[r],o.push(n[e]);return o}());return o},AgentSet.prototype.getWithProp=function(t,n){var e;return this.asSet(function(){var r,i,o;for(o=[],r=0,i=this.length;i>r;r++)e=this[r],e[t]===n&&o.push(e);return o}.call(this))},AgentSet.prototype.setProp=function(t,n){var e,r,i;for(r=0,i=this.length;i>r;r++)e=this[r],e[t]=n;return this},AgentSet.prototype.maxProp=function(t){return Math.max.apply(Math,this.getProp(t))},AgentSet.prototype.minProp=function(t){return Math.min.apply(Math,this.getProp(t))},AgentSet.prototype.shuffle=function(){return u.shuffle(this)},AgentSet.prototype.sortById=function(){return u.sortBy(this,"id")},AgentSet.prototype.clone=function(){return this.asSet(u.clone(this))},AgentSet.prototype.last=function(){return u.last(this)},AgentSet.prototype.any=function(){return u.any(this)},AgentSet.prototype.other=function(t){var n;return this.asSet(function(){var e,r,i;for(i=[],e=0,r=this.length;r>e;e++)n=this[e],n!==t&&i.push(n);return i}.call(this))},AgentSet.prototype.oneOf=function(){return u.oneOf(this)},AgentSet.prototype.nOf=function(t){return this.asSet(u.nOf(this,t))},AgentSet.prototype.minOneOf=function(t,n){return null==n&&(n=!1),u.minOneOf(this,t,n)},AgentSet.prototype.maxOneOf=function(t,n){return null==n&&(n=!1),u.maxOneOf(this,t,n)},AgentSet.prototype.draw=function(t){var n,e,r;for(u.clearCanvas(t),e=0,r=this.length;r>e;e++)n=this[e],n.hidden||n.draw(t);return null},AgentSet.prototype.inRadius=function(t,n,e){var r,i,o,s,a,h;return null==e&&(e=!1),i=n*n,a=t.x,h=t.y,ABM.patches.isTorus?(s=ABM.patches.numX,o=ABM.patches.numY,this.asSet(function(){var n,c,l;for(l=[],n=0,c=this.length;c>n;n++)r=this[n],i>=u.torusSqDistance(a,h,r.x,r.y,s,o)&&(e||r!==t)&&l.push(r);return l}.call(this))):this.asSet(function(){var n,o,s;for(s=[],n=0,o=this.length;o>n;n++)r=this[n],i>=u.sqDistance(a,h,r.x,r.y)&&(e||r!==t)&&s.push(r);return s}.call(this))},AgentSet.prototype.inCone=function(t,n,e,r,i){var o,s,a,h,c,l;return null==i&&(i=!1),a=this.inRadius(t,r,i),c=t.x,l=t.y,ABM.patches.isTorus?(h=ABM.patches.numX,s=ABM.patches.numY,this.asSet(function(){var p,f,d;for(d=[],p=0,f=a.length;f>p;p++)o=a[p],(o===t&&i||u.inTorusCone(n,e,r,c,l,o.x,o.y,h,s))&&d.push(o);return d}())):this.asSet(function(){var s,h,p;for(p=[],s=0,h=a.length;h>s;s++)o=a[s],(o===t&&i||u.inCone(n,e,r,c,l,o.x,o.y))&&p.push(o);return p}())},AgentSet.prototype.ask=function(f){var o,_i,_len;for(u.isString(f)&&eval("f=function(o){return "+f+";}"),_i=0,_len=this.length;_len>_i;_i++)o=this[_i],f(o);return this},AgentSet.prototype["with"]=function(f){var o;return u.isString(f)&&eval("f=function(o){return "+f+";}"),this.asSet(function(){var t,n,e;for(e=[],t=0,n=this.length;n>t;t++)o=this[t],f(o)&&e.push(o);return e}.call(this))},AgentSet}(Array),XY=function(){function t(t,n){this.x=t,this.y=n}return t.prototype.toString=function(){return"{id:"+this.id+",x:"+this.x+",y:"+this.y+"}"},t}(),this.AS=new ABM.AgentSet,_ref=[[0,1],[8,0],[6,4],[1,3],[1,1]],_i=0,_len=_ref.length;_len>_i;_i++)pt=_ref[_i],AS.add(function(t,n,e){e.prototype=t.prototype;var r=new e,i=t.apply(r,n);return Object(i)===i?i:r}(XY,pt,function(){}));u=ABM.util,ABM.Patch=function(){function t(t,n,e){this.x=t,this.y=n,this.color=null!=e?e:[0,0,0],this.n=null,this.n4=null}return t.prototype.toString=function(){return"{id:"+this.id+" xy:"+u.aToFixed([this.x,this.y])+" c:"+this.color+"}"},t.prototype.scaleColor=function(t,n){return u.scaleColor(t,n,this.color)},t.prototype.draw=function(t){var n,e,r;return t.fillStyle=u.colorStr(this.color),t.fillRect(this.x-.5,this.y-.5,1,1),null!=this.label?(r=t.labelXY,n=r[0],e=r[1],t.save(),t.translate(this.x,this.y),t.scale(1/ABM.patches.size,-1/ABM.patches.size),u.canvasDrawText(t,this.label,[n,e],t.labelColor),t.restore()):void 0},t.prototype.agentsHere=function(){var t,n;return null!=(n=this.agents)?n:function(){var n,e,r,i;for(r=ABM.agents,i=[],n=0,e=r.length;e>n;n++)t=r[n],t.p===this&&i.push(t);return i}.call(this)},t.prototype.isOnEdge=function(){return this.x===ABM.patches.minX||this.x===ABM.patches.maxX||this.y===ABM.patches.minY||this.y===ABM.patches.maxY},t.prototype.sprout=function(t,n){var e=this;return null==t&&(t=1),null==n&&(n=function(){}),ABM.agents.create(t,function(t){return t.setXY(e.x,e.y),n(t),t})},t}(),ABM.Patches=function(t){function n(t,e,r,i,o,s){var a,u,h,c,l,p,f,d,g;for(this.size=t,this.minX=e,this.maxX=r,this.minY=i,this.maxY=o,this.isTorus=null!=s?s:!0,n.__super__.constructor.call(this),this.numX=this.maxX-this.minX+1,this.numY=this.maxY-this.minY+1,l=p=i;o>=p;l=p+=1)for(c=f=e;r>=f;c=f+=1)this.add(new ABM.Patch(c,l));for(d=0,g=this.length;g>d;d++)h=this[d],h.n=this.patchRect(h,1,1),h.n4=this.asSet(function(){var t,n,e,r;for(e=h.n,r=[],n=0,t=e.length;t>n;n++)u=e[n],(u.x===h.x||u.y===h.y)&&r.push(u);return r}());a=document.createElement("canvas"),a.width=this.numX,a.height=this.numY,this.pixelsCtx=a.getContext("2d"),this.drawWithPixels=!1}return __extends(n,t),n.prototype.draw=function(t){return this.drawWithPixels?this.drawScaledPixels(t):n.__super__.draw.call(this,t)},n.prototype.patchXY=function(t,n){return this[t-this.minX+this.numX*(n-this.minY)]},n.prototype.clamp=function(t,n){return[u.clamp(t,this.minX-.5,this.maxX+.5),u.clamp(n,this.minY-.5,this.maxY+.5)]},n.prototype.wrap=function(t,n){return[u.wrap(t,this.minX-.5,this.maxX+.5),u.wrap(n,this.minY-.5,this.maxY+.5)]},n.prototype.coord=function(t,n){return this.isTorus?this.wrap(t,n):this.clamp(t,n)},n.prototype.patch=function(t,n){var e;return e=this.coord(t,n),t=e[0],n=e[1],t=u.clamp(Math.round(t),this.minX,this.maxX),n=u.clamp(Math.round(n),this.minY,this.maxY),this.patchXY(t,n)},n.prototype.randomPt=function(){return[u.randomFloat2(this.minX-.5,this.maxX+.5),u.randomFloat2(this.minY-.5,this.maxY+.5)]},n.prototype.bitWidth=function(){return this.numX*this.size},n.prototype.bitHeight=function(){return this.numY*this.size},n.prototype.patches2Bits=function(t){return t*this.size},n.prototype.bits2Patches=function(t){return t/this.size},n.prototype.patchRect=function(t,n,e,r){var i,o,s,a,h,c,l,p,f,d;for(null==r&&(r=!1),o=[],a=h=l=t.y-e,p=t.y+e;p>=h;a=h+=1)for(s=c=f=t.x-n,d=t.x+n;d>=c;s=c+=1)(this.isTorus||s>=this.minX&&this.maxX>=s&&a>=this.minY&&this.maxY>=a)&&(this.isTorus&&(this.minX>s&&(s+=this.numX),s>this.maxX&&(s-=this.numX),this.minY>a&&(a+=this.numY),a>this.maxY&&(a-=this.numY)),i=this.patchXY(s,a),null==i&&(u.error("patchRect: x,y out of bounds, see console.log"),console.log("  x "+s+" y "+a+" p.x "+t.x+" p.y "+t.y+" dx "+n+" dy "+e+" minX "+this.minX+" minY "+this.minY)),(r||t!==i)&&o.push(i));return this.asSet(o)},n.prototype.importDrawing=function(t){var n;return n=new Image,n.onload=function(){var t;return t=ABM.drawing,t.save(),t.setTransform(1,0,0,1,0,0),t.drawImage(n,0,0,t.canvas.width,t.canvas.height),t.restore()},n.src=t},n.prototype.idToPixels=function(t){var n,e,r;return e=t%this.numX,r=this.numY-1-Math.floor(t/this.numX),n=4*(e+r*this.numX)},n.prototype.importColors=function(t){var n,e=this;return n=new Image,n.onload=function(){var t,r,i,o,s,a,u,h;for(n.width!==e.numX||n.height!==e.numY?e.pixelsCtx.drawImage(n,0,0,e.numX,e.numY):e.pixelsCtx.drawImage(n,0,0),r=e.pixelsCtx.getImageData(0,0,e.numX,e.numY).data,a=0,h=e.length;h>a;a++)for(s=e[a],i=e.idToPixels(s.id),t=s.color,o=u=0;2>=u;o=++u)t[o]=r[i+o];return null},n.src=t},n.prototype.drawScaledPixels=function(t){var n,e,r,i,o,s,a,u,h;for(i=this.pixelsCtx.getImageData(0,0,this.numX,this.numY),e=i.data,a=0,h=this.length;h>a;a++){for(s=this[a],r=this.idToPixels(s.id),n=s.color,o=u=0;2>=u;o=++u)e[r+o]=n[o];e[r+3]=255}return this.pixelsCtx.putImageData(i,0,0),t.save(),t.setTransform(1,0,0,1,0,0),t.drawImage(this.pixelsCtx.canvas,0,0,t.canvas.width,t.canvas.height),t.restore()},n.prototype.diffuse=function(t,n,e){var r,i,o,s,a,u,h,c,l,p,f,d,g,y;if(null==e&&(e=null),null==this[0]._diffuseNext)for(u=0,l=this.length;l>u;u++)a=this[u],a._diffuseNext=0;for(h=0,p=this.length;p>h;h++)for(a=this[h],r=a[t]*n,i=r/8,s=a.n.length,a._diffuseNext+=a[t]-r+(8-s)*i,y=a.n,c=0,f=y.length;f>c;c++)o=y[c],o._diffuseNext+=i;for(g=0,d=this.length;d>g;g++)a=this[g],a[t]=a._diffuseNext,a._diffuseNext=0,e&&a.scaleColor(e,a[t]);return null},n}(ABM.AgentSet),ABM.Agent=function(){function t(){this.breed="default",this.x=this.y=0,this.color=u.randomColor(),this.heading=u.randomFloat(2*Math.PI),this.size=1,this.shape=ABM.agents.defaultShape,this.p=ABM.patches.patch(this.x,this.y),null!=this.p.agents&&this.p.agents.push(this),this.penDown=!1,this.penSize=ABM.patches.bits2Patches(1)}return t.prototype.scaleColor=function(t,n){return u.scaleColor(t,n,this.color)},t.prototype.toString=function(){return"{id:"+this.id+" xy:"+u.aToFixed([this.x,this.y])+" c:"+this.color+" h: "+this.heading.toFixed(2)+"}"},t.prototype.setXY=function(t,n){var e,r,i,o,s,a;return this.penDown&&(s=[this.x,this.y],i=s[0],o=s[1]),a=ABM.patches.coord(t,n),this.x=a[0],this.y=a[1],r=this.p,this.p=ABM.patches.patch(this.x,this.y),null!=r.agents&&r!==this.p&&(u.removeItem(r.agents,this),this.p.agents.push(this)),this.penDown?(e=ABM.drawing,e.strokeStyle=u.colorStr(this.color),e.lineWidth=this.penSize,e.beginPath(),e.moveTo(i,o),e.lineTo(t,n),e.stroke()):void 0},t.prototype.moveTo=function(t){return this.setXY(t.x,t.y)},t.prototype.forward=function(t){return this.setXY(this.x+t*Math.cos(this.heading),this.y+t*Math.sin(this.heading))},t.prototype.rotate=function(t){return this.heading=u.wrap(this.heading+t,0,2*Math.PI)},t.prototype.draw=function(t){var n;return n=ABM.shapes[this.shape],t.save(),ABM.agents.staticColors&&null==this.colorStr&&(this.colorStr=u.colorStr(this.color)),t.fillStyle=this.colorStr||u.colorStr(this.color),t.translate(this.x,this.y),t.scale(this.size,this.size),n.rotate&&t.rotate(this.heading),t.beginPath(),n.draw(t),t.closePath(),t.fill(),t.restore()},t.prototype.stamp=function(){return this.draw(ABM.drawing)},t.prototype.distanceXY=function(t,n){return ABM.patches.isTorus?u.torusDistance(this.x,this.y,t,n,ABM.patches.numX,ABM.patches.numY):u.distance(this.x,this.y,t,n)},t.prototype.distance=function(t){return this.distanceXY(t.x,t.y)},t.prototype.torusPtXY=function(t,n){return u.torusPt(this.x,this.y,t,n,ABM.patches.numX,ABM.patches.numY)},t.prototype.torusPt=function(t){return this.torusPtXY(t.x,t.y)},t.prototype.face=function(t){return this.heading=this.towards(t)},t.prototype.towardsXY=function(t,n){return ABM.patches.isTorus?u.torusRadsToward(this.x,this.y,t,n,ABM.patches.numX,ABM.patches.numY):u.radsToward(this.x,this.y,t,n)},t.prototype.towards=function(t){return this.towardsXY(t.x,t.y)},t.prototype.die=function(){var t,n,e,r;for(ABM.agents.remove(this),r=this.links(),n=0,e=r.length;e>n;n++)t=r[n],t.die();return null},t.prototype.hatch=function(t,n){var e=this;return null==t&&(t=1),null==n&&(n=function(){}),ABM.agents.create(t,function(t){var r,i;t.setXY(e.x,e.y);for(r in e)__hasProp.call(e,r)&&(i=e[r],"id"!==r&&(t[r]=i));return n(t),t})},t.prototype.inCone=function(t,n,e,r){return null==r&&(r=!1),t.inCone(this.p,this.heading,n,e,r)},t.prototype.links=function(){var t,n,e,r,i;for(r=ABM.links,i=[],n=0,e=r.length;e>n;n++)t=r[n],(t.end1===this||t.end2===this)&&i.push(t);return i},t.prototype.otherEnd=function(t){return t.end1===this?t.end2:t.end1},t.prototype.linkNeighbors=function(){var t;return ABM.agents.asSet(function(){var n,e,r,i;for(r=this.links(),i=[],n=0,e=r.length;e>n;n++)t=r[n],i.push(this.otherEnd(t));return i}.call(this))},t}(),ABM.Agents=function(t){function n(){n.__super__.constructor.call(this),this.defaultShape="default",this.staticColors=!1}return __extends(n,t),n.prototype.setDefaultShape=function(t){this.defaultShape=t},n.prototype.setStaticColors=function(t){this.staticColors=t},n.prototype.create=function(t,n){var e,r,i;for(null==n&&(n=function(){}),i=[],e=r=1;t>=r;e=r+=1)i.push(function(t){return n(t),t}(this.add(new ABM.Agent)));return i},n.prototype.clear=function(){for(;this.any();)this.last().die();return null},n.prototype.breed=function(t){return this.asSet(this.getWithProp("breed",t))},n.prototype.agentsInPatches=function(t){var n,e,r,i;for(e=[],r=0,i=t.length;i>r;r++)n=t[r],e.push.apply(e,n.agentsHere());return this.asSet(e)},n.prototype.agentRect=function(t,n,e,r){var i;return null==r&&(r=!1),i=ABM.patches.patchRect(t.p,n,e,!0),i=this.agentsInPatches(i),r||u.removeItem(i,t),i},n.prototype.inCone=function(t,n,e,r,i){var o;return null==i&&(i=!1),o=this.agentRect(t,r,r,!0),o.inCone(t,n,e,r,i)},n.prototype.inRadius=function(t,n,e){var r;return null==e&&(e=!1),r=this.agentRect(t,n,n,!0),r.inRadius(t,n,e)},n}(ABM.AgentSet),ABM.Link=function(){function t(t,n){this.end1=t,this.end2=n,this.breed="default",this.color=[130,130,130],this.thickness=ABM.patches.bits2Patches(2)}return t.prototype.draw=function(t){return t.save(),t.strokeStyle=u.colorStr(this.color),t.lineWidth=this.thickness,t.beginPath(),ABM.patches.isTorus?(pt=this.end1.torusPt(this.end2),t.moveTo(this.end1.x,this.end1.y),t.lineTo.apply(t,pt),(pt[0]!==this.end2.x||pt[1]!==this.end2.y)&&(pt=this.end2.torusPt(this.end1),t.moveTo(this.end2.x,this.end2.y),t.lineTo.apply(t,pt))):(t.moveTo(this.end1.x,this.end1.y),t.lineTo(this.end2.x,this.end2.y)),t.closePath(),t.stroke(),t.restore()},t.prototype.die=function(){return ABM.links.remove(this)},t.prototype.bothEnds=function(){return ABM.links.asSet([this.end1,this.end2])},t.prototype.length=function(){return this.end1.distance(this.end2)},t.prototype.otherEnd=function(t){return this.end1===t?this.end2:this.end1},t}(),ABM.Links=function(t){function n(){n.__super__.constructor.call(this)}return __extends(n,t),n.prototype.create=function(t,n,e){var r,i,o,s;for(null==e&&(e=function(){}),null==n.length&&(n=[n]),s=[],i=0,o=n.length;o>i;i++)r=n[i],s.push(function(t){return e(t),t}(this.add(new ABM.Link(t,r))));return s},n.prototype.clear=function(){for(;this.any();)this.last().die();return null},n.prototype.breed=function(t){return this.getWithProp("breed",t)},n.prototype.allEnds=function(){var t,n,e,r;for(n=this.asSet([]),e=0,r=this.length;r>e;e++)t=this[e],n.push.apply(n,t.bothEnds());return n},n.prototype.nodes=function(){return this.allEnds().sortById().uniq()},n.prototype.layoutCircle=function(t,n,e,r){var i,o,s,a,u;for(null==e&&(e=Math.PI/2),null==r&&(r=-1),o=2*Math.PI/t.length,s=a=0,u=t.length;u>a;s=++a)i=t[s],i.setXY(0,0),i.heading=e+r*o*s,i.forward(n);return null},n}(ABM.AgentSet),u=ABM.util,ABM.Model=function(){function t(t,n,e,r,i,o,s,a){var h,c,l,p,f,d,g,y;for(null==s&&(s=!0),null==a&&(a=[10,10]),this.animate=__bind(this.animate,this),ABM.model=this,this.patches=ABM.patches=new ABM.Patches(n,e,r,i,o,s),this.agents=ABM.agents=new ABM.Agents,this.links=ABM.links=new ABM.Links,p=function(){var n,e;for(e=[],c=n=0;3>=n;c=++n)e.push(u.createLayer.apply(u,[t].concat(__slice.call(a),[this.patches.bitWidth()],[this.patches.bitHeight()],[c],["2d"])));return e}.call(this),this.drawing=ABM.drawing=p[1],d=0,g=p.length;g>d;d++)h=p[d],h.save(),h.scale(this.patches.size,-this.patches.size),h.translate(-(this.patches.minX-.5),-(this.patches.maxY+.5));this.contexts=ABM.contexts={patches:p[0],drawing:p[1],links:p[2],agents:p[3]},y=this.contexts;for(l in y)f=y[l],f.agentSetName=l;this.showFPS=!0,this.ticks=1,this.refreshLinks=this.refreshAgents=this.refreshPatches=!0,this.fastPatches=!1,this.setup()}return t.prototype.setFastPatches=function(t){return null==t&&(t=!0),this.contexts.patches.imageSmoothingEnabled=!t,this.contexts.patches.mozImageSmoothingEnabled=!t,this.contexts.patches.webkitImageSmoothingEnabled=!t,this.patches.drawWithPixels=t},t.prototype.setCacheAgentsHere=function(t){var n,e,r,i,o,s,a,u,h;if(null==t&&(t=!0),t){for(a=this.patches,r=0,o=a.length;o>r;r++)e=a[r],e.agents=[];for(u=this.agents,h=[],i=0,s=u.length;s>i;i++)n=u[i],h.push(n.p.agents.push(n));return h}},t.prototype.setAgentStaticColors=function(t){return null==t&&(t=!0),this.agents.setStaticColors(t)},t.prototype.agentSetName=function(t){return t.constructor.name.toLowerCase()},t.prototype.setTextParams=function(t,n,e,r){return null==e&&(e="center"),null==r&&(r="middle"),"string"!=typeof t&&(t=this.agentSetName(t)),u.canvasTextParams(this.contexts[t],n,e,r)},t.prototype.setLabelParams=function(t,n,e){return"string"!=typeof t&&(t=this.agentSetName(t)),u.canvasLabelParams(this.contexts[t],n,e)},t.prototype.setup=function(){},t.prototype.step=function(){},t.prototype.startup=function(){},t.prototype.start=function(){return 1===this.ticks&&this.startup(),this.startMS=Date.now(),this.startTick=this.ticks,this.animStop=!1,this.animate()},t.prototype.stop=function(){return this.animStop=!0},t.prototype.draw=function(){return(this.refreshPatches||1===this.ticks)&&this.patches.draw(this.contexts.patches),(this.refreshLinks||1===this.ticks)&&this.links.draw(this.contexts.links),this.refreshAgents||1===this.ticks?this.agents.draw(this.contexts.agents):void 0},t.prototype.animate=function(){return this.step(),this.draw(),this.tick(),this.animStop?void 0:requestAnimFrame(this.animate)},t.prototype.tick=function(){var t,n;return t=this.ticks-this.startTick,this.showFPS&&0===t%100&&0!==t&&(n=Math.round(1e3*t/(Date.now()-this.startMS)),console.log("fps: "+n+" at "+t+" ticks")),this.ticks++},t.prototype.linkBreeds=function(t){var n,e,r,i;for(i=t.split(" "),e=0,r=i.length;r>e;e++)n=i[e],this[n]=function(t){return function(){return this.links.breed(t)}}(n);return null},t.prototype.agentBreeds=function(t){var n,e,r,i;for(i=t.split(" "),e=0,r=i.length;r>e;e++)n=i[e],this[n]=function(t){return function(){return this.agents.breed(t)}}(n);return null},t.prototype.asSet=function(t){return ABM.AgentSet.asSet(t)},t.prototype.setRootVars=function(){return ABM.root.ps=this.patches,ABM.root.as=this.agents,ABM.root.ls=this.links,ABM.root.dr=this.drawing,ABM.root.u=ABM.util,ABM.root.app=this,ABM.root.cx=this.contexts,ABM.root.cl=function(t){return console.log(t)},ABM.root.cla=function(t){var n,e,r,i;for(i=[],e=0,r=t.length;r>e;e++)n=t[e],i.push(console.log(n));return i},null},t}()}).call(this);