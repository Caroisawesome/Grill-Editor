(function(){var XY,pt,s,u,_base,_i,_len,_ref,__indexOf=[].indexOf||function(t){for(var n=0,r=this.length;r>n;n++)if(n in this&&this[n]===t)return n;return-1},__slice=[].slice,__hasProp={}.hasOwnProperty,__extends=function(t,n){function r(){this.constructor=t}for(var e in n)__hasProp.call(n,e)&&(t[e]=n[e]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},__bind=function(t,n){return function(){return t.apply(n,arguments)}};for(this.ABM={},ABM.root=this,function(){var t,n,r,e;for(this.requestAnimFrame=this.requestAnimationFrame||null,e=["ms","moz","webkit","o"],n=0,r=e.length;r>n;n++)t=e[n],this.requestAnimFrame||(this.requestAnimFrame=this[t+"RequestAnimationFrame"]);return this.requestAnimFrame||(this.requestAnimFrame=function(t){return window.setTimeout(t,1e3/60)})}(),(_base=Array.prototype).indexOf||(_base.indexOf=function(t){var n,r,e,i;for(n=e=0,i=this.length;i>e;n=++e)if(r=this[n],r===t)return n;return-1}),ABM.util={error:function(t){throw Error(t)},isArray:Array.isArray||function(t){return!(!(t&&t.concat&&t.unshift)||t.callee)},isFunction:function(t){return!!(t&&t.constructor&&t.call&&t.apply)},isString:function(t){return!!(""===t||t&&t.charCodeAt&&t.substr)},randomInt:function(t){return Math.floor(Math.random()*t)},randomInt2:function(t,n){return t+Math.floor(Math.random()*(n-t))},randomFloat:function(t){return Math.random()*t},randomFloat2:function(t,n){return t+Math.random()*(n-t)},randomCentered:function(t){return this.randomFloat2(-t/2,t/2)},log10:function(t){return Math.log(t)/Math.LN10},logN:function(t,n){return Math.log(t)/Math.log(n)},ln:function(t){return Math.log(t)},mod:function(t,n){return(t%n+n)%n},wrap:function(t,n,r){return n+this.mod(t-n,r-n)},clamp:function(t,n,r){return Math.max(Math.min(t,r),n)},sign:function(t){return 0>t?-1:1},aToFixed:function(t,n,r){var e;return null==n&&(n=2),null==r&&(r=", "),"["+function(){var r,i,o;for(o=[],r=0,i=t.length;i>r;r++)e=t[r],o.push(e.toFixed(n));return o}().join(r)+"]"},randomColor:function(){return[this.randomInt(256),this.randomInt(256),this.randomInt(256)]},randomGray:function(t,n){var r;return null==t&&(t=64),null==n&&(n=192),r=this.randomInt2(t,n),[r,r,r]},scaleColor:function(t,n){var r,e,i,o;for(o=[],e=0,i=t.length;i>e;e++)r=t[e],o.push(this.clamp(Math.round(r*n),0,255));return o},colorStr:function(t){return 3===t.length?"rgb("+t+")":"rgba("+t+")"},colorsEqual:function(t,n){return""+t==""+n},degToRad:function(t){return t*Math.PI/180},radToDeg:function(t){return 180*t/Math.PI},subtractRads:function(t,n){var r,e;return e=t-n,r=Math.PI,-r>=e&&(e+=2*r),e>r&&(e-=2*r),e},any:function(t){return 0!==t.length},empty:function(t){return 0===t.length},clone:function(t){return t.slice(0)},last:function(t){return this.empty(t)&&this.error("last: empty array"),t[t.length-1]},oneOf:function(t){return this.empty(t)&&this.error("oneOf: empty array"),t[this.randomInt(t.length)]},nOf:function(t,n){var r,e;for(n>t.length&&this.error("nOf: n > length"),e=[];n>e.length;)r=this.oneOf(t),0>__indexOf.call(e,r)&&e.push(r);return e},shuffle:function(t){return t.sort(function(){return.5-Math.random()})},minOneOf:function(t,n,r){var e,i,o,s,u,h,a;for(null==r&&(r=!1),this.empty(t)&&this.error("minOneOf: empty array"),o=1/0,i=null,this.isString(n)&&(u=n,n=function(t){return t[u]}),h=0,a=t.length;a>h;h++)e=t[h],o>(s=n(e))&&(o=s,i=e);return r?[i,o]:i},maxOneOf:function(t,n,r){var e,i,o,s,u,h,a;for(null==r&&(r=!1),this.empty(t)&&this.error("maxOneOf: empty array"),o=-1/0,i=null,this.isString(n)&&(u=n,n=function(t){return t[u]}),h=0,a=t.length;a>h;h++)e=t[h],(s=n(e))>o&&(o=s,i=e);return r?[i,o]:i},histOf:function(t,n,r){var e,i,o,s,u,h,a,c,l,p;for(o=[],this.isString(r)&&(u=r,r=function(t){return t[u]}),a=0,l=t.length;l>a;a++)e=t[a],i=Math.floor(r(e)/n),o[i]=null!=(s=o[i])?s+1:1;for(i=c=0,p=o.length;p>c;i=++c)h=o[i],null==h&&(o[i]=0);return o},sortBy:function(t,n){return t.sort(function(t,r){return t[n]-r[n]})},uniq:function(t){var n,r,e;for(n=r=e=t.length-1;r>=1;n=r+=-1)t[n-1]===t[n]&&t.splice(n,1);return t},flatten:function(t){return t.reduce(function(t,n){return t.concat(n)})},binarySearch:function(t,n,r){var e,i,o,s;for(null==r&&(r=function(t){return t}),o=0,s=t.length-1,e=Math.floor((o+s)/2);(i=r(t[e]))!==n&&s>o;)i>n&&(s=e-1),n>i&&(o=e+1),e=Math.floor((s+o)/2);return r(t[e])===n?e:-1},aMax:function(t){return Math.max.apply(Math,t)},aMin:function(t){return Math.min.apply(Math,t)},aPush:function(t,n){return t.push.apply(t,n)},radsToward:function(t,n,r,e){var i,o,s;return i=Math.PI,o=r-t,s=e-n,0===o?0>s?3*i/2:s>0?i/2:0:Math.atan(s/o)+(0>o?i:0)},inCone:function(t,n,r,e,i,o,s){var u;return this.distance(e,i,o,s)>r?!1:(u=this.radsToward(e,i,o,s),n/2>=Math.abs(this.subtractRads(t,u)))},distance:function(t,n,r,e){var i,o;return i=t-r,o=n-e,Math.sqrt(i*i+o*o)},sqDistance:function(t,n,r,e){var i,o;return i=t-r,o=n-e,i*i+o*o},torusDistance:function(t,n,r,e,i,o){return Math.sqrt(this.torusSqDistance(t,n,r,e,i,o))},torusSqDistance:function(t,n,r,e,i,o){var s,u,h,a;return s=Math.abs(r-t),h=Math.abs(e-n),u=Math.min(s,i-s),a=Math.min(h,o-h),u*u+a*a},torusWraps:function(t,n,r,e,i,o){var s,u;return s=Math.abs(r-t),u=Math.abs(e-n),s>i-s||u>o-u},torus4Pts:function(t,n,r,e,i,o){var s,u;return s=t>r?r+i:r-i,u=n>e?e+o:e-o,[[r,e],[s,e],[r,u],[s,u]]},torusPt:function(t,n,r,e,i,o){var s,u,h,a;return u=t>r?r+i:r-i,a=n>e?e+o:e-o,s=Math.abs(u-t)<Math.abs(r-t)?u:r,h=Math.abs(a-n)<Math.abs(e-n)?a:e,[s,h]},torusRadsToward:function(t,n,r,e,i,o){var s;return s=this.torusPt(t,n,r,e,i,o),r=s[0],e=s[1],this.radsToward(t,n,r,e)},inTorusCone:function(t,n,r,e,i,o,s,u,h){var a,c,l,p;for(p=this.torus4Pts(e,i,o,s,u,h),c=0,l=p.length;l>c;c++)if(a=p[c],this.inCone(t,n,r,e,i,a[0],a[1]))return!0;return!1},createLayer:function(t,n,r,e,i,o,s){var u;return null==s&&(s="2d"),u=document.createElement("canvas"),u.setAttribute("style","position:fixed;top:"+n+";left:"+r+";z-index:"+o),u.width=e,u.height=i,u.ctx="2d"===s?u.getContext("2d"):u.getContext("webgl")||u.getContext("experimental-webgl"),document.getElementById(t).appendChild(u),u.ctx},clearCanvas:function(t){return null!=t.save?(t.save(),t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.restore()):(t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT))},fillCanvas:function(t,n){return null!=t.save?(t.save(),t.setTransform(1,0,0,1,0,0),t.fillStyle=this.colorStr(n),t.fillRect(0,0,t.canvas.width,t.canvas.height),t.restore()):(t.clearColor.apply(t,__slice.call(n).concat([1])),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT))},canvasDrawText:function(t,n,r,e){return null==e&&(e=[0,0,0]),t.fillStyle=this.colorStr(e),t.fillText(n,r[0],r[1])},canvasTextParams:function(t,n,r,e){return null==r&&(r="center"),null==e&&(e="middle"),t.font=n,t.textAlign=r,t.textBaseline=e},canvasLabelParams:function(t,n,r){return t.labelColor=n,t.labelXY=r}},ABM.shapes=s={"default":{rotate:!0,draw:function(t){return s.poly(t,[[.5,0],[-.5,-.5],[-.25,0],[-.5,.5]])}},triangle:{rotate:!0,draw:function(t){return s.poly(t,[[.5,0],[-.5,-.4],[-.5,.4]])}},arrow:{rotate:!0,draw:function(t){return s.poly(t,[[.5,0],[0,.5],[0,.2],[-.5,.2],[-.5,-.2],[0,-.2],[0,-.5]])}},bug:{rotate:!0,draw:function(t){var n;return n=Math.PI,t.strokeStyle=t.fillStyle,t.lineWidth=.05,t.moveTo(.4,.225),t.lineTo(.2,0),t.lineTo(.4,-.225),t.stroke(),t.beginPath(),t.arc(.12,0,.13,0,2*n),t.arc(-.05,0,.13,0,2*n),t.arc(-.27,0,.2,0,2*n)}},pyramid:{rotate:!1,draw:function(t){return s.poly(t,[[0,.5],[-.433,-.25],[.433,-.25]])}},circle:{rotate:!1,draw:function(t){return t.arc(0,0,.5,0,2*Math.PI)}},square:{rotate:!1,draw:function(t){return t.fillRect(-.5,-.5,1,1)}},pentagon:{rotate:!1,draw:function(t){return s.poly(t,[[0,.45],[-.45,.1],[-.3,-.45],[.3,-.45],[.45,.1]])}},ring:{rotate:!1,draw:function(t){return t.arc(0,0,.5,0,2*Math.PI,!0),t.closePath(),t.arc(0,0,.3,0,2*Math.PI,!1)}},person:{rotate:!1,draw:function(t){return s.poly(t,[[.15,.2],[.3,0],[.125,-.1],[.125,.05],[.1,-.15],[.25,-.5],[.05,-.5],[0,-.25],[-.05,-.5],[-.25,-.5],[-.1,-.15],[-.125,.05],[-.125,-.1],[-.3,0],[-.15,.2]]),t.closePath(),t.arc(0,.35,.15,0,2*Math.PI)}},names:function(){var t,n,r;r=[];for(t in this)__hasProp.call(this,t)&&(n=this[t],ABM.util.isFunction(n)||r.push(t));return r},add:function(t,n,r){return this[t]={rotate:n,draw:r}},poly:function(t,n){var r,e,i,o;for(r=i=0,o=n.length;o>i;r=++i)e=n[r],0===r?t.moveTo(e[0],e[1]):t.lineTo(e[0],e[1]);return null}},u=ABM.util,ABM.AgentSet=function(_super){function AgentSet(){AgentSet.__super__.constructor.call(this),this.ID=0}return __extends(AgentSet,_super),AgentSet.asSet=function(t){return null!=t.prototype?t.prototype=ABM.AgentSet.prototype:t.__proto__=ABM.AgentSet.prototype,t},AgentSet.prototype.add=function(t){return t.id=this.ID++,t.hidden=!1,this.push(t),t},AgentSet.prototype.remove=function(t){var n;return t===this.last()?this.length--:-1!==(n=this.indexOfID(t.id))&&this.splice(n,1),this},AgentSet.prototype.uniq=function(){return u.uniq(this)},AgentSet.prototype.withID=function(t){var n;return-1!==(n=this.indexOfID(t))?this[n]:null},AgentSet.prototype.indexOfID=function(t,n){return null==n&&(n=!0),n||this.sortById(),t===this.last().id?this.length-1:u.binarySearch(this,t,function(t){return t.id})},AgentSet.prototype.asSet=function(t){return ABM.AgentSet.asSet(t)},AgentSet.prototype.asOrderedSet=function(t){return this.asSet(t).sortById()},AgentSet.prototype.toString=function(){var t;return"["+function(){var n,r,e;for(e=[],n=0,r=this.length;r>n;n++)t=this[n],e.push(""+t);return e}.call(this).join(", ")+"]"},AgentSet.prototype.getProp=function(t){var n,r,e,i;for(i=[],r=0,e=this.length;e>r;r++)n=this[r],i.push(n[t]);return i},AgentSet.prototype.getProps=function(t){var n,r,e,i,o;for(u.isString(t)&&(t=t.split(" ")),o=[],e=0,i=this.length;i>e;e++)n=this[e],o.push(function(){var e,i,o;for(o=[],e=0,i=t.length;i>e;e++)r=t[e],o.push(n[r]);return o}());return o},AgentSet.prototype.getWithProp=function(t,n){var r;return this.asSet(function(){var e,i,o;for(o=[],e=0,i=this.length;i>e;e++)r=this[e],r[t]===n&&o.push(r);return o}.call(this))},AgentSet.prototype.setProp=function(t,n){var r,e,i;for(e=0,i=this.length;i>e;e++)r=this[e],r[t]=n;return this},AgentSet.prototype.maxProp=function(t){return Math.max.apply(Math,this.getProp(t))},AgentSet.prototype.minProp=function(t){return Math.min.apply(Math,this.getProp(t))},AgentSet.prototype.shuffle=function(){return u.shuffle(this)},AgentSet.prototype.sortById=function(){return u.sortBy(this,"id")},AgentSet.prototype.clone=function(){return this.asSet(u.clone(this))},AgentSet.prototype.last=function(){return u.last(this)},AgentSet.prototype.any=function(){return u.any(this)},AgentSet.prototype.other=function(t){var n;return this.asSet(function(){var r,e,i;for(i=[],r=0,e=this.length;e>r;r++)n=this[r],n!==t&&i.push(n);return i}.call(this))},AgentSet.prototype.oneOf=function(){return u.oneOf(this)},AgentSet.prototype.nOf=function(t){return this.asSet(u.nOf(this,t))},AgentSet.prototype.minOneOf=function(t,n){return null==n&&(n=!1),u.minOneOf(this,t,n)},AgentSet.prototype.maxOneOf=function(t,n){return null==n&&(n=!1),u.maxOneOf(this,t,n)},AgentSet.prototype.draw=function(t){var n,r,e;for(u.clearCanvas(t),r=0,e=this.length;e>r;r++)n=this[r],n.hidden||n.draw(t);return null},AgentSet.prototype.inRadius=function(t,n,r){var e,i,o,s,h,a;return null==r&&(r=!1),i=n*n,h=t.x,a=t.y,ABM.patches.isTorus?(s=ABM.patches.numX,o=ABM.patches.numY,this.asSet(function(){var n,c,l;for(l=[],n=0,c=this.length;c>n;n++)e=this[n],i>=u.torusSqDistance(h,a,e.x,e.y,s,o)&&(r||e!==t)&&l.push(e);return l}.call(this))):this.asSet(function(){var n,o,s;for(s=[],n=0,o=this.length;o>n;n++)e=this[n],i>=u.sqDistance(h,a,e.x,e.y)&&(r||e!==t)&&s.push(e);return s}.call(this))},AgentSet.prototype.inCone=function(t,n,r,e,i){var o,s,h,a,c,l;return null==i&&(i=!1),h=this.inRadius(t,e,i),c=t.x,l=t.y,ABM.patches.isTorus?(a=ABM.patches.numX,s=ABM.patches.numY,this.asSet(function(){var p,f,d;for(d=[],p=0,f=h.length;f>p;p++)o=h[p],(o===t&&i||u.inTorusCone(n,r,e,c,l,o.x,o.y,a,s))&&d.push(o);return d}())):this.asSet(function(){var s,a,p;for(p=[],s=0,a=h.length;a>s;s++)o=h[s],(o===t&&i||u.inCone(n,r,e,c,l,o.x,o.y))&&p.push(o);return p}())},AgentSet.prototype.ask=function(f){var o,_i,_len;for(u.isString(f)&&eval("f=function(o){return "+f+";}"),_i=0,_len=this.length;_len>_i;_i++)o=this[_i],f(o);return this},AgentSet.prototype["with"]=function(f){var o;return u.isString(f)&&eval("f=function(o){return "+f+";}"),this.asSet(function(){var t,n,r;for(r=[],t=0,n=this.length;n>t;t++)o=this[t],f(o)&&r.push(o);return r}.call(this))},AgentSet}(Array),XY=function(){function t(t,n){this.x=t,this.y=n}return t.prototype.toString=function(){return"{id:"+this.id+",x:"+this.x+",y:"+this.y+"}"},t}(),this.AS=new ABM.AgentSet,_ref=[[0,1],[8,0],[6,4],[1,3],[1,1]],_i=0,_len=_ref.length;_len>_i;_i++)pt=_ref[_i],AS.add(function(t,n,r){r.prototype=t.prototype;var e=new r,i=t.apply(e,n);return Object(i)===i?i:e}(XY,pt,function(){}));u=ABM.util,ABM.Patch=function(){function t(t,n,r){this.x=t,this.y=n,this.color=null!=r?r:[0,0,0],this.n=null,this.n4=null}return t.prototype.toString=function(){return"{id:"+this.id+" xy:"+u.aToFixed([this.x,this.y])+" c:"+this.color+"}"},t.prototype.scaleColor=function(t,n){return this.color=u.scaleColor(t,n)},t.prototype.draw=function(t){var n,r,e;return t.fillStyle=u.colorStr(this.color),t.fillRect(this.x-.5,this.y-.5,1,1),null!=this.label?(e=t.labelXY,n=e[0],r=e[1],t.save(),t.translate(this.x,this.y),t.scale(1/ABM.patches.size,-1/ABM.patches.size),u.canvasDrawText(t,this.label,[n,r],t.labelColor),t.restore()):void 0},t.prototype.agentsHere=function(){var t,n,r,e;for(e=[],n=0,r=agents.length;r>n;n++)t=agents[n],t.p===this&&e.push(t);return e},t.prototype.isOnEdge=function(){return this.x===ABM.patches.minX||this.x===ABM.patches.maxX||this.y===ABM.patches.minY||this.y===ABM.patches.maxY},t.prototype.sprout=function(t,n){var r=this;return null==t&&(t=1),null==n&&(n=function(){}),ABM.agents.create(t,function(t){return t.setXY(r.x,r.y),n(t),t})},t.prototype.patchRect=function(t,n,r){return null==r&&(r=!1),ABM.patches.patchRect(this,t,n,r=!1)},t}(),ABM.Patches=function(t){function n(t,r,e,i,o,s){var u,h,a,c,l,p,f,d;for(this.size=t,this.minX=r,this.maxX=e,this.minY=i,this.maxY=o,this.isTorus=null!=s?s:!0,n.__super__.constructor.call(this),this.numX=this.maxX-this.minX+1,this.numY=this.maxY-this.minY+1,c=l=i;o>=l;c=l+=1)for(a=p=r;e>=p;a=p+=1)this.add(new ABM.Patch(a,c));for(f=0,d=this.length;d>f;f++)h=this[f],h.n=this.asOrderedSet(this.patchRect(h,1,1)),h.n4=this.asOrderedSet(function(){var t,n,r,e;for(r=h.n,e=[],n=0,t=r.length;t>n;n++)u=r[n],(u.x===h.x||u.y===h.y)&&e.push(u);return e}())}return __extends(n,t),n.prototype.patchXY=function(t,n){return this[t-this.minX+this.numX*(n-this.minY)]},n.prototype.clamp=function(t,n){return[u.clamp(t,this.minX-.5,this.maxX+.5),u.clamp(n,this.minY-.5,this.maxY+.5)]},n.prototype.wrap=function(t,n){return[u.wrap(t,this.minX-.5,this.maxX+.5),u.wrap(n,this.minY-.5,this.maxY+.5)]},n.prototype.coord=function(t,n){return this.isTorus?this.wrap(t,n):this.clamp(t,n)},n.prototype.patch=function(t,n){var r;return r=this.coord(t,n),t=r[0],n=r[1],t=u.clamp(Math.round(t),this.minX,this.maxX),n=u.clamp(Math.round(n),this.minY,this.maxY),this.patchXY(t,n)},n.prototype.randomPt=function(){return[u.randomFloat2(this.minX-.5,this.maxX+.5),u.randomFloat2(this.minY-.5,this.maxY+.5)]},n.prototype.bitWidth=function(){return this.numX*this.size},n.prototype.bitHeight=function(){return this.numY*this.size},n.prototype.patches2Bits=function(t){return t*this.size},n.prototype.bits2Patches=function(t){return t/this.size},n.prototype.patchRect=function(t,n,r,e){var i,o,s,u,h,a,c,l,p,f;for(null==e&&(e=!1),o=[],u=h=c=t.y-r,l=t.y+r;l>=h;u=h+=1)for(s=a=p=t.x-n,f=t.x+n;f>=a;s=a+=1)(this.isTorus||s>=this.minX&&this.maxX>=s&&u>=this.minY&&this.maxY>=u)&&(i=this.patch(s,u),(e||t!==i)&&o.push(i));return o},n.prototype.diffuse=function(t,n,r){var e,i,o,s,u,h,a,c,l,p,f,d,y,g;if(null==r&&(r=null),null==this[0]._diffuseNext)for(h=0,l=this.length;l>h;h++)u=this[h],u._diffuseNext=0;for(a=0,p=this.length;p>a;a++)for(u=this[a],e=u[t]*n,i=e/8,s=u.n.length,u._diffuseNext+=u[t]-e+(8-s)*i,g=u.n,c=0,f=g.length;f>c;c++)o=g[c],o._diffuseNext+=i;for(y=0,d=this.length;d>y;y++)u=this[y],u[t]=u._diffuseNext,u._diffuseNext=0,r&&u.scaleColor(r,u[t]);return null},n}(ABM.AgentSet),ABM.Agent=function(){function t(){this.breed="default",this.x=this.y=0,this.color=u.randomColor(),this.heading=u.randomFloat(2*Math.PI),this.size=1,this.shape=ABM.agents.defaultShape,this.p=ABM.patches.patch(this.x,this.y),this.penDown=!1,this.penSize=ABM.patches.bits2Patches(1)}return t.prototype.scaleColor=function(t,n){return this.color=u.scaleColor(t,n)},t.prototype.toString=function(){return"{id:"+this.id+" xy:"+u.aToFixed([this.x,this.y])+" c:"+this.color+" h: "+this.heading.toFixed(2)+"}"},t.prototype.setXY=function(t,n){var r,e,i,o,s;return this.penDown&&(o=[this.x,this.y],e=o[0],i=o[1]),s=ABM.patches.coord(t,n),this.x=s[0],this.y=s[1],this.p=ABM.patches.patch(this.x,this.y),this.penDown?(r=ABM.drawing,r.strokeStyle=u.colorStr(this.color),r.lineWidth=this.penSize,r.beginPath(),r.moveTo(e,i),r.lineTo(t,n),r.stroke()):void 0},t.prototype.moveTo=function(t){return this.setXY(t.x,t.y)},t.prototype.forward=function(t){return this.setXY(this.x+t*Math.cos(this.heading),this.y+t*Math.sin(this.heading))},t.prototype.rotate=function(t){return this.heading=u.wrap(this.heading+t,0,2*Math.PI)},t.prototype.draw=function(t){var n;return n=ABM.shapes[this.shape],t.save(),t.fillStyle=u.colorStr(this.color),t.translate(this.x,this.y),t.scale(this.size,this.size),n.rotate&&t.rotate(this.heading),t.beginPath(),n.draw(t),t.closePath(),t.fill(),t.restore()},t.prototype.stamp=function(){return this.draw(ABM.drawing)},t.prototype.distanceXY=function(t,n){return ABM.patches.isTorus?u.torusDistance(this.x,this.y,t,n,ABM.patches.numX,ABM.patches.numY):u.distance(this.x,this.y,t,n)},t.prototype.distance=function(t){return this.distanceXY(t.x,t.y)},t.prototype.torusPtXY=function(t,n){return u.torusPt(this.x,this.y,t,n,ABM.patches.numX,ABM.patches.numY)},t.prototype.torusPt=function(t){return this.torusPtXY(t.x,t.y)},t.prototype.face=function(t){return this.heading=this.towards(t)},t.prototype.towardsXY=function(t,n){return ABM.patches.isTorus?u.torusRadsToward(this.x,this.y,t,n,ABM.patches.numX,ABM.patches.numY):u.radsToward(this.x,this.y,t,n)},t.prototype.towards=function(t){return this.towardsXY(t.x,t.y)},t.prototype.patchRect=function(t,n,r){return null==r&&(r=!1),ABM.patches.patchRect(this.p,t,n,r)},t.prototype.inCone=function(t,n,r,e){return null==e&&(e=!1),t.inCone(this.p,this.heading,n,r,e=!1)},t.prototype.die=function(){var t,n,r,e,i;for(ABM.agents.remove(this),e=this.links(),i=[],n=0,r=e.length;r>n;n++)t=e[n],i.push(t.die());return i},t.prototype.copy=function(t){var n,r,e;e=[];for(n in this)__hasProp.call(this,n)&&(r=this[n],"id"!==n&&e.push(t[n]=r));return e},t.prototype.hatch=function(t,n){var r=this;return null==t&&(t=1),null==n&&(n=function(){}),ABM.agents.create(t,function(t){return r.copy(t),n(t),t})},t.prototype.links=function(){var t,n,r,e,i;for(e=ABM.links,i=[],n=0,r=e.length;r>n;n++)t=e[n],(t.end1===this||t.end2===this)&&i.push(t);return i},t.prototype.otherEnd=function(t){return t.end1===this?t.end2:t.end1},t.prototype.linkNeighbors=function(){var t;return ABM.agents.asSet(function(){var n,r,e,i;for(e=this.links(),i=[],n=0,r=e.length;r>n;n++)t=e[n],i.push(this.otherEnd(t));return i}.call(this))},t}(),ABM.Agents=function(t){function n(){n.__super__.constructor.call(this),this.defaultShape="default"}return __extends(n,t),n.prototype.setDefaultShape=function(t){this.defaultShape=t},n.prototype.create=function(t,n){var r,e,i;for(null==n&&(n=function(){}),i=[],r=e=1;t>=e;r=e+=1)i.push(function(t){return n(t),t}(this.add(new ABM.Agent)));return i},n.prototype.clear=function(){var t;for(t=[];this.any();)t.push(this.last().die());return t},n.prototype.breed=function(t){return this.asSet(this.getWithProp("breed",t))},n}(ABM.AgentSet),ABM.Link=function(){function t(t,n){this.end1=t,this.end2=n,this.breed="default",this.color=[130,130,130],this.thickness=ABM.patches.bits2Patches(2)}return t.prototype.draw=function(t){return t.save(),t.strokeStyle=u.colorStr(this.color),t.lineWidth=this.thickness,t.beginPath(),ABM.patches.isTorus?(pt=this.end1.torusPt(this.end2),t.moveTo(this.end1.x,this.end1.y),t.lineTo.apply(t,pt),(pt[0]!==this.end2.x||pt[1]!==this.end2.y)&&(pt=this.end2.torusPt(this.end1),t.moveTo(this.end2.x,this.end2.y),t.lineTo.apply(t,pt))):(t.moveTo(this.end1.x,this.end1.y),t.lineTo(this.end2.x,this.end2.y)),t.closePath(),t.stroke(),t.restore()},t.prototype.die=function(){return ABM.links.remove(this)},t.prototype.bothEnds=function(){return ABM.links.asSet([this.end1,this.end2])},t.prototype.length=function(){return this.end1.distance(this.end2)},t.prototype.otherEnd=function(t){return this.end1===t?this.end2:this.end1},t}(),ABM.Links=function(t){function n(){n.__super__.constructor.call(this)}return __extends(n,t),n.prototype.create=function(t,n,r){var e,i,o,s;for(null==r&&(r=function(){}),null==n.length&&(n=[n]),s=[],i=0,o=n.length;o>i;i++)e=n[i],s.push(function(t){return r(t),t}(this.add(new ABM.Link(t,e))));return s},n.prototype.clear=function(){var t;for(t=[];this.any();)t.push(this.last().die());return t},n.prototype.breed=function(t){return this.getWithProp("breed",t)},n.prototype.allEnds=function(){var t,n,r,e;for(n=this.asSet([]),r=0,e=this.length;e>r;r++)t=this[r],n.push.apply(n,t.bothEnds());return n},n.prototype.nodes=function(){return this.allEnds().sortById().uniq()},n.prototype.layoutCircle=function(t,n,r,e){var i,o,s,u,h,a;for(null==r&&(r=Math.PI/2),null==e&&(e=-1),o=2*Math.PI/t.length,a=[],s=u=0,h=t.length;h>u;s=++u)i=t[s],i.setXY(0,0),i.heading=r+e*o*s,a.push(i.forward(n));return a},n}(ABM.AgentSet),u=ABM.util,ABM.Model=function(){function t(t,n,r,e,i,o,s,h){var a,c,l,p,f,d,y,g;for(null==s&&(s=!0),null==h&&(h=[10,10]),this.animate=__bind(this.animate,this),ABM.model=this,this.patches=ABM.patches=new ABM.Patches(n,r,e,i,o,s),this.agents=ABM.agents=new ABM.Agents,this.links=ABM.links=new ABM.Links,p=function(){var n,r;for(r=[],c=n=0;3>=n;c=++n)r.push(u.createLayer.apply(u,[t].concat(__slice.call(h),[this.patches.bitWidth()],[this.patches.bitHeight()],[c],["2d"])));return r}.call(this),this.drawing=ABM.drawing=p[1],d=0,y=p.length;y>d;d++)a=p[d],a.save(),a.scale(this.patches.size,-this.patches.size),a.translate(-(this.patches.minX-.5),-(this.patches.maxY+.5));this.contexts={patches:p[0],drawing:p[1],agents:p[2],links:p[3]},g=this.contexts;for(l in g)f=g[l],f.agentSetName=l;this.showFPS=!0,this.ticks=1,this.refreshLinks=this.refreshAgents=this.refreshPatches=!0,this.setup()}return t.prototype.agentSetName=function(t){return t.constructor.name.toLowerCase()},t.prototype.setTextParams=function(t,n,r,e){return null==r&&(r="center"),null==e&&(e="middle"),"string"!=typeof t&&(t=this.agentSetName(t)),u.canvasTextParams(this.contexts[t],n,r,e)},t.prototype.setLabelParams=function(t,n,r){return"string"!=typeof t&&(t=this.agentSetName(t)),u.canvasLabelParams(this.contexts[t],n,r)},t.prototype.setup=function(){},t.prototype.step=function(){},t.prototype.start=function(){return this.startMS=Date.now(),this.startTick=this.ticks,this.animStop=!1,this.animate()},t.prototype.stop=function(){return this.animStop=!0},t.prototype.animate=function(){return this.step(),this.draw(),this.tick(),this.animStop?void 0:requestAnimFrame(this.animate)},t.prototype.tick=function(){var t,n;return t=this.ticks-this.startTick,this.showFPS&&0===t%100&&0!==t&&(n=Math.round(1e3*t/(Date.now()-this.startMS)),console.log("fps: "+n+" at "+t+" ticks")),this.ticks++},t.prototype.linkBreeds=function(t){var n,r,e,i,o;for(i=t.split(" "),o=[],r=0,e=i.length;e>r;r++)n=i[r],o.push(this[n]=function(t){return function(){return this.links.breed(t)}}(n));return o},t.prototype.agentBreeds=function(t){var n,r,e,i,o;for(i=t.split(" "),o=[],r=0,e=i.length;e>r;r++)n=i[r],o.push(this[n]=function(t){return function(){return this.agents.breed(t)}}(n));return o},t.prototype.draw=function(){return(this.refreshPatches||1===this.ticks)&&this.patches.draw(this.contexts.patches),(this.refreshLinks||1===this.ticks)&&this.links.draw(this.contexts.links),this.refreshAgents||1===this.ticks?this.agents.draw(this.contexts.agents):void 0},t.prototype.asSet=function(t){return ABM.AgentSet.asSet(t)},t.prototype.setRootVars=function(){return ABM.root.ps=this.patches,ABM.root.as=this.agents,ABM.root.ls=this.links,ABM.root.dr=this.drawing,ABM.root.u=ABM.util,ABM.root.app=this,ABM.root.cx=this.contexts,ABM.root.cl=function(t){return console.log(t)},ABM.root.cla=function(t){var n,r,e,i;for(i=[],r=0,e=t.length;e>r;r++)n=t[r],i.push(log(n));return i},null},t}()}).call(this);