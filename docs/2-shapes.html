<!DOCTYPE html>  <html> <head>   <title>2-shapes.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="1-util.html">                 1-util.coffee               </a>                                           <a class="source" href="2-shapes.html">                 2-shapes.coffee               </a>                                           <a class="source" href="3-agentset.html">                 3-agentset.coffee               </a>                                           <a class="source" href="4-agentsets.html">                 4-agentsets.coffee               </a>                                           <a class="source" href="5-model.html">                 5-model.coffee               </a>                                           <a class="source" href="6-template.html">                 6-template.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               2-shapes.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>A <em>very</em> simple shapes module for drawing
<a href="http://ccl.northwestern.edu/netlogo/docs/">NetLogo-like</a> agents.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">ABM.shapes = ABM.util.s = </span><span class="nx">do</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Each shape is a named object with two members: 
a boolean "rotate" and a drawing procedure.
The shape is used in the following context with a color set
and a transform such that the shape should be drawn in a -.5 to .5 square</p>

<pre><code>ctx.save()
ctx.fillStyle = u.colorStr @color
ctx.translate @x, @y; ctx.scale @size, @size;
ctx.rotate @heading if shape.rotate
ctx.beginPath()
shape.draw(ctx)
ctx.closePath()
ctx.fill()
ctx.restore()
</code></pre>

<p>The list of current shapes, via <code>ABM.shapes.names()</code> below, is:</p>

<pre><code>["default", "triangle", "arrow", "bug", "pyramid", 
 "circle", "square", "pentagon", "ring", "cup", "person"]
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>A simple polygon utility:  c is the 2D context, and a is an array of 2D points.
c.closePath() and c.fill() will be called by the calling agent, see initial 
discription of drawing context.  It is used in adding a new shape above.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">poly = </span><span class="nf">(c, a) -&gt;</span>
    <span class="k">for</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">a</span> 
      <span class="k">if</span> <span class="nx">i</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">c</span><span class="p">.</span><span class="nx">moveTo</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="nx">c</span><span class="p">.</span><span class="nx">lineTo</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Centered drawing primitives: centered on x,y with a given width/height size.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">circ = </span><span class="nf">(c,x,y,s)-&gt;</span><span class="nx">c</span><span class="p">.</span><span class="nx">arc</span> <span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">,</span><span class="nx">s</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="c1"># centered circle</span>
  <span class="nv">ccirc = </span><span class="nf">(c,x,y,s)-&gt;</span><span class="nx">c</span><span class="p">.</span><span class="nx">arc</span> <span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">,</span><span class="nx">s</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">,</span><span class="kc">true</span> <span class="c1"># centered counter clockwise circle</span>
  <span class="nv">cimg = </span><span class="nf">(c,x,y,s,img)-&gt;</span><span class="nx">c</span><span class="p">.</span><span class="nx">scale</span> <span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="nx">c</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">img</span><span class="p">,</span><span class="nx">x</span><span class="o">-</span><span class="nx">s</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="nx">y</span><span class="o">-</span><span class="nx">s</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="nx">s</span><span class="p">,</span><span class="nx">s</span><span class="p">;</span><span class="nx">c</span><span class="p">.</span><span class="nx">scale</span> <span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span> <span class="c1"># centered image</span>
  <span class="nv">csq = </span><span class="nf">(c,x,y,s)-&gt;</span><span class="nx">c</span><span class="p">.</span><span class="nx">fillRect</span> <span class="nx">x</span><span class="o">-</span><span class="nx">s</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">y</span><span class="o">-</span><span class="nx">s</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">s</span> <span class="c1"># centered square</span>
  </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>An async util for delayed drawing of images into sprite slots</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">fillSlot = </span><span class="nf">(slot, img) -&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;fillSlot </span><span class="si">#{</span><span class="nx">slot</span><span class="p">.</span><span class="nx">x</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">slot</span><span class="p">.</span><span class="nx">y</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="nx">img</span> <span class="c1"># nifty to see the delayed response!</span>
    <span class="nx">slot</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span> <span class="nx">slot</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">scale</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
    <span class="nx">slot</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">img</span><span class="p">,</span> <span class="nx">slot</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nx">slot</span><span class="p">.</span><span class="nx">y</span><span class="o">+</span><span class="nx">slot</span><span class="p">.</span><span class="nx">size</span><span class="p">),</span> <span class="nx">slot</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="nx">slot</span><span class="p">.</span><span class="nx">size</span>    
    <span class="nx">slot</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>The spritesheet data, indexed by size</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">spriteSheets = </span><span class="p">[]</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Return our module:</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">default:</span>
    <span class="nv">rotate: </span><span class="kc">true</span>
    <span class="nv">draw: </span><span class="nf">(c) -&gt;</span> <span class="nx">poly</span> <span class="nx">c</span><span class="p">,</span> <span class="p">[[.</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="o">-</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span><span class="o">-</span><span class="p">.</span><span class="mi">5</span><span class="p">],[</span><span class="o">-</span><span class="p">.</span><span class="mi">25</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="o">-</span><span class="p">.</span><span class="mi">5</span><span class="p">,.</span><span class="mi">5</span><span class="p">]]</span>
  <span class="nv">triangle:</span>
    <span class="nv">rotate: </span><span class="kc">true</span>
    <span class="nv">draw: </span><span class="nf">(c) -&gt;</span> <span class="nx">poly</span> <span class="nx">c</span><span class="p">,</span> <span class="p">[[.</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="o">-</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span><span class="o">-</span><span class="p">.</span><span class="mi">4</span><span class="p">],[</span><span class="o">-</span><span class="p">.</span><span class="mi">5</span><span class="p">,.</span><span class="mi">4</span><span class="p">]]</span>
  <span class="nv">arrow:</span>
    <span class="nv">rotate: </span><span class="kc">true</span>
    <span class="nv">draw: </span><span class="nf">(c) -&gt;</span> <span class="nx">poly</span> <span class="nx">c</span><span class="p">,</span> <span class="p">[[.</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,.</span><span class="mi">5</span><span class="p">],[</span><span class="mi">0</span><span class="p">,.</span><span class="mi">2</span><span class="p">],[</span><span class="o">-</span><span class="p">.</span><span class="mi">5</span><span class="p">,.</span><span class="mi">2</span><span class="p">],[</span><span class="o">-</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span><span class="o">-</span><span class="p">.</span><span class="mi">2</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="p">.</span><span class="mi">2</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="p">.</span><span class="mi">5</span><span class="p">]]</span>
  <span class="nv">bug:</span>
    <span class="nv">rotate: </span><span class="kc">true</span>
    <span class="nv">draw: </span><span class="nf">(c) -&gt;</span>
      <span class="nv">c.strokeStyle = </span><span class="nx">c</span><span class="p">.</span><span class="nx">fillStyle</span><span class="p">;</span> <span class="nv">c.lineWidth = </span><span class="p">.</span><span class="mi">05</span>
      <span class="nx">poly</span> <span class="nx">c</span><span class="p">,</span> <span class="p">[[.</span><span class="mi">4</span><span class="p">,.</span><span class="mi">225</span><span class="p">],[.</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">],[.</span><span class="mi">4</span><span class="p">,</span><span class="o">-</span><span class="p">.</span><span class="mi">225</span><span class="p">]];</span> <span class="nx">c</span><span class="p">.</span><span class="nx">stroke</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>c.beginPath(); circ c,.12,0,.13; circ c,-.05,0,.13; circ c,-.27,0,.2</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">c</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span> <span class="nx">circ</span> <span class="nx">c</span><span class="p">,.</span><span class="mi">12</span><span class="p">,</span><span class="mi">0</span><span class="p">,.</span><span class="mi">26</span><span class="p">;</span> <span class="nx">circ</span> <span class="nx">c</span><span class="p">,</span><span class="o">-</span><span class="p">.</span><span class="mi">05</span><span class="p">,</span><span class="mi">0</span><span class="p">,.</span><span class="mi">26</span><span class="p">;</span> <span class="nx">circ</span> <span class="nx">c</span><span class="p">,</span><span class="o">-</span><span class="p">.</span><span class="mi">27</span><span class="p">,</span><span class="mi">0</span><span class="p">,.</span><span class="mi">4</span>
  <span class="nv">pyramid:</span>
    <span class="nv">rotate: </span><span class="kc">false</span>
    <span class="nv">draw: </span><span class="nf">(c) -&gt;</span> <span class="nx">poly</span> <span class="nx">c</span><span class="p">,</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,.</span><span class="mi">5</span><span class="p">],[</span><span class="o">-</span><span class="p">.</span><span class="mi">433</span><span class="p">,</span><span class="o">-</span><span class="p">.</span><span class="mi">25</span><span class="p">],[.</span><span class="mi">433</span><span class="p">,</span><span class="o">-</span><span class="p">.</span><span class="mi">25</span><span class="p">]]</span>
  <span class="nv">circle:</span>
    <span class="nv">shortcut: </span><span class="nf">(c,x,y,s) -&gt;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span> <span class="nx">circ</span> <span class="nx">c</span><span class="p">,</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">,</span><span class="nx">s</span><span class="p">;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">closePath</span><span class="p">();</span> <span class="nx">c</span><span class="p">.</span><span class="nx">fill</span><span class="p">()</span>
    <span class="nv">rotate: </span><span class="kc">false</span>
    <span class="nv">draw: </span><span class="nf">(c) -&gt;</span> <span class="nx">circ</span> <span class="nx">c</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span> <span class="c1"># c.arc 0,0,.5,0,2*Math.PI</span>
  <span class="nv">square:</span>
    <span class="nv">shortcut: </span><span class="nf">(c,x,y,s) -&gt;</span> <span class="nx">csq</span> <span class="nx">c</span><span class="p">,</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">,</span><span class="nx">s</span>
    <span class="nv">rotate: </span><span class="kc">false</span>
    <span class="nv">draw: </span><span class="nf">(c) -&gt;</span> <span class="nx">csq</span> <span class="nx">c</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span> <span class="c1">#c.fillRect -.5,-.5,1,1</span>
  <span class="nv">pentagon:</span>
    <span class="nv">rotate: </span><span class="kc">false</span>
    <span class="nv">draw: </span><span class="nf">(c) -&gt;</span> <span class="nx">poly</span> <span class="nx">c</span><span class="p">,</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,.</span><span class="mi">45</span><span class="p">],[</span><span class="o">-</span><span class="p">.</span><span class="mi">45</span><span class="p">,.</span><span class="mi">1</span><span class="p">],[</span><span class="o">-</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="p">.</span><span class="mi">45</span><span class="p">],[.</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="p">.</span><span class="mi">45</span><span class="p">],[.</span><span class="mi">45</span><span class="p">,.</span><span class="mi">1</span><span class="p">]]</span>
  <span class="nv">ring:</span>
    <span class="nv">rotate: </span><span class="kc">false</span>
    <span class="nv">draw: </span><span class="nf">(c) -&gt;</span> <span class="nx">circ</span> <span class="nx">c</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">closePath</span><span class="p">();</span> <span class="nx">ccirc</span> <span class="nx">c</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,.</span><span class="mi">6</span>
  <span class="nv">cup: </span><span class="c1"># an image shape, using coffeescript logo</span>
    <span class="nv">shortcut: </span><span class="nf">(c,x,y,s) -&gt;</span> <span class="nx">cimg</span> <span class="nx">c</span><span class="p">,</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">,</span><span class="nx">s</span><span class="p">,</span><span class="nx">@img</span>
    <span class="nv">rotate: </span><span class="kc">false</span>
    <span class="nv">img: </span><span class="nx">u</span><span class="p">.</span><span class="nx">importImage</span> <span class="s">&quot;http://goo.gl/HrBBb&quot;</span>
    <span class="nv">draw: </span><span class="nf">(c) -&gt;</span> <span class="nx">cimg</span> <span class="nx">c</span><span class="p">,.</span><span class="mi">5</span><span class="p">,.</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nx">@img</span>
  <span class="nv">person:</span>
    <span class="nv">rotate: </span><span class="kc">false</span>
    <span class="nv">draw: </span><span class="nf">(c) -&gt;</span>
      <span class="nx">poly</span> <span class="nx">c</span><span class="p">,</span> <span class="p">[</span>  <span class="p">[.</span><span class="mi">15</span><span class="p">,.</span><span class="mi">2</span><span class="p">],[.</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">],[.</span><span class="mi">125</span><span class="p">,</span><span class="o">-</span><span class="p">.</span><span class="mi">1</span><span class="p">],[.</span><span class="mi">125</span><span class="p">,.</span><span class="mi">05</span><span class="p">],</span>
      <span class="p">[.</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="p">.</span><span class="mi">15</span><span class="p">],[.</span><span class="mi">25</span><span class="p">,</span><span class="o">-</span><span class="p">.</span><span class="mi">5</span><span class="p">],[.</span><span class="mi">05</span><span class="p">,</span><span class="o">-</span><span class="p">.</span><span class="mi">5</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="p">.</span><span class="mi">25</span><span class="p">],</span>
      <span class="p">[</span><span class="o">-</span><span class="p">.</span><span class="mi">05</span><span class="p">,</span><span class="o">-</span><span class="p">.</span><span class="mi">5</span><span class="p">],[</span><span class="o">-</span><span class="p">.</span><span class="mi">25</span><span class="p">,</span><span class="o">-</span><span class="p">.</span><span class="mi">5</span><span class="p">],[</span><span class="o">-</span><span class="p">.</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="p">.</span><span class="mi">15</span><span class="p">],[</span><span class="o">-</span><span class="p">.</span><span class="mi">125</span><span class="p">,.</span><span class="mi">05</span><span class="p">],</span>
      <span class="p">[</span><span class="o">-</span><span class="p">.</span><span class="mi">125</span><span class="p">,</span><span class="o">-</span><span class="p">.</span><span class="mi">1</span><span class="p">],[</span><span class="o">-</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="o">-</span><span class="p">.</span><span class="mi">15</span><span class="p">,.</span><span class="mi">2</span><span class="p">]</span>  <span class="p">]</span>
      <span class="nx">c</span><span class="p">.</span><span class="nx">closePath</span><span class="p">();</span> <span class="nx">circ</span> <span class="nx">c</span><span class="p">,</span><span class="mi">0</span><span class="p">,.</span><span class="mi">35</span><span class="p">,.</span><span class="mi">30</span> </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Return a list of the available shapes, see above.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">names: </span><span class="o">-&gt;</span>
    <span class="p">(</span><span class="nx">name</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">val</span> <span class="k">of</span> <span class="nx">@</span> <span class="k">when</span> <span class="nx">val</span><span class="p">.</span><span class="nx">rotate</span><span class="o">?</span> <span class="o">and</span> <span class="nx">val</span><span class="p">.</span><span class="nx">draw</span><span class="o">?</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Add your own shape. Will be included in names list.  Usage:</p>

<pre><code>ABM.shapes.add "test", true, (c) -&gt; # bowtie/hourglass
  ABM.shapes.poly c, [[-.5,-.5],[.5,.5],[-.5,.5],[.5,-.5]]
</code></pre>

<p>Note: an image that is not rotated automatically gets a shortcut. </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">add: </span><span class="nf">(name, rotate, draw, shortcut = null) -&gt;</span>
    <span class="nv">s = </span><span class="nx">@</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span>
      <span class="k">if</span> <span class="nx">u</span><span class="p">.</span><span class="nx">isFunction</span> <span class="nx">draw</span> <span class="k">then</span> <span class="p">{</span><span class="nx">rotate</span><span class="p">,</span><span class="nx">draw</span><span class="p">}</span> <span class="k">else</span> <span class="p">{</span><span class="nx">rotate</span><span class="p">,</span><span class="nx">img</span><span class="o">:</span><span class="nx">draw</span><span class="p">,</span><span class="nx">draw</span><span class="o">:</span><span class="nf">(c)-&gt;</span><span class="nx">cimg</span> <span class="nx">c</span><span class="p">,.</span><span class="mi">5</span><span class="p">,.</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="nx">@img</span><span class="p">}</span>
    <span class="p">(</span><span class="nv">s.shortcut = </span><span class="nf">(c,x,y,s) -&gt;</span> <span class="nx">cimg</span> <span class="nx">c</span><span class="p">,</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">,</span><span class="nx">s</span><span class="p">,</span><span class="nx">@img</span><span class="p">)</span> <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">img</span><span class="o">?</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">s</span><span class="p">.</span><span class="nx">rotate</span>
    <span class="nv">s.shortcut = </span><span class="nx">shortcut</span> <span class="k">if</span> <span class="nx">shortcut</span><span class="o">?</span> <span class="c1"># can override img default shortcut if needed</span>
  <span class="nx">poly</span><span class="o">:</span><span class="nx">poly</span><span class="p">,</span> <span class="nx">circ</span><span class="o">:</span><span class="nx">circ</span><span class="p">,</span> <span class="nx">ccirc</span><span class="o">:</span><span class="nx">ccirc</span><span class="p">,</span> <span class="nx">cimg</span><span class="o">:</span><span class="nx">cimg</span><span class="p">,</span> <span class="nx">csq</span><span class="o">:</span><span class="nx">csq</span> <span class="c1"># export utils for use by add</span>
  <span class="nx">spriteSheets</span><span class="o">:</span><span class="nx">spriteSheets</span> <span class="c1"># export spriteSheets for debugging, showing in DOM</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Two draw procedures, one for shapes, the other for sprites made from shapes.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">draw: </span><span class="nf">(ctx, shape, x, y, size, rad, color) -&gt;</span>
    <span class="k">if</span> <span class="nx">shape</span><span class="p">.</span><span class="nx">shortcut</span><span class="o">?</span>
      <span class="nv">ctx.fillStyle = </span><span class="nx">u</span><span class="p">.</span><span class="nx">colorStr</span> <span class="nx">color</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">shape</span><span class="p">.</span><span class="nx">img</span><span class="o">?</span>
      <span class="nx">shape</span><span class="p">.</span><span class="nx">shortcut</span> <span class="nx">ctx</span><span class="p">,</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">,</span><span class="nx">size</span>
    <span class="k">else</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">translate</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">scale</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">size</span> <span class="k">if</span> <span class="nx">size</span> <span class="o">isnt</span> <span class="mi">1</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">rotate</span> <span class="nx">rad</span> <span class="k">if</span> <span class="nx">rad</span> <span class="o">isnt</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="nx">shape</span><span class="p">.</span><span class="nx">img</span><span class="o">?</span> <span class="c1"># is an image, not a path function</span>
        <span class="nx">shape</span><span class="p">.</span><span class="nx">draw</span> <span class="nx">ctx</span>
      <span class="k">else</span>
        <span class="nv">ctx.fillStyle = </span><span class="nx">u</span><span class="p">.</span><span class="nx">colorStr</span> <span class="nx">color</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span> <span class="nx">shape</span><span class="p">.</span><span class="nx">draw</span> <span class="nx">ctx</span><span class="p">;</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">closePath</span><span class="p">()</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">fill</span><span class="p">()</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">()</span>
    <span class="nx">shape</span>
  <span class="nv">drawSprite: </span><span class="nf">(ctx, s, x, y, size, rad) -&gt;</span>
    <span class="k">if</span> <span class="nx">rad</span> <span class="o">is</span> <span class="mi">0</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">canvas</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="nx">x</span><span class="o">-</span><span class="nx">size</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">y</span><span class="o">-</span><span class="nx">size</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">size</span>
    <span class="k">else</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">translate</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span> <span class="c1"># see http://goo.gl/VUlhY for drawing centered rotated images</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">rotate</span> <span class="nx">rad</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">canvas</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="o">-</span><span class="nx">size</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="nx">size</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">size</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">()</span>
    <span class="nx">s</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Convert a shape to a sprite by allocating a sprite "slot" and drawing the shape to fit it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">shapeToSprite: </span><span class="nf">(name, color, size) -&gt;</span>
    <span class="nv">size = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span> <span class="nx">size</span>
    <span class="nv">shape = </span><span class="nx">@</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span>
    <span class="nv">ctx = </span><span class="nx">spriteSheets</span><span class="p">[</span><span class="nx">size</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Create sheet for this size if it does not yet exist</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="nx">ctx</span><span class="o">?</span>
      <span class="nx">spriteSheets</span><span class="p">[</span><span class="nx">size</span><span class="p">]</span> <span class="o">=</span> <span class="nv">ctx = </span><span class="nx">u</span><span class="p">.</span><span class="nx">createCtx</span> <span class="nx">size</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span> <span class="nx">size</span>
      <span class="nv">ctx.nextX = </span><span class="mi">0</span><span class="p">;</span> <span class="nv">ctx.nextY = </span><span class="mi">0</span><span class="p">;</span> <span class="nv">ctx.images = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Extend the sheet if we're out of space</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">size</span><span class="o">*</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">nextX</span> <span class="o">is</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span>
      <span class="nx">u</span><span class="p">.</span><span class="nx">resizeCtx</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="o">+</span><span class="nx">size</span>
      <span class="nv">ctx.nextX = </span><span class="mi">0</span><span class="p">;</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">nextY</span><span class="o">++</span>
    <span class="nv">x = </span><span class="nx">size</span><span class="o">*</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">nextX</span><span class="p">;</span> <span class="nv">y = </span><span class="nx">size</span><span class="o">*</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">nextY</span>
    <span class="nv">slot = </span><span class="p">{</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">color</span><span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">img</span><span class="o">=</span><span class="nx">shape</span><span class="p">.</span><span class="nx">img</span><span class="p">)</span><span class="o">?</span> <span class="c1"># is an image, not a path function</span>
      <span class="k">return</span> <span class="nx">imgslot</span> <span class="k">if</span> <span class="p">(</span><span class="nv">imgslot = </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">images</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span><span class="o">?</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">images</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">slot</span>
      <span class="nv">img.onload = </span><span class="o">-&gt;</span> <span class="nx">fillSlot</span><span class="p">(</span><span class="nx">slot</span><span class="p">,</span> <span class="nx">img</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">scale</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">size</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">translate</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">nextX</span><span class="o">+</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">nextY</span><span class="o">+</span><span class="p">.</span><span class="mi">5</span>
      <span class="nv">ctx.fillStyle = </span><span class="nx">u</span><span class="p">.</span><span class="nx">colorStr</span> <span class="nx">color</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span> <span class="nx">shape</span><span class="p">.</span><span class="nx">draw</span> <span class="nx">ctx</span><span class="p">;</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">closePath</span><span class="p">()</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">fill</span><span class="p">()</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">()</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">nextX</span><span class="o">++</span><span class="p">;</span> <span class="nx">slot</span>

    

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 