<!DOCTYPE html>  <html> <head>   <title>model.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="agentset.html">                 agentset.coffee               </a>                                           <a class="source" href="agentsets.html">                 agentsets.coffee               </a>                                           <a class="source" href="model.html">                 model.coffee               </a>                                           <a class="source" href="shapes.html">                 shapes.coffee               </a>                                           <a class="source" href="util.html">                 util.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               model.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Class Model is the control center for our AgentSets: Patches, Agents and Links.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>The usual alias for <strong>ABM.util</strong>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">u = </span><span class="nx">ABM</span><span class="p">.</span><span class="nx">util</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h3>Class Model</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">Model</span>
  <span class="nv">constructor: </span><span class="nf">(div, pSize, pMinX, pMaxX, pMinY, pMaxY, isTorus=true) -&gt;</span>
    <span class="nv">ABM.model = </span><span class="nx">@</span>
    <span class="vi">@patches = </span><span class="nv">ABM.patches = </span><span class="k">new</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">Patches</span> <span class="nx">pSize</span><span class="p">,</span> <span class="nx">pMinX</span><span class="p">,</span> <span class="nx">pMaxX</span><span class="p">,</span> <span class="nx">pMinY</span><span class="p">,</span> <span class="nx">pMaxY</span><span class="p">,</span> <span class="nx">isTorus</span>
    <span class="vi">@agents = </span><span class="nv">ABM.agents = </span><span class="k">new</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">Agents</span>
    <span class="vi">@links = </span><span class="nv">ABM.links = </span><span class="k">new</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">Links</span>
    <span class="vi">@debug = </span><span class="kc">true</span> <span class="c1"># mainly fps in console</span>
    <span class="vi">@ticks = </span><span class="mi">1</span>
    <span class="vi">@refreshLinks = @refreshAgents = @refreshPatches = </span><span class="kc">true</span>
    <span class="vi">@layers = </span><span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># multi-line array comprehension</span>
      <span class="nx">u</span><span class="p">.</span><span class="nx">createLayer</span> <span class="nx">div</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">@patches</span><span class="p">.</span><span class="nx">bitWidth</span><span class="p">(),</span> <span class="nx">@patches</span><span class="p">.</span><span class="nx">bitHeight</span><span class="p">(),</span> <span class="nx">i</span><span class="p">,</span> <span class="s">&quot;2d&quot;</span>
    <span class="k">for</span> <span class="nx">ctx</span> <span class="k">in</span> <span class="nx">@layers</span> <span class="c1"># install permenant (no ctx.restore) patch coordinates</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">scale</span> <span class="nx">@patches</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="o">-</span><span class="nx">@patches</span><span class="p">.</span><span class="nx">size</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">translate</span> <span class="o">-</span><span class="p">(</span><span class="nx">@patches</span><span class="p">.</span><span class="nx">minX</span><span class="o">-</span><span class="p">.</span><span class="mi">5</span><span class="p">),</span> <span class="o">-</span><span class="p">(</span><span class="nx">@patches</span><span class="p">.</span><span class="nx">maxY</span><span class="o">+</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span> 
    <span class="vi">@drawing = </span><span class="nv">ABM.drawing = </span><span class="nx">@layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="vi">@contexts = </span><span class="c1"># remind: make layers local?</span>
      <span class="nv">patches: </span><span class="nx">@layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nv">drawing: </span><span class="nx">@layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="nv">agents: </span><span class="nx">@layers</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
      <span class="nv">links: </span><span class="nx">@layers</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="nv">v.agentSetName = </span><span class="nx">k</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span><span class="nx">v</span> <span class="k">of</span> <span class="nx">@contexts</span>
    <span class="nx">@setup</span><span class="p">()</span>

  <span class="nv">agentSetName: </span><span class="nf">(aset) -&gt;</span>
    <span class="k">if</span> <span class="nx">aset</span> <span class="o">is</span> <span class="nx">@patches</span> <span class="k">then</span> <span class="k">return</span> <span class="s">&quot;patches&quot;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">aset</span> <span class="o">is</span> <span class="nx">@agents</span> <span class="k">then</span> <span class="k">return</span> <span class="s">&quot;agents&quot;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">aset</span> <span class="o">is</span> <span class="nx">@links</span> <span class="k">then</span> <span class="k">return</span> <span class="s">&quot;links&quot;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">aset</span> <span class="o">is</span> <span class="nx">@drawing</span> <span class="k">then</span> <span class="k">return</span> <span class="s">&quot;drawing&quot;</span>
    <span class="kc">null</span> <span class="c1"># Catch errors, return null</span>
    
  <span class="nv">setTextParams: </span><span class="nf">(agentSetName, domFont, align=&quot;center&quot;, baseline=&quot;middle&quot;) -&gt;</span>
    <span class="nv">agentSetName = </span><span class="nx">@agentSetName</span><span class="p">(</span><span class="nx">agentSetName</span><span class="p">)</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">agentSetName</span> <span class="o">isnt</span> <span class="s">&quot;string&quot;</span>
    <span class="nx">u</span><span class="p">.</span><span class="nx">canvasTextParams</span> <span class="nx">@contexts</span><span class="p">[</span><span class="nx">agentSetName</span><span class="p">],</span> <span class="nx">domFont</span><span class="p">,</span> <span class="nx">align</span><span class="p">,</span> <span class="nx">baseline</span>
  <span class="nv">setLabelParams: </span><span class="nf">(agentSetName, color, xy) -&gt;</span>
    <span class="nv">agentSetName = </span><span class="nx">@agentSetName</span><span class="p">(</span><span class="nx">agentSetName</span><span class="p">)</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">agentSetName</span> <span class="o">isnt</span> <span class="s">&quot;string&quot;</span>
    <span class="nx">u</span><span class="p">.</span><span class="nx">canvasLabelParams</span> <span class="nx">@contexts</span><span class="p">[</span><span class="nx">agentSetName</span><span class="p">],</span> <span class="nx">color</span><span class="p">,</span> <span class="nx">xy</span>
    
  <span class="nv">setup: </span><span class="o">-&gt;</span>
  <span class="nv">step: </span><span class="o">-&gt;</span>
    
  <span class="nv">start: </span><span class="o">-&gt;</span>
    <span class="vi">@startMS = </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
    <span class="vi">@startTick = </span><span class="nx">@ticks</span>
    <span class="vi">@animStop = </span><span class="kc">false</span>
    <span class="nx">@animate</span><span class="p">()</span>
  <span class="nv">stop: </span><span class="o">-&gt;</span> <span class="vi">@animStop = </span><span class="kc">true</span>
  <span class="nv">animate: </span><span class="o">=&gt;</span> <span class="c1"># note fat arrow, animate bound to &quot;this&quot;</span>
    <span class="nx">@step</span><span class="p">()</span>
    <span class="nx">@draw</span><span class="p">()</span>
    <span class="nx">@tick</span><span class="p">()</span> <span class="c1"># Note: NL difference, called here not in user&#39;s step()</span>
    <span class="nx">requestAnimFrame</span> <span class="nx">@animate</span> <span class="nx">unless</span> <span class="nx">@animStop</span>
  <span class="nv">tick: </span><span class="o">-&gt;</span>
    <span class="nv">animTicks = </span><span class="nx">@ticks</span><span class="o">-</span><span class="nx">@startTick</span>
    <span class="k">if</span> <span class="nx">@debug</span> <span class="o">and</span> <span class="p">(</span><span class="nx">animTicks</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="o">is</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">animTicks</span> <span class="o">isnt</span> <span class="mi">0</span>
      <span class="nv">fps = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span> <span class="p">(</span><span class="nx">animTicks</span><span class="o">*</span><span class="mi">1000</span><span class="o">/</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="o">-</span><span class="nx">@startMS</span><span class="p">))</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">animTicks</span><span class="si">}</span><span class="s">: </span><span class="si">#{</span><span class="nx">fps</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nx">@ticks</span><span class="o">++</span>

  <span class="nv">linkBreeds: </span><span class="nf">(s) -&gt;</span>
    <span class="k">for</span> <span class="nx">b</span> <span class="k">in</span> <span class="nx">s</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)</span>
      <span class="nx">@</span><span class="p">[</span><span class="nx">b</span><span class="p">]</span> <span class="o">=</span> <span class="nx">do</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">=&gt;</span>
       <span class="o">-&gt;</span> <span class="nx">@links</span><span class="p">.</span><span class="nx">breed</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
  <span class="nv">agentBreeds: </span><span class="nf">(s) -&gt;</span>
    <span class="k">for</span> <span class="nx">b</span> <span class="k">in</span> <span class="nx">s</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)</span>
      <span class="nx">@</span><span class="p">[</span><span class="nx">b</span><span class="p">]</span> <span class="o">=</span> <span class="nx">do</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">=&gt;</span>
       <span class="o">-&gt;</span> <span class="nx">@agents</span><span class="p">.</span><span class="nx">breed</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>setDefaultBreedShape: (breed, shape) ->
  @[breed].defaultShape = shape</p>             </td>             <td class="code">               <div class="highlight"><pre>    
  <span class="nv">draw: </span><span class="o">-&gt;</span>
    <span class="nx">@patches</span><span class="p">.</span><span class="nx">draw</span> <span class="nx">@layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nx">@refreshPatches</span> <span class="o">or</span> <span class="nx">@ticks</span> <span class="o">is</span> <span class="mi">1</span>
    <span class="nx">@links</span><span class="p">.</span><span class="nx">draw</span> <span class="nx">@layers</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>   <span class="k">if</span> <span class="nx">@refreshLinks</span> <span class="o">or</span> <span class="nx">@ticks</span> <span class="o">is</span> <span class="mi">1</span>
    <span class="nx">@agents</span><span class="p">.</span><span class="nx">draw</span> <span class="nx">@layers</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="k">if</span> <span class="nx">@refreshAgents</span> <span class="o">or</span> <span class="nx">@ticks</span> <span class="o">is</span> <span class="mi">1</span>
  
  <span class="nv">setRootVars: </span><span class="o">-&gt;</span> <span class="c1"># for debugging, avoid std names, confuses existing code</span>
    <span class="nv">ABM.root.ps = </span><span class="nx">@patches</span>
    <span class="nv">ABM.root.as = </span><span class="nx">@agents</span>
    <span class="nv">ABM.root.ls = </span><span class="nx">@links</span>
    <span class="nv">ABM.root.dr = </span><span class="nx">@drawing</span>
    <span class="nv">ABM.root.u = </span><span class="nx">ABM</span><span class="p">.</span><span class="nx">util</span>
    <span class="nv">ABM.root.app = </span><span class="nx">@</span>
    <span class="nv">ABM.root.co = </span><span class="nx">@contexts</span> <span class="c1">#ctx object/hash</span>
    <span class="nv">ABM.root.ca = </span><span class="nx">@layers</span>   <span class="c1"># ctx array</span>
  </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>observer:</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">asSet: </span><span class="nf">(a) -&gt;</span> <span class="c1"># turns an array into an agent set</span>
    <span class="nx">ABM</span><span class="p">.</span><span class="nx">AgentSet</span><span class="p">.</span><span class="nx">asSet</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 