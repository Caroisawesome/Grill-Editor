<!DOCTYPE html>  <html> <head>   <title>model.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="agentset.html">                 agentset.coffee               </a>                                           <a class="source" href="agentsets.html">                 agentsets.coffee               </a>                                           <a class="source" href="model.html">                 model.coffee               </a>                                           <a class="source" href="shapes.html">                 shapes.coffee               </a>                                           <a class="source" href="template.html">                 template.coffee               </a>                                           <a class="source" href="util.html">                 util.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               model.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Class Model is the control center for our AgentSets: Patches, Agents and Links.
Creating new models is done by subclassing class Model and overriding two 
virtual/abstract methods: <code>setup()</code> and <code>step()</code></p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>The usual alias for <strong>ABM.util</strong>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">u = </span><span class="nx">ABM</span><span class="p">.</span><span class="nx">util</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Because not all models have the same amimator requirements, we build a class
for customization by the programmer.  See these URLs for more info:</p>

<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/JavaScript/Timers">JavaScript timers doc</a></li>
<li><a href="http://goo.gl/ymEEX">Using timers &amp; requestAnimFrame together</a></li>
<li><a href="http://goo.gl/9Q3q">John Resig on timers</a></li>
<li><a href="http://jsfiddle.net/calpo/H7EEE/">jsFiddle setTimeout vs rAF</a></li>
<li><a href="http://javascript.info/tutorial/settimeout-setinterval">Timeout tutorial</a></li>
<li><a href="http://javascript.info/tutorial/events-and-timing-depth">Events and timing in depth</a></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">Animator</span>
  <span class="nv">constructor: </span><span class="nf">(@model, @rate=30, @multiStep=false) -&gt;</span> <span class="c1"># rate/multiStep arbitrary hint to animate()</span>
    <span class="vi">@ticks = @draws = </span><span class="mi">0</span>
    <span class="vi">@animHandle = @timerHandle = @intervalHandle = </span><span class="kc">null</span>
    <span class="vi">@animStop = </span><span class="kc">true</span>
  <span class="nv">setRate: </span><span class="nf">(@rate, @multiStep=false) -&gt;</span> <span class="nx">@reset</span><span class="p">()</span>
  <span class="nv">start: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">@animStop</span> <span class="k">then</span> <span class="k">return</span> <span class="c1"># avoid multiple animates</span>
    <span class="nx">@reset</span><span class="p">()</span>
    <span class="vi">@animStop = </span><span class="kc">false</span>
    <span class="nx">@animate</span><span class="p">()</span>
  <span class="nv">reset: </span><span class="o">-&gt;</span>
    <span class="vi">@startMS = </span><span class="nx">@now</span><span class="p">()</span>
    <span class="vi">@startTick = </span><span class="nx">@ticks</span>
    <span class="vi">@startDraw = </span><span class="nx">@draws</span>
  <span class="nv">stop: </span><span class="o">-&gt;</span>
    <span class="vi">@animStop = </span><span class="kc">true</span>
    <span class="k">if</span> <span class="nx">@animHandle</span><span class="o">?</span> <span class="k">then</span> <span class="nx">cancelAnimFrame</span> <span class="nx">@animHandle</span>
    <span class="k">if</span> <span class="nx">@timeoutHandle</span><span class="o">?</span> <span class="k">then</span> <span class="nx">clearTimeout</span> <span class="nx">@timeoutHandle</span>
    <span class="k">if</span> <span class="nx">@intervalHandle</span><span class="o">?</span> <span class="k">then</span> <span class="nx">clearInterval</span> <span class="nx">@intervalHandle</span>
    <span class="vi">@animHandle = @timerHandle = @intervalHandle = </span><span class="kc">null</span>
  <span class="nv">step: </span><span class="o">-&gt;</span> <span class="nx">@ticks</span><span class="o">++</span><span class="p">;</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">step</span><span class="p">()</span>
  <span class="nv">draw: </span><span class="o">-&gt;</span> <span class="nx">@draws</span><span class="o">++</span><span class="p">;</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">draw</span><span class="p">()</span>
  <span class="nv">now: </span><span class="o">-&gt;</span> <span class="p">(</span><span class="nx">performance</span> <span class="o">?</span> <span class="nb">Date</span><span class="p">).</span><span class="nx">now</span><span class="p">()</span>
  <span class="nv">ms: </span><span class="o">-&gt;</span> <span class="nx">@now</span><span class="p">()</span><span class="o">-</span><span class="nx">@startMS</span>
  <span class="nv">ticksPerSec: </span><span class="o">-&gt;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">elapsed = </span><span class="nx">@ticks</span><span class="o">-</span><span class="nx">@startTick</span><span class="p">)</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span> <span class="nx">elapsed</span><span class="o">*</span><span class="mi">1000</span><span class="o">/</span><span class="nx">@ms</span><span class="p">()</span>
  <span class="nv">drawsPerSec: </span><span class="o">-&gt;</span> <span class="k">if</span> <span class="p">(</span><span class="nv">elapsed = </span><span class="nx">@draws</span><span class="o">-</span><span class="nx">@startDraw</span><span class="p">)</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span> <span class="nx">elapsed</span><span class="o">*</span><span class="mi">1000</span><span class="o">/</span><span class="nx">@ms</span><span class="p">()</span>
  <span class="nv">toString: </span><span class="o">-&gt;</span> <span class="s">&quot;ticks: </span><span class="si">#{</span><span class="nx">@ticks</span><span class="si">}</span><span class="s">, draws: </span><span class="si">#{</span><span class="nx">@draws</span><span class="si">}</span><span class="s">, rate: </span><span class="si">#{</span><span class="nx">@rate</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">@ticksPerSec</span><span class="p">()</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">@drawsPerSec</span><span class="p">()</span><span class="si">}</span><span class="s">&quot;</span>
  <span class="nv">animateSteps: </span><span class="o">=&gt;</span>
    <span class="nx">@step</span><span class="p">()</span>
    <span class="vi">@timeoutHandle = </span><span class="nx">setTimeout</span> <span class="nx">@animateSteps</span><span class="p">,</span> <span class="mi">10</span> <span class="nx">unless</span> <span class="nx">@animStop</span>
  <span class="nv">animateDraws: </span><span class="o">=&gt;</span>
    <span class="k">if</span> <span class="nx">@drawsPerSec</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="nx">@rate</span>
      <span class="nx">@step</span><span class="p">()</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@multiStep</span>
      <span class="nx">@draw</span><span class="p">()</span>
    <span class="vi">@animHandle = </span><span class="nx">requestAnimFrame</span> <span class="nx">@animateDraws</span> <span class="nx">unless</span> <span class="nx">@animStop</span>
  <span class="nv">animate: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@multiStep</span>
      <span class="nx">@animateSteps</span><span class="p">()</span>
    <span class="nx">@animateDraws</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h3>Class Model</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">Model</span>  </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Constructor: </p>

<ul>
<li>create agentsets, install them and ourselves in ABM global namespace</li>
<li>create layers/contexts, install drawing layer in ABM global namespace</li>
<li>setup patch coord transforms for each layer context</li>
<li>intialize various instance variables</li>
<li>call <code>setup</code> abstract method</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(</span>
<span class="nf">    div, size, minX, maxX, minY, maxY,</span>
<span class="nf">    torus=true, neighbors=true</span>
<span class="nf">  ) -&gt;</span>
    <span class="nv">ABM.model = </span><span class="nx">@</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Create 5 2D canvas contexts layered on top of each other.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">layers = </span><span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">4</span><span class="p">]</span> <span class="c1"># multi-line array comprehension</span>
      <span class="nx">u</span><span class="p">.</span><span class="nx">createLayer</span> <span class="nx">div</span><span class="p">,</span> <span class="nx">size</span><span class="o">*</span><span class="p">(</span><span class="nx">maxX</span><span class="o">-</span><span class="nx">minX</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="nx">size</span><span class="o">*</span><span class="p">(</span><span class="nx">maxY</span><span class="o">-</span><span class="nx">minY</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="nx">i</span><span class="p">,</span> <span class="s">&quot;2d&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>One of the layers is used for drawing only, not an agentset:</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@drawing = </span><span class="nv">ABM.drawing = </span><span class="nx">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Initialize a patch coord transform for each layer.<br>
Note: this is permanent .. there is no ctx.restore() call.<br>
To use the original canvas 2D transform temporarily:</p>

<pre><code>ctx.save()
ctx.setTransform(1, 0, 0, 1, 0, 0) # reset to identity
  &lt;draw in native coord system&gt;
ctx.restore() # restore back to patch coord system
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">ctx</span> <span class="k">in</span> <span class="nx">layers</span> <span class="c1"># install permenant (no ctx.restore) patch coordinates</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">scale</span> <span class="nx">size</span><span class="p">,</span> <span class="o">-</span><span class="nx">size</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">translate</span> <span class="o">-</span><span class="p">(</span><span class="nx">minX</span><span class="o">-</span><span class="p">.</span><span class="mi">5</span><span class="p">),</span> <span class="o">-</span><span class="p">(</span><span class="nx">maxY</span><span class="o">+</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span> </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Create instance variable object with names for each layer</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@contexts = </span><span class="nv">ABM.contexts =</span>
      <span class="nv">patches: </span>  <span class="nx">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nv">drawing: </span>  <span class="nx">layers</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="nv">links: </span>    <span class="nx">layers</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
      <span class="nv">agents: </span>   <span class="nx">layers</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
      <span class="nv">spotlight: </span><span class="nx">layers</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Set a variable in each context with its name</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">v.agentSetName = </span><span class="nx">k</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span><span class="nx">v</span> <span class="k">of</span> <span class="nx">@contexts</span>
    </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Initialize agentsets.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@patches = </span><span class="nv">ABM.patches = </span><span class="o">\</span>
      <span class="k">new</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">Patches</span> <span class="nx">size</span><span class="p">,</span><span class="nx">minX</span><span class="p">,</span><span class="nx">maxX</span><span class="p">,</span><span class="nx">minY</span><span class="p">,</span><span class="nx">maxY</span><span class="p">,</span><span class="nx">torus</span><span class="p">,</span><span class="nx">neighbors</span>
    <span class="vi">@agents = </span><span class="nv">ABM.agents = </span><span class="k">new</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">Agents</span>
    <span class="vi">@links = </span><span class="nv">ABM.links = </span><span class="k">new</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">Links</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Setup spotlight layer</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@contexts.spotlight.globalCompositeOperation = </span><span class="s">&quot;xor&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Initialize instance variables</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@anim = </span><span class="k">new</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">Animator</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span>
    <span class="vi">@refreshLinks = @refreshAgents = @refreshPatches = </span><span class="kc">true</span> <span class="c1"># drawing flags</span>
    <span class="vi">@fastPatches = </span><span class="kc">false</span>
    </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Call the models setup function.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@setup</span><span class="p">()</span>
    </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Postprocesssing after setup</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@agents</span><span class="p">.</span><span class="nx">useSprites</span>
      <span class="nx">@agents</span><span class="p">.</span><span class="nx">setDefaultSprite</span><span class="p">()</span> <span class="k">if</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">Agent</span><span class="o">::</span><span class="nx">color</span><span class="o">?</span>
      <span class="k">for</span> <span class="nx">a</span> <span class="k">in</span> <span class="nx">@agents</span> <span class="k">when</span> <span class="o">not</span> <span class="nx">a</span><span class="p">.</span><span class="nx">hasOwnProperty</span> <span class="s">&quot;sprite&quot;</span>
        <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">hasOwnProperty</span> <span class="s">&quot;color&quot;</span> <span class="o">or</span> <span class="nx">a</span><span class="p">.</span><span class="nx">hasOwnProperty</span> <span class="s">&quot;shape&quot;</span> <span class="o">or</span> <span class="nx">a</span><span class="p">.</span><span class="nx">hasOwnProperty</span> <span class="s">&quot;size&quot;</span>
          <span class="nv">a.sprite = </span><span class="nx">ABM</span><span class="p">.</span><span class="nx">shapes</span><span class="p">.</span><span class="nx">shapeToCtx</span> <span class="nx">a</span><span class="p">.</span><span class="nx">shape</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">size</span><span class="o">*</span><span class="nx">@patches</span><span class="p">.</span><span class="nx">size</span>
    </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h3>Optimizations:</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Modelers "tune" their model by adjusting flags:</p>

<pre><code> @refreshLinks = @refreshAgents = @refreshPatches
</code></pre>

<p>and by the following methods:</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Draw patches using scaled image of colors. Note anti-aliasing may occur
if browser does not support imageSmoothingEnabled or equivalent.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setFastPatches: </span><span class="o">-&gt;</span>
    <span class="nv">ctx = </span><span class="nx">@contexts</span><span class="p">.</span><span class="nx">patches</span>
    <span class="nv">ctx.imageSmoothingEnabled = </span><span class="kc">false</span>
    <span class="nv">ctx.mozImageSmoothingEnabled = </span><span class="kc">false</span>
    <span class="nv">ctx.webkitImageSmoothingEnabled = </span><span class="kc">false</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span> <span class="c1"># revert to native 2D transform</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">setTransform</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="vi">@patches.drawWithPixels = </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Have agents use images (sprites) rather than drawing for agents.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setAgentsUseSprites: </span><span class="o">-&gt;</span>
    <span class="nx">@agents</span><span class="p">.</span><span class="nx">setUseSprites</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
    </pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Have patches cache the agents currently on them.
Optimizes Patch p.agentsHere method</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setCacheAgentsHere: </span><span class="o">-&gt;</span>
    <span class="nv">p.agents = </span><span class="p">[]</span> <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">@patches</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nx">agents</span><span class="p">.</span><span class="nx">push</span> <span class="nx">a</span> <span class="k">for</span> <span class="nx">a</span> <span class="k">in</span> <span class="nx">@agents</span>
  </pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Have agents cache the links with them as a node.
Optimizes Agent a.myLinks method</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setCacheMyLinks: </span><span class="o">-&gt;</span>
    <span class="vi">@links.cacheAgentLinks = </span><span class="kc">true</span>
    <span class="nv">a.links = </span><span class="p">[]</span> <span class="k">for</span> <span class="nx">a</span> <span class="k">in</span> <span class="nx">@agents</span> <span class="c1"># not needed if called b4 any agents &amp; links made</span>
    <span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">end1</span><span class="p">.</span><span class="nx">links</span><span class="p">.</span><span class="nx">push</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">l</span><span class="p">.</span><span class="nx">end2</span><span class="p">.</span><span class="nx">links</span><span class="p">.</span><span class="nx">push</span> <span class="nx">l</span><span class="p">)</span> <span class="k">for</span> <span class="nx">l</span> <span class="k">in</span> <span class="nx">@links</span>
  </pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Have patches cache the given patchRect.
Optimizes patchRect, inRadius and inCone</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setCachePatchRects: </span><span class="nf">(radius, meToo=false) -&gt;</span>
    <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">@patches</span>
      <span class="nv">p.pRect = </span><span class="nx">@patches</span><span class="p">.</span><span class="nx">patchRect</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">radius</span><span class="p">,</span> <span class="nx">radius</span><span class="p">,</span> <span class="nx">meToo</span>
      <span class="nv">p.pRect.radius = </span><span class="nx">radius</span>
      <span class="nv">p.pRect.meToo = </span><span class="nx">meToo</span>
  </pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Ask agents to cache their color strings.
This is a temporary optimization and will likely change.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setAgentStaticColors: </span><span class="o">-&gt;</span>
    <span class="nx">@agents</span><span class="p">.</span><span class="nx">setStaticColors</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <h3>Text Utilities:</h3>

<p>Return string name for agentset.  Note this depends on our
using a singleton naming convension: foo = new Foo(...)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">agentSetName: </span><span class="nf">(aset) -&gt;</span> <span class="nx">aset</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Set the text parameters for an agentset's context.  See ABM.util</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setTextParams: </span><span class="nf">(agentSetName, domFont, align=&quot;center&quot;, baseline=&quot;middle&quot;) -&gt;</span>
    <span class="nv">agentSetName = </span><span class="nx">@agentSetName</span><span class="p">(</span><span class="nx">agentSetName</span><span class="p">)</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">agentSetName</span> <span class="o">isnt</span> <span class="s">&quot;string&quot;</span>
    <span class="nx">u</span><span class="p">.</span><span class="nx">ctxTextParams</span> <span class="nx">@contexts</span><span class="p">[</span><span class="nx">agentSetName</span><span class="p">],</span> <span class="nx">domFont</span><span class="p">,</span> <span class="nx">align</span><span class="p">,</span> <span class="nx">baseline</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Set the label parameters for an agentset's context.  See ABM.util</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setLabelParams: </span><span class="nf">(agentSetName, color, xy) -&gt;</span>
    <span class="nv">agentSetName = </span><span class="nx">@agentSetName</span><span class="p">(</span><span class="nx">agentSetName</span><span class="p">)</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">agentSetName</span> <span class="o">isnt</span> <span class="s">&quot;string&quot;</span>
    <span class="nx">u</span><span class="p">.</span><span class="nx">ctxLabelParams</span> <span class="nx">@contexts</span><span class="p">[</span><span class="nx">agentSetName</span><span class="p">],</span> <span class="nx">color</span><span class="p">,</span> <span class="nx">xy</span>
  </pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <h3>User Model Creation</h3>

<p>A user's model is made by subclassing Model and over-riding these
two abstract methods. <code>super</code> need not be called.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Initialize your model here</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setup: </span><span class="o">-&gt;</span> <span class="c1"># called at the end of model creation</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Update/step your model here</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">step: </span><span class="o">-&gt;</span> <span class="c1"># called each step of the animation</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Start/stop the animation</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">start: </span><span class="o">-&gt;</span> <span class="nx">@anim</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>
  <span class="nv">stop: </span><span class="o">-&gt;</span> <span class="nx">@anim</span><span class="p">.</span><span class="nx">stop</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <h3>Animation.</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Call the agentset draw methods if either the first draw call or
their "refresh" flags are set.  The latter are simple optimizations
to avoid redrawing the same static scene. Called by animator.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">draw: </span><span class="o">-&gt;</span>
    <span class="nx">@patches</span><span class="p">.</span><span class="nx">draw</span> <span class="nx">@contexts</span><span class="p">.</span><span class="nx">patches</span>  <span class="k">if</span> <span class="nx">@refreshPatches</span> <span class="o">or</span> <span class="nx">@anim</span><span class="p">.</span><span class="nx">draws</span> <span class="o">is</span> <span class="mi">1</span>
    <span class="nx">@links</span><span class="p">.</span><span class="nx">draw</span>   <span class="nx">@contexts</span><span class="p">.</span><span class="nx">links</span>    <span class="k">if</span> <span class="nx">@refreshLinks</span>   <span class="o">or</span> <span class="nx">@anim</span><span class="p">.</span><span class="nx">draws</span> <span class="o">is</span> <span class="mi">1</span>
    <span class="nx">@agents</span><span class="p">.</span><span class="nx">draw</span>  <span class="nx">@contexts</span><span class="p">.</span><span class="nx">agents</span>   <span class="k">if</span> <span class="nx">@refreshAgents</span>  <span class="o">or</span> <span class="nx">@anim</span><span class="p">.</span><span class="nx">draws</span> <span class="o">is</span> <span class="mi">1</span>
    <span class="nx">@drawSpotlight</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@spotlightAgent</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Creates a spotlight effect on an agent, so we can follow it throughout the model
We can pass in either an agent to be spotlighted or a breed. If we pass in a breed,
we will find a random agent of that breed</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setSpotlight: </span><span class="nf">(agent) -&gt;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">agent</span> <span class="o">is</span> <span class="s">&quot;string&quot;</span>
      <span class="nv">agentSet = </span><span class="nx">@</span><span class="p">[</span><span class="nx">agent</span><span class="p">]()</span>
      <span class="vi">@spotlightAgent = </span><span class="nx">agentSet</span><span class="p">.</span><span class="nx">oneOf</span><span class="p">()</span> <span class="nx">unless</span> <span class="o">not</span> <span class="nx">agentSet</span><span class="p">.</span><span class="nx">any</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="vi">@spotlightAgent = </span><span class="nx">agent</span>

  <span class="nv">removeSpotlight: </span><span class="o">-&gt;</span>
    <span class="vi">@spotlightAgent = </span><span class="kc">null</span>
    <span class="nx">u</span><span class="p">.</span><span class="nx">clearCtx</span> <span class="nx">@contexts</span><span class="p">.</span><span class="nx">spotlight</span>

  <span class="nv">drawSpotlight: </span><span class="o">-&gt;</span>
    <span class="nv">agent   = </span><span class="nx">@spotlightAgent</span>
    <span class="nv">ctx     = </span><span class="nx">@contexts</span><span class="p">.</span><span class="nx">spotlight</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">agent</span><span class="o">?</span> <span class="c1"># race condition?</span>
    <span class="k">if</span> <span class="nx">@agents</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">agent</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="c1"># Reset if agent.die() called</span>
      <span class="nx">@removeSpotlight</span><span class="p">()</span>
      <span class="k">return</span>
    <span class="nx">u</span><span class="p">.</span><span class="nx">clearCtx</span> <span class="nx">ctx</span>
    <span class="nx">u</span><span class="p">.</span><span class="nx">fillCtx</span> <span class="nx">ctx</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.6</span><span class="p">]</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">()</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">arc</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">agent</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">,</span> <span class="kc">false</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fill</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <h3>Breeds</h3>

<p>Two very primitive versions of NL's <code>breed</code> commands.</p>

<pre><code>@agentBreeds "embers fires"
@linkBreeds "spokes rims"
</code></pre>

<p>will create 4 dynamic methods: </p>

<pre><code>@embers() and @fires()
</code></pre>

<p>which return agents with their breeds set to "embers" or "fires", and</p>

<pre><code>@spokes() and @rims() 
</code></pre>

<p>which return links with their breed set to either "spokes" or "rims"</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">linkBreeds: </span><span class="nf">(s) -&gt;</span>
    <span class="k">for</span> <span class="nx">b</span> <span class="k">in</span> <span class="nx">s</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)</span>
      <span class="nx">@</span><span class="p">[</span><span class="nx">b</span><span class="p">]</span> <span class="o">=</span> <span class="nx">do</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">=&gt;</span>
       <span class="o">-&gt;</span> <span class="nx">@links</span><span class="p">.</span><span class="nx">breed</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
    <span class="kc">null</span>
  <span class="nv">agentBreeds: </span><span class="nf">(s) -&gt;</span>
    <span class="k">for</span> <span class="nx">b</span> <span class="k">in</span> <span class="nx">s</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)</span>
      <span class="nx">@</span><span class="p">[</span><span class="nx">b</span><span class="p">]</span> <span class="o">=</span> <span class="nx">do</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">=&gt;</span>
       <span class="o">-&gt;</span> <span class="nx">@agents</span><span class="p">.</span><span class="nx">breed</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
    <span class="kc">null</span>

  </pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Utility for models to create agentsets from arrays.  Ex:</p>

<pre><code>even = @asSet (a for a in @agents when a.id % 2 is 0)
even.shuffle().getProp("id") # [6, 0, 4, 2, 8]
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">asSet: </span><span class="nf">(a) -&gt;</span> <span class="c1"># turns an array into an agent set</span>
    <span class="nx">ABM</span><span class="p">.</span><span class="nx">AgentSet</span><span class="p">.</span><span class="nx">asSet</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>A simple debug aid which places short names in the global name space.
Note we avoid using the actual name, such as "patches" because this
can cause our modules to mistakenly depend on a global name.
See <a href="http://goo.gl/1i7bd">CoffeeConsole</a> Chrome extension too.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setRootVars: </span><span class="o">-&gt;</span>
    <span class="nv">ABM.root.ps = </span><span class="nx">@patches</span>
    <span class="nv">ABM.root.p0 = </span><span class="nx">@patches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nv">ABM.root.as = </span><span class="nx">@agents</span>
    <span class="nv">ABM.root.a0 = </span><span class="nx">@agents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nv">ABM.root.ls = </span><span class="nx">@links</span>
    <span class="nv">ABM.root.l0 = </span><span class="nx">@links</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nv">ABM.root.dr = </span><span class="nx">@drawing</span>
    <span class="nv">ABM.root.u = </span><span class="nx">ABM</span><span class="p">.</span><span class="nx">util</span>
    <span class="nv">ABM.root.app = </span><span class="nx">@</span>
    <span class="nv">ABM.root.cx = </span><span class="nx">@contexts</span>
    <span class="nv">ABM.root.cl = </span><span class="nf">(o) -&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">o</span>
    <span class="nv">ABM.root.cla = </span><span class="nf">(array) -&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">a</span> <span class="k">for</span> <span class="nx">a</span> <span class="k">in</span> <span class="nx">array</span>
    <span class="kc">null</span>
  

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 