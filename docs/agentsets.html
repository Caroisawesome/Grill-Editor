<!DOCTYPE html>  <html> <head>   <title>agentsets.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="agentset.html">                 agentset.coffee               </a>                                           <a class="source" href="agentsets.html">                 agentsets.coffee               </a>                                           <a class="source" href="model.html">                 model.coffee               </a>                                           <a class="source" href="shapes.html">                 shapes.coffee               </a>                                           <a class="source" href="template.html">                 template.coffee               </a>                                           <a class="source" href="util.html">                 util.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               agentsets.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>There are three agentsets and their corresponding 
agents: Patches/Patch, Agents/Agent, and Links/Link.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>The usual alias for <strong>ABM.util</strong>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">u = </span><span class="nx">ABM</span><span class="p">.</span><span class="nx">util</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h3>Patch and Patches</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Class Patch instances represent a rectangle on a grid with::</p>

<ul>
<li>id: installed by Patches agentset</li>
<li>x,y: the x,y position within the grid</li>
<li>color: the color of the patch as an RGBA array, A optional.</li>
<li>label: text for the patch</li>
<li>n/n4: adjacent neighbors: n: 8 patches, n4: N,E,S,W patches.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">Patch</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Class variable defaults, "promoted" to instance variables if needed
when unique per instance rather than shared.
This approach yields considerable space effeciency when appropriate.</p>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Not all patches need their neighbor patches, thus we use a default
of none.  n and n4 are promoted by the ABM.Patches agent set 
constructor if the constructor variable "neighbors" is true,
the default. This is only important in very large patch sets
and should be handled with care!</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">n: </span><span class="kc">null</span>
  <span class="nv">n4: </span><span class="kc">null</span>
  <span class="nv">cachedRects: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Default color starts as black, can be set to different default value
by setDefault methods in ABM.Patches</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">color: </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Default patch is visible but can be changed to true if
appropriate by setDefault methods</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">hidden: </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>new Patch: set x,y. Neighbors set by Patches constructor if needed.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(@x, @y) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Return a string representation of the patch.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">toString: </span><span class="o">-&gt;</span>
    <span class="s">&quot;{id:</span><span class="si">#{</span><span class="nx">@id</span><span class="si">}</span><span class="s"> xy:</span><span class="si">#{</span><span class="nx">u</span><span class="p">.</span><span class="nx">aToFixed</span> <span class="p">[</span><span class="nx">@x</span><span class="p">,</span><span class="nx">@y</span><span class="p">]</span><span class="si">}</span><span class="s"> c:</span><span class="si">#{</span><span class="nx">@color</span><span class="si">}</span><span class="s">}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Set patch color to <code>c</code> scaled by <code>s</code>. Usage:</p>

<pre><code>p.scaleColor p.color, .8 # reduce patch color by .8
p.scaleColor @foodColor, p.foodPheromone # ants model
</code></pre>

<p>Promotes color if currently using the default.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">scaleColor: </span><span class="nf">(c, s) -&gt;</span> 
    <span class="vi">@color = </span><span class="nx">u</span><span class="p">.</span><span class="nx">clone</span> <span class="nx">@color</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s">&quot;color&quot;</span><span class="p">)</span>
    <span class="nx">u</span><span class="p">.</span><span class="nx">scaleColor</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">@color</span>
  </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Draw the patch and its text label if there is one.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">draw: </span><span class="nf">(ctx) -&gt;</span>
    <span class="nv">ctx.fillStyle = </span><span class="nx">u</span><span class="p">.</span><span class="nx">colorStr</span> <span class="nx">@color</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillRect</span> <span class="nx">@x</span><span class="o">-</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="nx">@y</span><span class="o">-</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nx">@label</span><span class="o">?</span>
      <span class="p">[</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">labelXY</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">translate</span> <span class="nx">@x</span><span class="p">,</span> <span class="nx">@y</span> <span class="c1"># bug: fonts don&#39;t scale for size &lt; 1</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">scale</span> <span class="mi">1</span><span class="o">/</span><span class="nx">ABM</span><span class="p">.</span><span class="nx">patches</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="nx">ABM</span><span class="p">.</span><span class="nx">patches</span><span class="p">.</span><span class="nx">size</span>
      <span class="nx">u</span><span class="p">.</span><span class="nx">ctxDrawText</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">@label</span><span class="p">,</span> <span class="p">[</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">],</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">labelColor</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">()</span>
  </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Return an array of the agents on this patch.
See model.setCacheAgentsHere for optimization.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">agentsHere: </span><span class="o">-&gt;</span>
    <span class="nx">@agents</span> <span class="o">?</span> <span class="p">(</span><span class="nx">a</span> <span class="k">for</span> <span class="nx">a</span> <span class="k">in</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">agents</span> <span class="k">when</span> <span class="nx">a</span><span class="p">.</span><span class="nx">p</span> <span class="o">is</span> <span class="nx">@</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Returns true if this patch is on the edge of the grid.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">isOnEdge: </span><span class="o">-&gt;</span>
    <span class="nx">@x</span> <span class="o">is</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">patches</span><span class="p">.</span><span class="nx">minX</span> <span class="o">or</span> <span class="nx">@x</span> <span class="o">is</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">patches</span><span class="p">.</span><span class="nx">maxX</span> <span class="o">or</span> <span class="o">\</span>
    <span class="nx">@y</span> <span class="o">is</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">patches</span><span class="p">.</span><span class="nx">minY</span> <span class="o">or</span> <span class="nx">@y</span> <span class="o">is</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">patches</span><span class="p">.</span><span class="nx">maxY</span>
  </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Factory: Create num new agents on this patch.
The optional init proc is called on each of the newly created agents.<br>
NOTE: init must be applied after object inserted in agent set</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">sprout: </span><span class="nf">(num = 1, init = -&gt;) -&gt;</span>
    <span class="nx">ABM</span><span class="p">.</span><span class="nx">agents</span><span class="p">.</span><span class="nx">create</span> <span class="nx">num</span><span class="p">,</span> <span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="c1"># fat arrow so that @ = this patch</span>
      <span class="nx">a</span><span class="p">.</span><span class="nx">setXY</span> <span class="nx">@x</span><span class="p">,</span> <span class="nx">@y</span><span class="p">;</span> <span class="nx">init</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span> <span class="nx">a</span>
  </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Class Patches is a singleton 2D matrix of Patch instances, each patch 
representing a 1x1 square in patch coordinates (via 2D coord transforms).</p>

<ul>
<li>size: pixel h/w of each patch.</li>
<li>minX/maxX: min/max x coord, each patch being a unit square.</li>
<li>minY/maxY: min/max y coord.</li>
<li>numX/numY: total patches in x/y direction, width/height of grid.</li>
<li>isTorus: topology of patches, see <strong>ABM.util</strong>.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">Patches</span> <span class="k">extends</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">AgentSet</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Constructor: set variables, fill patch neighbor variables, n &amp; n4.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(</span>
<span class="nf">    @size, @minX, @maxX, @minY, @maxY, @isTorus=true, neighbors=true</span>
<span class="nf">  ) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@numX = </span><span class="nx">@maxX</span><span class="o">-</span><span class="nx">@minX</span><span class="o">+</span><span class="mi">1</span>
    <span class="vi">@numY = </span><span class="nx">@maxY</span><span class="o">-</span><span class="nx">@minY</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="p">[</span><span class="nx">minY</span><span class="p">..</span><span class="nx">maxY</span><span class="p">]</span> <span class="k">by</span> <span class="mi">1</span>
      <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="p">[</span><span class="nx">minX</span><span class="p">..</span><span class="nx">maxX</span><span class="p">]</span> <span class="k">by</span> <span class="mi">1</span>
        <span class="nx">@add</span> <span class="k">new</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">Patch</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span>
    <span class="nx">@setNeighbors</span><span class="p">()</span> <span class="k">if</span> <span class="nx">neighbors</span>
    <span class="nx">@setPixels</span><span class="p">()</span> 
    <span class="vi">@drawWithPixels = </span><span class="nx">@size</span> <span class="o">is</span> <span class="mi">1</span> <span class="c1">#false</span>
  </pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Install neighborhoods in patches</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setNeighbors: </span><span class="o">-&gt;</span> 
    <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">@</span>
      <span class="nv">p.n = </span> <span class="nx">@patchRect</span> <span class="nx">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="c1"># p.n =  p.patchRect 1, 1</span>
      <span class="nv">p.n4 = </span><span class="nx">@asSet</span> <span class="p">(</span><span class="nx">n</span> <span class="k">for</span> <span class="nx">n</span> <span class="k">in</span> <span class="nx">p</span><span class="p">.</span><span class="nx">n</span> <span class="k">when</span> <span class="nx">n</span><span class="p">.</span><span class="nx">x</span> <span class="o">is</span> <span class="nx">p</span><span class="p">.</span><span class="nx">x</span> <span class="o">or</span> <span class="nx">n</span><span class="p">.</span><span class="nx">y</span> <span class="o">is</span> <span class="nx">p</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Setup pixels used for <code>drawScaledPixels</code> and <code>importColors</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setPixels: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@size</span> <span class="o">is</span> <span class="mi">1</span>
      <span class="vi">@pixelsCtx = </span><span class="nx">ABM</span><span class="p">.</span><span class="nx">contexts</span><span class="p">.</span><span class="nx">patches</span>
    <span class="k">else</span>
      <span class="nv">can = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span> <span class="s">&#39;canvas&#39;</span>  <span class="c1"># small pixel grid for patch colors</span>
      <span class="nv">can.width = </span><span class="nx">@numX</span><span class="p">;</span> <span class="nv">can.height = </span><span class="nx">@numY</span>
      <span class="vi">@pixelsCtx = </span><span class="nx">can</span><span class="p">.</span><span class="nx">getContext</span> <span class="s">&quot;2d&quot;</span>
    <span class="vi">@pixelsImageData = </span><span class="nx">@pixelsCtx</span><span class="p">.</span><span class="nx">getImageData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">@numX</span><span class="p">,</span> <span class="nx">@numY</span><span class="p">)</span>
    <span class="vi">@pixelsData = </span><span class="nx">@pixelsImageData</span><span class="p">.</span><span class="nx">data</span>
    <span class="k">if</span> <span class="nx">@pixelsData</span> <span class="k">instanceof</span> <span class="nx">Uint8Array</span> <span class="c1"># Check for typed arrays</span>
      <span class="vi">@pixelsData32 = </span><span class="k">new</span> <span class="nx">Uint32Array</span> <span class="nx">@pixelsData</span><span class="p">.</span><span class="nx">buffer</span>
      <span class="vi">@pixelsAreLittleEndian = </span><span class="nx">u</span><span class="p">.</span><span class="nx">isLittleEndian</span><span class="p">()</span>
  </pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>If using scaled pixels, use pixel manipulation below, or use default.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">draw: </span><span class="nf">(ctx) -&gt;</span>
    <span class="k">if</span> <span class="nx">@drawWithPixels</span> <span class="k">then</span> <span class="nx">@drawScaledPixels</span> <span class="nx">ctx</span> <span class="k">else</span> <span class="k">super</span> <span class="nx">ctx</span>
  </pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Set the default color for new Patch instances.
Note coffeescript :: which refers to the Patch prototype.
This is the usual way to modify class variables.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setDefaultColor: </span><span class="nf">(color) -&gt;</span> <span class="nv">ABM.Patch::color = </span><span class="nx">color</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h4>Patch grid coord system utilities:</h4>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Return the patch at matrix position x,y where 
x &amp; y are both valid integer patch coordinates.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">patchXY: </span><span class="nf">(x,y) -&gt;</span> <span class="nx">@</span><span class="p">[</span><span class="nx">x</span><span class="o">-</span><span class="nx">@minX</span> <span class="o">+</span> <span class="nx">@numX</span><span class="o">*</span><span class="p">(</span><span class="nx">y</span><span class="o">-</span><span class="nx">@minY</span><span class="p">)]</span>
  </pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Return x,y float values to be between min/max patch coord values</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">clamp: </span><span class="nf">(x,y) -&gt;</span> <span class="p">[</span><span class="nx">u</span><span class="p">.</span><span class="nx">clamp</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">@minX</span><span class="o">-</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="nx">@maxX</span><span class="o">+</span><span class="p">.</span><span class="mi">5</span><span class="p">),</span> <span class="nx">u</span><span class="p">.</span><span class="nx">clamp</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span> <span class="nx">@minY</span><span class="o">-</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="nx">@maxY</span><span class="o">+</span><span class="p">.</span><span class="mi">5</span><span class="p">)]</span>
  </pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Return x,y float values to be modulo min/max patch coord values.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">wrap: </span><span class="nf">(x,y)  -&gt;</span> <span class="p">[</span><span class="nx">u</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">@minX</span><span class="o">-</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="nx">@maxX</span><span class="o">+</span><span class="p">.</span><span class="mi">5</span><span class="p">),</span>  <span class="nx">u</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span> <span class="nx">@minY</span><span class="o">-</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="nx">@maxY</span><span class="o">+</span><span class="p">.</span><span class="mi">5</span><span class="p">)]</span>
  </pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Return x,y float values to be between min/max patch values
using either clamp/wrap above according to isTorus topology.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">coord: </span><span class="nf">(x,y) -&gt;</span> <span class="c1">#returns a valid world coord (real, not int)</span>
    <span class="k">if</span> <span class="nx">@isTorus</span> <span class="k">then</span> <span class="nx">@wrap</span> <span class="nx">x</span><span class="p">,</span><span class="nx">y</span> <span class="k">else</span> <span class="nx">@clamp</span> <span class="nx">x</span><span class="p">,</span><span class="nx">y</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Return patch at x,y float values according to topology.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">patch: </span><span class="nf">(x,y) -&gt;</span> 
    <span class="p">[</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">]</span><span class="o">=</span><span class="nx">@coord</span> <span class="nx">x</span><span class="p">,</span><span class="nx">y</span>
    <span class="nv">x = </span><span class="nx">u</span><span class="p">.</span><span class="nx">clamp</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">x</span><span class="p">),</span> <span class="nx">@minX</span><span class="p">,</span> <span class="nx">@maxX</span>
    <span class="nv">y = </span><span class="nx">u</span><span class="p">.</span><span class="nx">clamp</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">y</span><span class="p">),</span> <span class="nx">@minY</span><span class="p">,</span> <span class="nx">@maxY</span>
    <span class="nx">@patchXY</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span>
  </pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Return a random valid float x,y point in patch space</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">randomPt: </span><span class="o">-&gt;</span> <span class="p">[</span><span class="nx">u</span><span class="p">.</span><span class="nx">randomFloat2</span><span class="p">(</span><span class="nx">@minX</span><span class="o">-</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span><span class="nx">@maxX</span><span class="o">+</span><span class="p">.</span><span class="mi">5</span><span class="p">),</span> <span class="nx">u</span><span class="p">.</span><span class="nx">randomFloat2</span><span class="p">(</span><span class="nx">@minY</span><span class="o">-</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span><span class="nx">@maxY</span><span class="o">+</span><span class="p">.</span><span class="mi">5</span><span class="p">)]</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <h4>Patch metrics</h4>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Return pixel width/height of patch grid</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">bitWidth: </span> <span class="o">-&gt;</span> <span class="nx">@numX</span><span class="o">*</span><span class="nx">@size</span> <span class="c1"># methods, not constants in case resize</span>
  <span class="nv">bitHeight: </span><span class="o">-&gt;</span> <span class="nx">@numY</span><span class="o">*</span><span class="nx">@size</span>
  </pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Convert patch measure to pixels</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">patches2Bits: </span><span class="nf">(p) -&gt;</span> <span class="nx">p</span><span class="o">*</span><span class="nx">@size</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Convert bit measure to patches</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">bits2Patches: </span><span class="nf">(b) -&gt;</span> <span class="nx">b</span><span class="o">/</span><span class="nx">@size</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <h4>Patch utilities</h4>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Return an array of patches in a rectangle centered on the given 
patch <code>p</code>, dx, dy units to the right/left and up/down. 
Exclude <code>p</code> unless meToo is true, default false.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">patchRect: </span><span class="nf">(p, dx, dy, meToo=false) -&gt;</span>
    <span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">pRect</span><span class="o">?</span> <span class="o">and</span> <span class="nx">p</span><span class="p">.</span><span class="nx">pRect</span><span class="p">.</span><span class="nx">radius</span> <span class="o">is</span> <span class="nx">dx</span> <span class="o">and</span> <span class="nx">p</span><span class="p">.</span><span class="nx">pRect</span><span class="p">.</span><span class="nx">radius</span> <span class="o">is</span> <span class="nx">dy</span>
      <span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nx">pRect</span>
    <span class="nv">rect = </span><span class="p">[];</span> <span class="c1"># REMIND: could optimize w/ a loop for the all inside patches case</span>
    <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="p">[</span><span class="nx">p</span><span class="p">.</span><span class="nx">y</span><span class="o">-</span><span class="nx">dy</span><span class="p">..</span><span class="nx">p</span><span class="p">.</span><span class="nx">y</span><span class="o">+</span><span class="nx">dy</span><span class="p">]</span> <span class="k">by</span> <span class="mi">1</span> <span class="c1"># by 1: perf: avoid bidir JS for loop</span>
      <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="p">[</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span><span class="o">-</span><span class="nx">dx</span><span class="p">..</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span><span class="o">+</span><span class="nx">dx</span><span class="p">]</span> <span class="k">by</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nx">@isTorus</span> <span class="o">or</span> <span class="p">(</span><span class="nx">@minX</span><span class="o">&lt;=</span><span class="nx">x</span><span class="o">&lt;=</span><span class="nx">@maxX</span> <span class="o">and</span> <span class="nx">@minY</span><span class="o">&lt;=</span><span class="nx">y</span><span class="o">&lt;=</span><span class="nx">@maxY</span><span class="p">)</span>
          <span class="k">if</span> <span class="nx">@isTorus</span>
            <span class="nx">x</span><span class="o">+=</span><span class="nx">@numX</span> <span class="k">if</span> <span class="nx">x</span><span class="o">&lt;</span><span class="nx">@minX</span><span class="p">;</span> <span class="nx">x</span><span class="o">-=</span><span class="nx">@numX</span> <span class="k">if</span> <span class="nx">x</span><span class="o">&gt;</span><span class="nx">@maxX</span>
            <span class="nx">y</span><span class="o">+=</span><span class="nx">@numY</span> <span class="k">if</span> <span class="nx">y</span><span class="o">&lt;</span><span class="nx">@minY</span><span class="p">;</span> <span class="nx">y</span><span class="o">-=</span><span class="nx">@numY</span> <span class="k">if</span> <span class="nx">y</span><span class="o">&gt;</span><span class="nx">@maxY</span>
          <span class="nv">pnext = </span><span class="nx">@patchXY</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span> <span class="c1"># much faster than coord()</span>
          <span class="k">if</span> <span class="o">not</span> <span class="nx">pnext</span><span class="o">?</span>
            <span class="nx">u</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;patchRect: x,y out of bounds, see console.log&quot;</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;  x </span><span class="si">#{</span><span class="nx">x</span><span class="si">}</span><span class="s"> y </span><span class="si">#{</span><span class="nx">y</span><span class="si">}</span><span class="s"> p.x </span><span class="si">#{</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span><span class="si">}</span><span class="s"> p.y </span><span class="si">#{</span><span class="nx">p</span><span class="p">.</span><span class="nx">y</span><span class="si">}</span><span class="s"> dx </span><span class="si">#{</span><span class="nx">dx</span><span class="si">}</span><span class="s"> dy </span><span class="si">#{</span><span class="nx">dy</span><span class="si">}</span><span class="s"> minX </span><span class="si">#{</span><span class="nx">@minX</span><span class="si">}</span><span class="s"> minY </span><span class="si">#{</span><span class="nx">@minY</span><span class="si">}</span><span class="s">&quot;</span>
          <span class="nx">rect</span><span class="p">.</span><span class="nx">push</span> <span class="nx">pnext</span> <span class="k">if</span> <span class="p">(</span><span class="nx">meToo</span> <span class="o">or</span> <span class="nx">p</span> <span class="o">isnt</span> <span class="nx">pnext</span><span class="p">)</span>
    <span class="nx">@asSet</span> <span class="nx">rect</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Draws, or "imports" an image URL into the drawing layer.
The image is scaled to fit the drawing layer.</p>

<p>This is an async load, see this
<a href="http://javascript.mfields.org/2011/creating-an-image-in-javascript/">new Image()</a>
tutorial.  We draw the image into the drawing layer as
soon as the onload callback executes.
The "fat arrow" insures the callback executes within the importDrawing context.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">importDrawing: </span><span class="nf">(imageSrc) -&gt;</span>
    <span class="nx">u</span><span class="p">.</span><span class="nx">importImage</span> <span class="nx">imageSrc</span><span class="p">,</span> <span class="nf">(img) -&gt;</span>
      <span class="nv">ctx = </span><span class="nx">ABM</span><span class="p">.</span><span class="nx">drawing</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span> <span class="c1"># revert to native 2D transform</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">setTransform</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">()</span> <span class="c1"># restore patch transform</span>
  </pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Utility function for pixel manipulation.  Given a patch, returns the 
native canvas index i into the pixel data.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">pixelIndex: </span><span class="nf">(p) -&gt;</span>
    <span class="p">(</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span><span class="o">-</span><span class="nx">@minX</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">@maxY</span><span class="o">-</span><span class="nx">p</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span><span class="o">*</span><span class="nx">@numX</span> <span class="p">)</span><span class="o">*</span><span class="mi">4</span>
    </pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Draws, or "imports" an image URL into the patches as their color property.
The drawing is scaled to the number of x,y patches, thus one pixel
per patch.  The colors are then transferred to the patches.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">importColors: </span><span class="nf">(imageSrc) -&gt;</span>
    <span class="nx">u</span><span class="p">.</span><span class="nx">importImage</span> <span class="nx">imageSrc</span><span class="p">,</span> <span class="p">(</span><span class="nx">img</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="c1"># fat arrow, this context</span>
      <span class="k">if</span> <span class="nx">img</span><span class="p">.</span><span class="nx">width</span> <span class="o">isnt</span> <span class="nx">@numX</span> <span class="o">or</span> <span class="nx">img</span><span class="p">.</span><span class="nx">height</span> <span class="o">isnt</span> <span class="nx">@numY</span>
        <span class="nx">@pixelsCtx</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">@numX</span><span class="p">,</span> <span class="nx">@numY</span>
      <span class="k">else</span>
        <span class="nx">@pixelsCtx</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
      <span class="nv">data = </span><span class="nx">@pixelsCtx</span><span class="p">.</span><span class="nx">getImageData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">@numX</span><span class="p">,</span> <span class="nx">@numY</span><span class="p">).</span><span class="nx">data</span>
      <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">@</span>
        <span class="nv">i = </span><span class="nx">@pixelIndex</span> <span class="nx">p</span>
        <span class="nv">p.color = </span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="nx">j</span><span class="p">]</span> <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">2</span><span class="p">])</span>
      <span class="kc">null</span> <span class="c1"># avoid CS return of array</span>
  </pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Draw the patches via pixel manipulation rather than 2D drawRect.
See Mozilla pixel <a href="http://goo.gl/Lxliq">manipulation article</a></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">drawScaledPixels: </span><span class="nf">(ctx) -&gt;</span> 
    <span class="k">if</span> <span class="nx">@pixelsData32</span><span class="o">?</span>
      <span class="nx">@drawScaledPixels32</span> <span class="nx">ctx</span>
    <span class="k">else</span>
      <span class="nx">@drawScaledPixels8</span> <span class="nx">ctx</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>The 8-bit version for drawScaledPixels.  Used for systems w/o typed arrays</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">drawScaledPixels8: </span><span class="nf">(ctx) -&gt;</span>
    <span class="nv">data = </span><span class="nx">@pixelsData</span>
    <span class="nx">minX</span><span class="o">=</span><span class="nx">@minX</span><span class="p">;</span> <span class="nx">numX</span><span class="o">=</span><span class="nx">@numX</span><span class="p">;</span> <span class="nx">maxY</span><span class="o">=</span><span class="nx">@maxY</span>
    <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">@</span>
      <span class="nv">i = </span><span class="p">(</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span><span class="o">-</span><span class="nx">minX</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">maxY</span><span class="o">-</span><span class="nx">p</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span><span class="o">*</span><span class="nx">numX</span> <span class="p">)</span><span class="o">*</span><span class="mi">4</span>
      <span class="nv">c = </span><span class="nx">p</span><span class="p">.</span><span class="nx">color</span>
      <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="nx">c</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">2</span><span class="p">]</span> 
      <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>
    <span class="nx">@pixelsCtx</span><span class="p">.</span><span class="nx">putImageData</span><span class="p">(</span><span class="nx">@pixelsImageData</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">@size</span> <span class="o">is</span> <span class="mi">1</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">@pixelsCtx</span><span class="p">.</span><span class="nx">canvas</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>The 32-bit version of drawScaledPixels, with both little and big endian hardware.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">drawScaledPixels32: </span><span class="nf">(ctx) -&gt;</span>
    <span class="nv">data = </span><span class="nx">@pixelsData32</span>
    <span class="nx">minX</span><span class="o">=</span><span class="nx">@minX</span><span class="p">;</span> <span class="nx">numX</span><span class="o">=</span><span class="nx">@numX</span><span class="p">;</span> <span class="nx">maxY</span><span class="o">=</span><span class="nx">@maxY</span>
    <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">@</span>
      <span class="nv">i = </span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span><span class="o">-</span><span class="nx">minX</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">maxY</span><span class="o">-</span><span class="nx">p</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span><span class="o">*</span><span class="nx">numX</span>
      <span class="nv">c = </span><span class="nx">p</span><span class="p">.</span><span class="nx">color</span>
      <span class="k">if</span> <span class="nx">@pixelsAreLittleEndian</span>
        <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> 
          <span class="p">(</span><span class="mi">255</span>  <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>  <span class="c1"># alpha</span>
          <span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>  <span class="c1"># blue</span>
          <span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>  <span class="o">|</span>  <span class="c1"># green</span>
          <span class="nx">c</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>           <span class="c1"># red</span>
      <span class="k">else</span>
        <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> 
          <span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>  <span class="c1"># red</span>
          <span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>  <span class="c1"># green</span>
          <span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>  <span class="o">|</span>  <span class="c1"># blue</span>
          <span class="mi">255</span><span class="p">;</span>            <span class="c1"># alpha</span>
    <span class="nx">@pixelsCtx</span><span class="p">.</span><span class="nx">putImageData</span><span class="p">(</span><span class="nx">@pixelsImageData</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">@size</span> <span class="o">is</span> <span class="mi">1</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">@pixelsCtx</span><span class="p">.</span><span class="nx">canvas</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span>
      </pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Diffuse the value of patch variable <code>p.v</code> by distributing <code>rate</code> percent
of each patch's value of <code>v</code> to its neighbors. If a color <code>c</code> is given,
scale the patch's color to be <code>p.v</code> of <code>c</code>. If the patch has
less than 8 neighbors, return the extra to the patch.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">diffuse: </span><span class="nf">(v, rate, c=null) -&gt;</span> <span class="c1"># variable name, diffusion rate, max color (optional)</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>zero temp variable if not yet set</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="nx">@</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">_diffuseNext</span><span class="o">?</span>
      <span class="nv">p._diffuseNext = </span><span class="mi">0</span> <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">@</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>pass 1: calculate contribution of all patches to themselves and neighbors</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">@</span>
      <span class="nv">dv = </span><span class="nx">p</span><span class="p">[</span><span class="nx">v</span><span class="p">]</span><span class="o">*</span><span class="nx">rate</span><span class="p">;</span> <span class="nv">dv8 = </span><span class="nx">dv</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span> <span class="nv">nn = </span><span class="nx">p</span><span class="p">.</span><span class="nx">n</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">p</span><span class="p">.</span><span class="nx">_diffuseNext</span> <span class="o">+=</span> <span class="nx">p</span><span class="p">[</span><span class="nx">v</span><span class="p">]</span> <span class="o">-</span> <span class="nx">dv</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span><span class="o">-</span><span class="nx">nn</span><span class="p">)</span><span class="o">*</span><span class="nx">dv8</span>
      <span class="nx">n</span><span class="p">.</span><span class="nx">_diffuseNext</span> <span class="o">+=</span> <span class="nx">dv8</span> <span class="k">for</span> <span class="nx">n</span> <span class="k">in</span> <span class="nx">p</span><span class="p">.</span><span class="nx">n</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>pass 2: set new value for all patches, zero temp, modify color if c given</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">@</span>
      <span class="nx">p</span><span class="p">[</span><span class="nx">v</span><span class="p">]</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">_diffuseNext</span>
      <span class="nv">p._diffuseNext = </span><span class="mi">0</span>
      <span class="nx">p</span><span class="p">.</span><span class="nx">scaleColor</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">p</span><span class="p">[</span><span class="nx">v</span><span class="p">]</span> <span class="k">if</span> <span class="nx">c</span>
    <span class="kc">null</span> <span class="c1"># avoid returning copy of @</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <h3>Agent &amp; Agents</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Class Agent instances represent the dynamic, behavioral element of ABM.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">Agent</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Constructor &amp; Class Variables:</p>

<ul>
<li>x,y: position on the patch grid, in patch coordinates, default: 0,0</li>
<li>color: the color of the agent, default: ABM.util.randomColor</li>
<li>shape: the ABM.shape name of the agent, default: ABM.agents.defaultShape</li>
<li>heading: direction of the agent, in radians, from x-axis</li>
<li>size: size of agent, in patch coords, default: 1</li>
<li>p: patch at current x,y location</li>
<li>penDown: true if agent pen is drawing</li>
<li>penSize: size in patch coords of the pen, default: 1 pixel</li>
<li>breed: string represented the type of agent. Ex: wolf, rabbit.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Default class variables, promoted to instances when needed</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">color: </span><span class="kc">null</span>  <span class="c1"># default color, overrides random color if set</span>
  <span class="nv">shape: </span><span class="s">&quot;default&quot;</span>
  <span class="nv">breed: </span><span class="s">&quot;default&quot;</span>
  <span class="nv">hidden: </span><span class="kc">false</span>
  <span class="nv">size: </span><span class="mi">1</span>
  <span class="nv">penDown: </span><span class="kc">false</span>
  <span class="nv">penSize: </span><span class="mi">1</span>
  <span class="nv">heading: </span><span class="kc">null</span>
  <span class="nv">sprite: </span><span class="kc">null</span>
  <span class="nv">links: </span><span class="kc">null</span>
  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="vi">@x = @y = </span><span class="mi">0</span>
    <span class="vi">@color = </span><span class="nx">u</span><span class="p">.</span><span class="nx">randomColor</span><span class="p">()</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@color</span><span class="o">?</span> <span class="c1"># promote color if default not set</span>
    <span class="vi">@heading = </span><span class="nx">u</span><span class="p">.</span><span class="nx">randomFloat</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@heading</span><span class="o">?</span> 
    <span class="vi">@p = </span><span class="nx">ABM</span><span class="p">.</span><span class="nx">patches</span><span class="p">.</span><span class="nx">patch</span> <span class="nx">@x</span><span class="p">,</span> <span class="nx">@y</span>
    <span class="nx">@p</span><span class="p">.</span><span class="nx">agents</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@</span> <span class="k">if</span> <span class="nx">@p</span><span class="p">.</span><span class="nx">agents</span><span class="o">?</span> <span class="c1"># ABM.patches.cacheAgentsHere</span>
    <span class="vi">@links = </span><span class="p">[]</span> <span class="k">if</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">links</span><span class="p">.</span><span class="nx">cacheAgentLinks</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Set agent color to <code>c</code> scaled by <code>s</code>. Usage: see patch.scaleColor</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">scaleColor: </span><span class="nf">(c, s) -&gt;</span> 
    <span class="vi">@color = </span><span class="nx">u</span><span class="p">.</span><span class="nx">clone</span> <span class="nx">@color</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s">&quot;color&quot;</span><span class="p">)</span>
    <span class="nx">u</span><span class="p">.</span><span class="nx">scaleColor</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">@color</span>
  </pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Return a string representation of the agent.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">toString: </span><span class="o">-&gt;</span>
    <span class="s">&quot;{id:</span><span class="si">#{</span><span class="nx">@id</span><span class="si">}</span><span class="s"> xy:</span><span class="si">#{</span><span class="nx">u</span><span class="p">.</span><span class="nx">aToFixed</span> <span class="p">[</span><span class="nx">@x</span><span class="p">,</span><span class="nx">@y</span><span class="p">]</span><span class="si">}</span><span class="s"> c:</span><span class="si">#{</span><span class="nx">@color</span><span class="si">}</span><span class="s"> h: </span><span class="si">#{</span><span class="nx">@heading</span><span class="p">.</span><span class="nx">toFixed</span> <span class="mi">2</span><span class="si">}</span><span class="s">}&quot;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Place the agent at the given x,y (floats) in patch coords
using patch topology (isTorus)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setXY: </span><span class="nf">(x, y) -&gt;</span> <span class="c1"># REMIND GC problem, 2 arrays</span>
    <span class="p">[</span><span class="nx">x0</span><span class="p">,</span> <span class="nx">y0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">@x</span><span class="p">,</span> <span class="nx">@y</span><span class="p">]</span> <span class="k">if</span> <span class="nx">@penDown</span>
    <span class="p">[</span><span class="nx">@x</span><span class="p">,</span> <span class="nx">@y</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">patches</span><span class="p">.</span><span class="nx">coord</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span>
    <span class="nv">p = </span><span class="nx">@p</span>
    <span class="vi">@p = </span><span class="nx">ABM</span><span class="p">.</span><span class="nx">patches</span><span class="p">.</span><span class="nx">patch</span> <span class="nx">@x</span><span class="p">,</span> <span class="nx">@y</span>
    <span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">agents</span><span class="o">?</span> <span class="o">and</span> <span class="nx">p</span> <span class="o">isnt</span> <span class="nx">@p</span> <span class="c1"># ABM.patches.cacheAgentsHere </span>
      <span class="nx">u</span><span class="p">.</span><span class="nx">removeItem</span> <span class="nx">p</span><span class="p">.</span><span class="nx">agents</span><span class="p">,</span> <span class="nx">@</span>
      <span class="nx">@p</span><span class="p">.</span><span class="nx">agents</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@</span>
    <span class="k">if</span> <span class="nx">@penDown</span>
      <span class="nv">drawing = </span><span class="nx">ABM</span><span class="p">.</span><span class="nx">drawing</span>
      <span class="nv">drawing.strokeStyle = </span><span class="nx">u</span><span class="p">.</span><span class="nx">colorStr</span> <span class="nx">@color</span>
      <span class="nv">drawing.lineWidth = </span><span class="nx">ABM</span><span class="p">.</span><span class="nx">patches</span><span class="p">.</span><span class="nx">bits2Patches</span> <span class="nx">@penSize</span>
      <span class="nx">drawing</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">()</span>
      <span class="nx">drawing</span><span class="p">.</span><span class="nx">moveTo</span> <span class="nx">x0</span><span class="p">,</span> <span class="nx">y0</span><span class="p">;</span> <span class="nx">drawing</span><span class="p">.</span><span class="nx">lineTo</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span> <span class="c1"># REMIND: euclidean</span>
      <span class="nx">drawing</span><span class="p">.</span><span class="nx">stroke</span><span class="p">()</span>
  </pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Place the agent at the given patch/agent location,
using patch topology (isTorus)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">moveTo: </span><span class="nf">(a) -&gt;</span> <span class="nx">@setXY</span> <span class="nx">a</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">y</span>
  </pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Move forward (along heading) d units (patch coords),
using patch topology (isTorus)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">forward: </span><span class="nf">(d) -&gt;</span>
    <span class="nx">@setXY</span> <span class="nx">@x</span> <span class="o">+</span> <span class="nx">d</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">@heading</span><span class="p">),</span> <span class="nx">@y</span> <span class="o">+</span> <span class="nx">d</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">@heading</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Change current heading by rad radians which can be + (left) or - (right)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">rotate: </span><span class="nf">(rad) -&gt;</span> <span class="vi">@heading = </span><span class="nx">u</span><span class="p">.</span><span class="nx">wrap</span> <span class="nx">@heading</span> <span class="o">+</span> <span class="nx">rad</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">*</span><span class="mi">2</span> <span class="c1"># returns new h</span>
  </pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Draw the agent: Around ctx save/restore pair</p>

<ul>
<li>Get the agent shape object: procedure &amp; rotate flag</li>
<li>Set agent transform, assuming patch coordinate transform in place</li>
<li>Rotate shape by heading if rotate flag set on shape</li>
<li>Call the shape draw with our ctx, closing the path</li>
<li>Fill with agent color</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">draw: </span><span class="nf">(ctx) -&gt;</span>
    <span class="nv">shape = </span><span class="nx">ABM</span><span class="p">.</span><span class="nx">shapes</span><span class="p">[</span><span class="nx">@shape</span><span class="p">]</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">@sprite</span><span class="o">?</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">translate</span> <span class="nx">@x</span><span class="p">,</span> <span class="nx">@y</span> <span class="c1"># see tutorial: http://goo.gl/VUlhY</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">rotate</span> <span class="nx">@heading</span> <span class="k">if</span> <span class="nx">shape</span><span class="p">.</span><span class="nx">rotate</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">scale</span> <span class="mi">1</span><span class="o">/</span><span class="nx">ABM</span><span class="p">.</span><span class="nx">patches</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="nx">ABM</span><span class="p">.</span><span class="nx">patches</span><span class="p">.</span><span class="nx">size</span> <span class="c1"># convert back to pixel scale</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">drawImage</span> <span class="nx">@sprite</span><span class="p">.</span><span class="nx">canvas</span><span class="p">,</span> <span class="o">-</span><span class="nx">@sprite</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="nx">@sprite</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">else</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">translate</span> <span class="nx">@x</span><span class="p">,</span> <span class="nx">@y</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">scale</span> <span class="nx">@size</span><span class="p">,</span> <span class="nx">@size</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">rotate</span> <span class="nx">@heading</span> <span class="k">if</span> <span class="nx">shape</span><span class="p">.</span><span class="nx">rotate</span>
      <span class="vi">@colorStr = </span><span class="nx">u</span><span class="p">.</span><span class="nx">colorStr</span> <span class="nx">@color</span> <span class="k">if</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">agents</span><span class="p">.</span><span class="nx">staticColors</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@colorStr</span><span class="o">?</span>
      <span class="nv">ctx.fillStyle = </span><span class="nx">@colorStr</span> <span class="o">or</span> <span class="nx">u</span><span class="p">.</span><span class="nx">colorStr</span> <span class="nx">@color</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">()</span>
      <span class="nx">shape</span><span class="p">.</span><span class="nx">draw</span> <span class="nx">ctx</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">closePath</span><span class="p">()</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">fill</span><span class="p">()</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">()</span>
  </pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Draw the agent on the drawing layer, leaving perminant image.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">stamp: </span><span class="o">-&gt;</span> <span class="nx">@draw</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">drawing</span>
  </pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Return distance in patch coords from me to x,y 
using patch topology (isTorus)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">distanceXY: </span><span class="nf">(x,y) -&gt;</span>
    <span class="k">if</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">patches</span><span class="p">.</span><span class="nx">isTorus</span>
    <span class="k">then</span> <span class="nx">u</span><span class="p">.</span><span class="nx">torusDistance</span> <span class="nx">@x</span><span class="p">,</span> <span class="nx">@y</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">patches</span><span class="p">.</span><span class="nx">numX</span><span class="p">,</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">patches</span><span class="p">.</span><span class="nx">numY</span>
    <span class="k">else</span> <span class="nx">u</span><span class="p">.</span><span class="nx">distance</span> <span class="nx">@x</span><span class="p">,</span> <span class="nx">@y</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span>
  </pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Return distance in patch coords from me to given agent/patch
using patch topology (isTorus)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">distance: </span><span class="nf">(o) -&gt;</span> <span class="c1"># o any object w/ x,y, patch or agent</span>
    <span class="nx">@distanceXY</span> <span class="nx">o</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">y</span>
  </pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Return the closest torus topology point of given x,y relative to myself.
See util.torusPt.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">torusPtXY: </span><span class="nf">(x, y) -&gt;</span>
    <span class="nx">u</span><span class="p">.</span><span class="nx">torusPt</span> <span class="nx">@x</span><span class="p">,</span> <span class="nx">@y</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">patches</span><span class="p">.</span><span class="nx">numX</span><span class="p">,</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">patches</span><span class="p">.</span><span class="nx">numY</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Return the closest torus topology point of given agent/patch 
relative to myself. See util.torusPt.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">torusPt: </span><span class="nf">(o) -&gt;</span>
    <span class="nx">@torusPtXY</span> <span class="nx">o</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">y</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Set my heading towards given agent/patch using patch topology (isTorus)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">face: </span><span class="nf">(o) -&gt;</span> <span class="vi">@heading = </span><span class="nx">@towards</span> <span class="nx">o</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Return heading towards x,y using patch topology (isTorus)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">towardsXY: </span><span class="nf">(x, y) -&gt;</span>
    <span class="k">if</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">patches</span><span class="p">.</span><span class="nx">isTorus</span>
    <span class="k">then</span> <span class="nx">u</span><span class="p">.</span><span class="nx">torusRadsToward</span> <span class="nx">@x</span><span class="p">,</span> <span class="nx">@y</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">patches</span><span class="p">.</span><span class="nx">numX</span><span class="p">,</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">patches</span><span class="p">.</span><span class="nx">numY</span>
    <span class="k">else</span> <span class="nx">u</span><span class="p">.</span><span class="nx">radsToward</span> <span class="nx">@x</span><span class="p">,</span> <span class="nx">@y</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Return heading towards given agent/patch using patch topology (isTorus)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">towards: </span><span class="nf">(o) -&gt;</span> <span class="nx">@towardsXY</span> <span class="nx">o</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">y</span>
  </pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>Remove myself from the model.  Includes removing myself from the agents
agentset and removing any links I may have.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">die: </span><span class="o">-&gt;</span>
    <span class="nx">ABM</span><span class="p">.</span><span class="nx">agents</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">@</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">die</span><span class="p">()</span> <span class="k">for</span> <span class="nx">l</span> <span class="k">in</span> <span class="nx">@myLinks</span><span class="p">()</span>
    <span class="nx">u</span><span class="p">.</span><span class="nx">removeItem</span> <span class="nx">@p</span><span class="p">.</span><span class="nx">agents</span><span class="p">,</span> <span class="nx">@</span> <span class="k">if</span> <span class="nx">@p</span><span class="p">.</span><span class="nx">agents</span><span class="o">?</span>
    <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Factory: create num new agents here
The optional init proc is called on each of the newly created agents.<br>
NOTE: init must be applied after object inserted in agent set</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">hatch: </span><span class="nf">(num = 1, init = -&gt;) -&gt;</span>
    <span class="nx">ABM</span><span class="p">.</span><span class="nx">agents</span><span class="p">.</span><span class="nx">create</span> <span class="nx">num</span><span class="p">,</span> <span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="c1"># fat arrow so that @ = this agent</span>
      <span class="nx">a</span><span class="p">.</span><span class="nx">setXY</span> <span class="nx">@x</span><span class="p">,</span> <span class="nx">@y</span> <span class="c1"># for side effects like patches.agentsHere</span>
      <span class="nx">a</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span> <span class="k">for</span> <span class="nx">own</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">@</span> <span class="k">when</span> <span class="nx">k</span> <span class="o">isnt</span> <span class="s">&quot;id&quot;</span>    
      <span class="nx">init</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span> <span class="nx">a</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Return the members of the given agentset that are within radius distance 
from me, and within cone radians of my heading using patch topology (isTorus)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">inCone: </span><span class="nf">(aset, cone, radius, meToo=false) -&gt;</span> 
    <span class="nx">aset</span><span class="p">.</span><span class="nx">inCone</span> <span class="nx">@p</span><span class="p">,</span> <span class="nx">@heading</span><span class="p">,</span> <span class="nx">cone</span><span class="p">,</span> <span class="nx">radius</span><span class="p">,</span> <span class="nx">meToo</span> <span class="c1"># REMIND: @p vs @?</span>
  </pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Return other end of link from me</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">otherEnd: </span><span class="nf">(l) -&gt;</span> <span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">end1</span> <span class="o">is</span> <span class="nx">@</span> <span class="k">then</span> <span class="nx">l</span><span class="p">.</span><span class="nx">end2</span> <span class="k">else</span> <span class="nx">l</span><span class="p">.</span><span class="nx">end1</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>Return all links linked to me</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">myLinks: </span><span class="o">-&gt;</span>
    <span class="nx">@links</span> <span class="o">?</span> <span class="p">(</span><span class="nx">l</span> <span class="k">for</span> <span class="nx">l</span> <span class="k">in</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">links</span> <span class="k">when</span> <span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">end1</span> <span class="o">is</span> <span class="nx">@</span><span class="p">)</span> <span class="o">or</span> <span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nx">end2</span> <span class="o">is</span> <span class="nx">@</span><span class="p">))</span>
  </pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>Return all agents linked to me.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">linkNeighbors: </span><span class="o">-&gt;</span> <span class="c1"># return all agents linked to me</span>
    <span class="nx">@otherEnd</span> <span class="nx">l</span> <span class="k">for</span> <span class="nx">l</span> <span class="k">in</span> <span class="nx">@myLinks</span><span class="p">()</span>
  </pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>Return links where I am the "to" agent in links.create</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">myInLinks: </span><span class="o">-&gt;</span>
    <span class="nx">l</span> <span class="k">for</span> <span class="nx">l</span> <span class="k">in</span> <span class="nx">@myLinks</span><span class="p">()</span> <span class="k">when</span> <span class="nx">l</span><span class="p">.</span><span class="nx">end2</span> <span class="o">is</span> <span class="nx">@</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Return other end of myInLinks</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">myInLinkNeighbors: </span><span class="o">-&gt;</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">end1</span> <span class="k">for</span> <span class="nx">l</span> <span class="k">in</span> <span class="nx">@myLinks</span><span class="p">()</span> <span class="k">when</span> <span class="nx">l</span><span class="p">.</span><span class="nx">end2</span> <span class="o">is</span> <span class="nx">@</span>
    </pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Return links where I am the "from" agent in links.create</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">myOutLinks: </span><span class="o">-&gt;</span>
    <span class="nx">l</span> <span class="k">for</span> <span class="nx">l</span> <span class="k">in</span> <span class="nx">@myLinks</span><span class="p">()</span> <span class="k">when</span> <span class="nx">l</span><span class="p">.</span><span class="nx">end1</span> <span class="o">is</span> <span class="nx">@</span>
  </pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Return other end of myOutinks</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">myInLinkNeighbors: </span><span class="o">-&gt;</span>
    <span class="nx">l</span><span class="p">.</span><span class="nx">end2</span> <span class="k">for</span> <span class="nx">l</span> <span class="k">in</span> <span class="nx">@myLinks</span><span class="p">()</span> <span class="k">when</span> <span class="nx">l</span><span class="p">.</span><span class="nx">end1</span> <span class="o">is</span> <span class="nx">@</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Class Agents is a subclass of AgentSet which stores instances of Agent.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">Agents</span> <span class="k">extends</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">AgentSet</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>Constructor creates the AgentSet instance and installs
variables shared by all the Agents.  This can be used to
minimize Agent variables by using a "default".  Here for example
we provide a default shape for agents.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@staticColors = </span><span class="kc">false</span>
    <span class="vi">@useSprites = </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>Methods to change the default Agent class variables.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setDefaultColor: </span> <span class="nf">(color) -&gt;</span> <span class="nv">ABM.Agent::color = </span><span class="nx">color</span><span class="c1">#; @setDefaultSprite()</span>
  <span class="nv">setDefaultShape: </span> <span class="nf">(shape) -&gt;</span> <span class="nv">ABM.Agent::shape = </span><span class="nx">shape</span><span class="c1">#; @setDefaultSprite()</span>
  <span class="nv">setDefaultSize: </span>  <span class="nf">(size)  -&gt;</span> <span class="nv">ABM.Agent::size = </span><span class="nx">size</span><span class="c1">#; @setDefaultSprite()</span>
  <span class="nx">setDefaultHeading</span><span class="o">:</span><span class="nf">(heading)-&gt;</span> <span class="nv">ABM.Agent::heading = </span><span class="nx">heading</span>
  <span class="nv">setDefaultHidden: </span><span class="nf">(hidden)-&gt;</span> <span class="nv">ABM.Agent::hidden = </span><span class="nx">hidden</span>
  <span class="nv">setDefaultSprite: </span><span class="o">-&gt;</span> 
    <span class="k">if</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">Agent</span><span class="o">::</span><span class="nx">color</span><span class="o">?</span>
      <span class="nv">ABM.Agent::sprite = </span><span class="nx">ABM</span><span class="p">.</span><span class="nx">shapes</span><span class="p">.</span><span class="nx">shapeToCtx</span> <span class="o">\</span>
        <span class="nx">ABM</span><span class="p">.</span><span class="nx">Agent</span><span class="o">::</span><span class="nx">shape</span><span class="p">,</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">Agent</span><span class="o">::</span><span class="nx">color</span><span class="p">,</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">Agent</span><span class="o">::</span><span class="nx">size</span><span class="o">*</span><span class="nx">ABM</span><span class="p">.</span><span class="nx">patches</span><span class="p">.</span><span class="nx">size</span>
  <span class="nv">setDefaultPen: </span>  <span class="nf">(size, down=false) -&gt;</span> 
    <span class="nv">ABM.Agent::penSize = </span><span class="nx">size</span>
    <span class="nv">ABM.Agent::penDown = </span><span class="nx">down</span>
  </pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Performance: tell draw to reuse existing color string</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setStaticColors: </span><span class="nf">(@staticColors) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>Use sprites rather than drawing</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setUseSprites: </span><span class="nf">(@useSprites) -&gt;</span>      </pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>Factory: create num new agents stored in this agentset.
The optional init proc is called on each of the newly created agents.<br>
NOTE: init must be applied after object inserted in agent set</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">create: </span><span class="nf">(num, init = -&gt;) -&gt;</span> <span class="c1"># returns list too</span>
    <span class="p">(</span><span class="nf">(o) -&gt;</span> <span class="nx">init</span><span class="p">(</span><span class="nx">o</span><span class="p">);</span> <span class="nx">o</span><span class="p">)</span> <span class="nx">@add</span> <span class="k">new</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">Agent</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="nx">num</span><span class="p">]</span> <span class="k">by</span> <span class="mi">1</span> <span class="c1"># too tricky?</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>Remove all agents from set via agent.die()
Note call in reverse order to optimize list restructuring.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">clear: </span><span class="o">-&gt;</span> <span class="nx">@last</span><span class="p">().</span><span class="nx">die</span><span class="p">()</span> <span class="k">while</span> <span class="nx">@any</span><span class="p">();</span> <span class="kc">null</span> <span class="c1"># tricky, each die modifies list</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>Return the subset of this set with the given breed value.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">breed: </span><span class="nf">(breed) -&gt;</span> <span class="nx">@getWithProp</span> <span class="s">&quot;breed&quot;</span><span class="p">,</span> <span class="nx">breed</span>
  </pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Return an agentset of agents within the patch array</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">agentsInPatches: </span><span class="nf">(patches) -&gt;</span>
    <span class="nv">array = </span><span class="p">[]</span>
    <span class="nx">array</span><span class="p">.</span><span class="nx">push</span> <span class="nx">p</span><span class="p">.</span><span class="nx">agentsHere</span><span class="p">()...</span> <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">patches</span> <span class="c1"># concat measured slower</span>
    <span class="nx">@asSet</span> <span class="nx">array</span>
  </pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>Return an agentset of agents within the patchRect</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">agentRect: </span><span class="nf">(a, dx, dy, meToo=false) -&gt;</span>
    <span class="nv">rect = </span><span class="nx">ABM</span><span class="p">.</span><span class="nx">patches</span><span class="p">.</span><span class="nx">patchRect</span> <span class="nx">a</span><span class="p">.</span><span class="nx">p</span><span class="p">,</span> <span class="nx">dx</span><span class="p">,</span> <span class="nx">dy</span><span class="p">,</span> <span class="kc">true</span>
    <span class="nv">rect = </span><span class="nx">@agentsInPatches</span> <span class="nx">rect</span>
    <span class="nx">u</span><span class="p">.</span><span class="nx">removeItem</span> <span class="nx">rect</span><span class="p">,</span> <span class="nx">a</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">meToo</span>
    <span class="nx">rect</span>
  </pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Return the members of this agentset that are within radius distance
from me, and within cone radians of my heading using patch topology (isTorus)<br>
See agentset.inCone</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">inCone: </span><span class="nf">(a, heading, cone, radius, meToo=false) -&gt;</span> <span class="c1"># heading? .. so p ok?</span>
    <span class="nv">as = </span><span class="nx">@agentRect</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">radius</span><span class="p">,</span> <span class="nx">radius</span><span class="p">,</span> <span class="kc">true</span>
    <span class="nx">as</span><span class="p">.</span><span class="nx">inCone</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">heading</span><span class="p">,</span> <span class="nx">cone</span><span class="p">,</span> <span class="nx">radius</span><span class="p">,</span> <span class="nx">meToo</span>
  </pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Return the members of this agentset that are with radius distance
from me, using patch topology (isTorus)<br>
See agentset.inRadius</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">inRadius: </span><span class="nf">(a, radius, meToo=false)-&gt;</span>
    <span class="nv">as = </span><span class="nx">@agentRect</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">radius</span><span class="p">,</span> <span class="nx">radius</span><span class="p">,</span> <span class="kc">true</span>
    <span class="nx">as</span><span class="p">.</span><span class="nx">inRadius</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">radius</span><span class="p">,</span> <span class="nx">meToo</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <h3>Link and Links</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>Class Link connects two agent endpoints for graph modeling.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">Link</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>Constructor initializes instance variables:</p>

<ul>
<li>end1, end2: two agents being connected</li>
<li>color: defaults to light gray</li>
<li>thickness: the thickness of the line connecting the ends<br>
Defaults to 2 pixels in patch coordinates.</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">breed: </span><span class="s">&quot;default&quot;</span>
  <span class="nv">color: </span><span class="p">[</span><span class="mi">130</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">130</span><span class="p">]</span>
  <span class="nv">thickness: </span><span class="mi">2</span>
  <span class="nv">hidden: </span><span class="kc">false</span>
  <span class="nv">constructor: </span><span class="nf">(@end1, @end2) -&gt;</span>
    <span class="k">if</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">links</span><span class="p">.</span><span class="nx">cacheAgentLinks</span>
      <span class="nx">@end1</span><span class="p">.</span><span class="nx">links</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@</span>
      <span class="nx">@end2</span><span class="p">.</span><span class="nx">links</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@</span>
      
  </pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>Draw a line between the two endpoints.  Draws "around" the
torus if appropriate using two lines. As with Agent.draw,
is called with patch coordinate transform installed.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">draw: </span><span class="nf">(ctx) -&gt;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
    <span class="nv">ctx.strokeStyle = </span><span class="nx">u</span><span class="p">.</span><span class="nx">colorStr</span> <span class="nx">@color</span>
    <span class="nv">ctx.lineWidth = </span><span class="nx">ABM</span><span class="p">.</span><span class="nx">patches</span><span class="p">.</span><span class="nx">bits2Patches</span> <span class="nx">@thickness</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">()</span>
    <span class="k">if</span> <span class="o">!</span><span class="nx">ABM</span><span class="p">.</span><span class="nx">patches</span><span class="p">.</span><span class="nx">isTorus</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">moveTo</span> <span class="nx">@end1</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">@end1</span><span class="p">.</span><span class="nx">y</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span> <span class="nx">@end2</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">@end2</span><span class="p">.</span><span class="nx">y</span>
    <span class="k">else</span>
      <span class="nv">pt = </span><span class="nx">@end1</span><span class="p">.</span><span class="nx">torusPt</span> <span class="nx">@end2</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">moveTo</span> <span class="nx">@end1</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">@end1</span><span class="p">.</span><span class="nx">y</span>
      <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span> <span class="nx">pt</span><span class="p">...</span>
      <span class="k">if</span> <span class="nx">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">isnt</span> <span class="nx">@end2</span><span class="p">.</span><span class="nx">x</span> <span class="o">or</span> <span class="nx">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">isnt</span> <span class="nx">@end2</span><span class="p">.</span><span class="nx">y</span>
        <span class="nv">pt = </span><span class="nx">@end2</span><span class="p">.</span><span class="nx">torusPt</span> <span class="nx">@end1</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">moveTo</span> <span class="nx">@end2</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">@end2</span><span class="p">.</span><span class="nx">y</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">lineTo</span> <span class="nx">pt</span><span class="p">...</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">closePath</span><span class="p">()</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">stroke</span><span class="p">()</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">restore</span><span class="p">()</span>
  </pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>Remove this link from the agent set</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">die: </span><span class="o">-&gt;</span>
    <span class="nx">ABM</span><span class="p">.</span><span class="nx">links</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">@</span>
    <span class="nx">u</span><span class="p">.</span><span class="nx">removeItem</span> <span class="nx">@end1</span><span class="p">.</span><span class="nx">links</span><span class="p">,</span> <span class="nx">@</span> <span class="k">if</span> <span class="nx">@end1</span><span class="p">.</span><span class="nx">links</span><span class="o">?</span>
    <span class="nx">u</span><span class="p">.</span><span class="nx">removeItem</span> <span class="nx">@end2</span><span class="p">.</span><span class="nx">links</span><span class="p">,</span> <span class="nx">@</span> <span class="k">if</span> <span class="nx">@end2</span><span class="p">.</span><span class="nx">links</span><span class="o">?</span>
  </pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Return the two endpoints of this link</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">bothEnds: </span><span class="o">-&gt;</span> <span class="p">[</span><span class="nx">@end1</span><span class="p">,</span> <span class="nx">@end2</span><span class="p">]</span>
  </pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>Return the distance between the endpoints with the current topology.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">length: </span><span class="o">-&gt;</span> <span class="nx">@end1</span><span class="p">.</span><span class="nx">distance</span> <span class="nx">@end2</span>
  </pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>Return the other end of the link, given an endpoint agent.
Assumes the given input <em>is</em> one of the link endpoint pairs!</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">otherEnd: </span><span class="nf">(a) -&gt;</span> <span class="k">if</span> <span class="nx">@end1</span> <span class="o">is</span> <span class="nx">a</span> <span class="k">then</span> <span class="nx">@end2</span> <span class="k">else</span> <span class="nx">@end1</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>Class Links is a subclass of AgentSet which stores instances of Link.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">Links</span> <span class="k">extends</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">AgentSet</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>Constructor simply creates an unmodified AgentSet</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@cacheAgentLinks = </span><span class="kc">false</span>
  </pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>Methods to change the default Link class variables.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setDefaultColor: </span>    <span class="nf">(color)      -&gt;</span> <span class="nv">ABM.Link::color = </span><span class="nx">color</span>
  <span class="nv">setDefaultThickness: </span><span class="nf">(thickness)  -&gt;</span> <span class="nv">ABM.Link::thickness = </span><span class="nx">thickness</span>
  <span class="nv">setDefaultHidden: </span>   <span class="nf">(hidden)     -&gt;</span> <span class="nv">ABM.Link::hidden = </span><span class="nx">hidden</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>Factory: Add 1 or more links from the from agent to
the to agent(s) which can be a single agent or an array
of agents.
The optional init proc is called on each of the newly created links.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">create: </span><span class="nf">(from, to, init = -&gt;) -&gt;</span> <span class="c1"># returns list too</span>
    <span class="nv">to = </span><span class="p">[</span><span class="nx">to</span><span class="p">]</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">to</span><span class="p">.</span><span class="nx">length</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>NOTE: init must be applied after object inserted in agent set</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">(</span><span class="nf">(o) -&gt;</span> <span class="nx">init</span><span class="p">(</span><span class="nx">o</span><span class="p">);</span> <span class="nx">o</span><span class="p">)</span> <span class="nx">@add</span> <span class="k">new</span> <span class="nx">ABM</span><span class="p">.</span><span class="nx">Link</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">a</span> <span class="k">for</span> <span class="nx">a</span> <span class="k">in</span> <span class="nx">to</span> <span class="c1"># too tricky?</span>
  </pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>Remove all links from set via link.die()
Note call in reverse order to optimize list restructuring.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">clear: </span><span class="o">-&gt;</span> <span class="nx">@last</span><span class="p">().</span><span class="nx">die</span><span class="p">()</span> <span class="k">while</span> <span class="nx">@any</span><span class="p">();</span> <span class="kc">null</span> <span class="c1"># tricky, each die modifies list</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>Return the subset of this set with the given breed value.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">breed: </span><span class="nf">(breed) -&gt;</span> <span class="nx">@getWithProp</span> <span class="s">&quot;breed&quot;</span><span class="p">,</span> <span class="nx">breed</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>Return all the nodes in this agentset, with duplicates
included.  If 4 links have the same endpoint, it will
appear 4 times.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">allEnds: </span><span class="o">-&gt;</span> <span class="c1"># all link ends, w/ dups</span>
    <span class="nv">n = </span><span class="nx">@asSet</span> <span class="p">[]</span>
    <span class="nx">n</span><span class="p">.</span><span class="nx">push</span> <span class="nx">l</span><span class="p">.</span><span class="nx">end1</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">end2</span> <span class="k">for</span> <span class="nx">l</span> <span class="k">in</span> <span class="nx">@</span>
    <span class="nx">n</span></pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>Returns all the nodes in this agentset sorted by ID and with
duplicates removed.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">nodes: </span><span class="o">-&gt;</span> <span class="c1"># allEnds without dups</span>
    <span class="nx">@allEnds</span><span class="p">().</span><span class="nx">sortById</span><span class="p">().</span><span class="nx">uniq</span><span class="p">()</span>
  </pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>Circle Layout: position the agents in the list in an equally
spaced circle of the given radius, with the initial agent
at the given start angle (default to pi/2 or "up") and in the
+1 or -1 direction (counder clockwise or clockwise) 
defaulting to -1 (clockwise).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">layoutCircle: </span><span class="nf">(list, radius, startAngle = Math.PI/2, direction = -1) -&gt;</span>
    <span class="nv">dTheta = </span><span class="mi">2</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="nx">list</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">for</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">list</span>
      <span class="nx">a</span><span class="p">.</span><span class="nx">setXY</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
      <span class="nv">a.heading = </span><span class="nx">startAngle</span> <span class="o">+</span> <span class="nx">direction</span><span class="o">*</span><span class="nx">dTheta</span><span class="o">*</span><span class="nx">i</span>
      <span class="nx">a</span><span class="p">.</span><span class="nx">forward</span> <span class="nx">radius</span>
    <span class="kc">null</span>
      

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 