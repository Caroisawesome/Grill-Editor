(function(){ABM.TileDataSet=function(){function i(i,t,e,o){this.tileSize=e||256,this.tiles={},this.width=i,this.height=t,this.model=o,this.zoom=0,this.origin={x:0,y:0}}return i.prototype=new ABM.DataSet,i.prototype.addTile=function(i,t){var e=[i.z,i.x,i.y].join("/");this.tiles[e]=t},i.prototype.getTileContainingPoint=function(i,t){var e=this.zoom,o={x:this.origin.x+i,y:this.origin.y+t},l=Math.floor(o.x/this.tileSize),s=Math.floor(o.y/this.tileSize),h=this.tiles[e+"/"+l+"/"+s];return h||console.log("ERR: tried to sample tile",e,l,s,"but it doesn't exist."),h},i.prototype.importTileData=function(){this.data=new Array(this.width*this.height);for(var i=this.origin,t={x:i.x+this.width,y:i.y+this.height},e={x:Math.floor(i.x/this.tileSize),y:Math.floor(i.y/this.tileSize)},o={left:i.x%this.tileSize,top:i.y%this.tileSize,right:t.x%this.tileSize,bottom:t.y%this.tileSize},l=Math.floor(this.width/this.tileSize),s=Math.floor(this.height/this.tileSize),h=0;l>=h;h++)for(var n=0;s>=n;n++){var a=this.getTileContainingPoint(h*this.tileSize,n*this.tileSize),r=a.getImageData(0,0,this.tileSize,this.tileSize),d={left:(e.x+h)*this.tileSize,top:(e.y+n)*this.tileSize},f={x:0,y:0},y={x:this.tileSize-1,y:this.tileSize-1};0==h&&(f.x=o.left),(h+1)*this.tileSize>this.width&&(y.x=o.right),0==n&&(f.y=o.top),(n+1)*this.tileSize>this.height&&(y.y=o.bottom);for(var p=f.x;p<=y.x;p++)for(var g=f.y;g<=y.y;g++){var u={x:p+d.left-i.x,y:g+d.top-i.y},z=this.toIndex(u.x,u.y),x=4*(g*this.tileSize+p);this.data[z]=this.parseTileData([r.data[x],r.data[x+1],r.data[x+2],r.data[x+3]])}}},i.prototype.parseTileData=function(i){return i},i.prototype.bindToLeaflet=function(i,t,e){function o(i){var t=/.*\/(\d+)\/(\d+)\/(\d+)\.png$/,e=t.exec(i);return e&&{z:e[1],x:e[2],y:e[3]}}if(this.leafletMap=i,this.leafletLayer=t,!e){this.embedLeaflet();var l=this.leafletMap.getSize();this.width=l.x,this.height=l.y}this.tileSize=t._getTileSize(),this.origin=this.leafletMap.getPixelBounds().min,this.zoom=i.getZoom(),t.on("tileload",function(i){var t=o(i.url);if(!t)return void console.log("err: couldn't parse tile coordinates for",i.url);var e=ABM.util.imageToCtx(i.tile,this.tileSize,this.tileSize);this.addTile(t,e)}.bind(this)),i.on("zoomstart",function(){this.tiles={}}.bind(this)),i.on("moveend",function(){this.origin=this.leafletMap.getPixelBounds().min}.bind(this)),i.on("zoomend",function(){this.zoom=this.leafletMap.getZoom()}.bind(this)),this.on=function(i,t){var e=this.leafletLayer;e&&e.on(i,t)};var s=!0,h=!1;t.on("loading",function(){h=!1}),i.on("movestart",function(){s=!1}),t.on("load",function(){h=!0,s&&this.leafletLayer.fire("tilesready")}.bind(this)),i.on("moveend",function(){s=!0,h&&this.leafletLayer.fire("tilesready")}.bind(this))},i.prototype.embedLeaflet=function(){return this.model.div?(ABM.util.insertLayer(this.model.div,this.leafletMap.getContainer(),this.model.world.pxWidth+"px",this.model.world.pxHeight+"px",15),void this.leafletMap.invalidateSize()):void console.log("ERR: Tried to embed leaflet map into a headless model, or before model div was initialized.")},i}()}).call(this),L.CrossOriginTileLayer=L.TileLayer.extend({_createTile:function(){var i=L.TileLayer.prototype._createTile.apply(this);return i.crossOrigin="",i}}),L.crossOriginTileLayer=function(i,t){return new L.CrossOriginTileLayer(i,t)};