function TileDataSet(t,i,e){this.tileSize=e||256,this.tiles={},this.width=t,this.height=i,this.zoom=0,this.origin={x:0,y:0}}TileDataSet.prototype=new ABM.DataSet,TileDataSet.prototype.getXY=function(t,i){this.checkXY(t,i);var e=this.getTileContainingPoint(t,i),o={x:this.origin.x+t,y:this.origin.y+i},n=o.x%this.tileSize,a=o.y%this.tileSize,l=e.getImageData(n,a,1,1).data,s=this.parseTileData(l);return s},TileDataSet.prototype.bilinear=function(t,i){this.checkXY(t,i);var e=Math.floor(t),o=Math.floor(i),t=t-e,i=i-o,n=1-t,a=1-i,l=this.getXY(e,o),s=this.getXY(e,o+1),r=this.getXY(e+1,o),h=this.getXY(e+1,o+1);return l*n*a+r*t*a+s*n*i+h*t*i},TileDataSet.prototype.addTile=function(t,i){var e=[t.z,t.x,t.y].join("/");this.tiles[e]=i},TileDataSet.prototype.getTileContainingPoint=function(t,i){var e=this.zoom,o={x:this.origin.x+t,y:this.origin.y+i},n=Math.floor(o.x/this.tileSize),a=Math.floor(o.y/this.tileSize),l=this.tiles[e+"/"+n+"/"+a];return l||console.log("ERR: tried to sample tile",e,n,a,"but it doesn't exist."),l},TileDataSet.prototype.parseTileData=function(t){return t},TileDataSet.prototype.bindToLeaflet=function(t,i,e){function o(t){var i=/.*\/(\d+)\/(\d+)\/(\d+)\.png/,e=i.exec(t);return{z:e[1],x:e[2],y:e[3]}}if(this.leafletMap=t,this.leafletLayer=i,!e){this.embedLeaflet();var n=this.leafletMap.getSize();this.width=n.x,this.height=n.y}this.tileSize=this.tileSize||i._getTileSize(),this.origin=this.leafletMap.getPixelBounds().min,this.zoom=t.getZoom(),i.on("tileload",function(t){var i=o(t.url),e=ABM.util.imageToCtx(t.tile,this.tileSize,this.tileSize);this.addTile(i,e)}.bind(this)),t.on("zoomstart",function(){this.tiles={}}.bind(this)),t.on("moveend",function(){this.origin=this.leafletMap.getPixelBounds().min}.bind(this)),t.on("zoomend",function(){this.zoom=this.leafletMap.getZoom()}.bind(this)),this.on=function(t,i){var e=this.leafletLayer;e&&e.on(t,i)};var a=!0,l=!1;i.on("loading",function(){l=!1}),t.on("movestart",function(){a=!1}),i.on("load",function(){l=!0,a&&this.leafletLayer.fire("tilesready")}.bind(this)),t.on("moveend",function(){a=!0,l&&this.leafletLayer.fire("tilesready")}.bind(this))},TileDataSet.prototype.embedLeaflet=function(){return ABM.model.div?(ABM.util.insertLayer(ABM.model.div,this.leafletMap.getContainer(),ABM.world.pxWidth+"px",ABM.world.pxHeight+"px",15),void this.leafletMap.invalidateSize()):void console.log("ERR: Tried to embed leaflet map into a headless model, or before model div was initialized.")},L.CrossOriginTileLayer=L.TileLayer.extend({_createTile:function(){var t=L.TileLayer.prototype._createTile.apply(this);return t.crossOrigin="",t}}),L.crossOriginTileLayer=function(t,i){return new L.CrossOriginTileLayer(t,i)};