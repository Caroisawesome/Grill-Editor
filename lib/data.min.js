!function(){var t,i,e,h,r,n={}.hasOwnProperty,a=function(t,i){function e(){this.constructor=t}for(var h in i)n.call(i,h)&&(t[h]=i[h]);return e.prototype=i.prototype,t.prototype=new e,t.__super__=i.prototype,t};r=ABM.util,ABM.DataSet=i=function(){function i(t,i,e){null==t&&(t=0),null==i&&(i=0),null==e&&(e=[]),this.useNearest=!1,this.reset(t,i,e)}return i.patchDataSet=function(t){return new h(t)},i.importImageDataSet=function(t,i,h){var n;return null==i&&(i=3),n=new e(null,i),r.importImage(t,function(t){return n.parse(t),null!=h?h(n):void 0}),n},i.importAscDataSet=function(i,e){var h;return h=new t,r.xhrLoadFile(i,"text",function(t){return h.parse(t),null!=e?e(h):void 0}),h},i.prototype.reset=function(t,i,e){return this.width=t,this.height=i,this.data=e,e.length!==t*i&&r.error("DataSet: data array length error:\ndata.length: "+this.data.length+" width: "+this.width+" height: "+this.height),this},i.prototype.checkXY=function(t,i){return t>=0&&t<=this.width-1&&i>=0&&i<=this.height-1?void 0:r.error("x,y out of range: "+t+","+i)},i.prototype.setSampler=function(t){this.useNearest=t},i.prototype.sample=function(t,i){return this.useNearest?this.nearest(t,i):this.bilinear(t,i)},i.prototype.nearest=function(t,i){return this.getXY(Math.round(t),Math.round(i))},i.prototype.bilinear=function(t,i){var e,h,r,n,a,o,s,u,l,p,c,d,f;return this.checkXY(t,i),l=Math.floor(t),p=Math.floor(i),s=this.toIndex(l,p),u=this.width,t-=l,i-=p,e=1-t,h=1-i,r=this.data[s],n=null!=(c=this.data[s+u])?c:0,a=null!=(d=this.data[++s])?d:0,o=null!=(f=this.data[s+u])?f:0,r*e*h+a*t*h+n*e*i+o*t*i},i.prototype.toIndex=function(t,i){return t+i*this.width},i.prototype.toXY=function(t){return[t%this.width,Math.floor(t/this.width)]},i.prototype.getXY=function(t,i){return this.checkXY(t,i),this.data[this.toIndex(t,i)]},i.prototype.setXY=function(t,i,e){return this.checkXY(t,i),this.data[this.toIndex(t,i)]=e},i.prototype.toString=function(t,i){var e,h,n,a,o;for(null==t&&(t=2),null==i&&(i=", "),n="width: "+this.width+" height: "+this.height+" data:",e=0>t?this.data:r.aToFixed(this.data,t),h=a=0,o=this.height;o>=0?o>a:a>o;h=o>=0?++a:--a)n+="\n"+(""+h+": "+e.slice(h*this.width,(h+1)*this.width));return n.replace(/,/g,i)},i.prototype.toImage=function(t,i,e){var h,n,a,o,s,u,l,p,c,d,f;for(null==t&&(t=!0),null==i&&(i=!0),null==e&&(e=255),h=r.createCtx(this.width,this.height),o=h.getImageData(0,0,this.width,this.height),c=o.data,u=Math.pow(2,t?8:24),l=i?r.normalize(this.data,0,u-1e-6):function(){var t,i,e,h;for(e=this.data,h=[],t=0,i=e.length;i>t;t++)n=e[t],h.push(r.clamp(Math.round(n),0,u-1));return h}.call(this),a=d=0,f=l.length;f>d;a=++d)p=l[a],s=4*a,c[s+3]=e,t?c[s]=c[s+1]=c[s+2]=Math.floor(p):(c[s]=p>>>16,c[s+1]=255&p>>8,c[s+2]=255&p);return h.putImageData(o,0,0),h.canvas},i.prototype.toDrawing=function(t){var i;return null==t&&(t=!0),ABM.patches.installDrawing(i=this.toImage(t)),i},i.prototype.toPatchColors=function(t){var i;return null==t&&(t=!0),ABM.patches.installColors(i=this.toImage(t)),i},i.prototype.toPatchVar=function(t){var i,e,r;return i=function(){var i,h,n,a;for(n=r=ABM.patches,a=[],i=0,h=n.length;h>i;i++)e=n[i],a.push(e[t]=this.patchSample(e.x,e.y));return a}.call(this),new h(r.numX,r.numY,i)},i.prototype.coordSample=function(t,i,e,h,r,n){var a,o;return a=(t-e)*(this.width-1)/r,o=(h-i)*(this.height-1)/n,this.sample(a,o)},i.prototype.patchSample=function(t,i){var e;return e=ABM.world,this.coordSample(t,i,e.minXcor,e.maxYcor,e.numX,e.numY)},i.prototype.resample=function(t,e){var h,r,n,a,o,s,u,l,p;if(t===this.width&&e===this.height)return new i(t,e,this.data);for(h=[],n=(this.width-1)/(t-1),s=(this.height-1)/(e-1),o=l=0;e>l;o=l+=1)for(r=p=0;t>p;r=p+=1)a=r*n,u=o*s,h.push(this.sample(a,u));return new i(t,e,h)},i.prototype.neighborhood=function(t,i,e){var h,n,a,o,s,u;for(null==e&&(e=[]),e.length=0,n=s=-1;1>=s;n=++s)for(h=u=-1;1>=u;h=++u)a=r.clamp(t+h,0,this.width-1),o=r.clamp(i+n,0,this.height-1),e.push(this.data[this.toIndex(a,o)]);return e},i.prototype.convolve=function(t,e){var h,n,a,o,s,u,l,p;for(null==e&&(e=1),h=[],n=[],o=s=0,l=this.height;l>s;o=s+=1)for(a=u=0,p=this.width;p>u;a=u+=1)this.neighborhood(a,o,n),h.push(r.aSum(r.aPairMul(t,n))*e);return new i(this.width,this.height,h)},i.prototype.slopeAndAspect=function(t,e,h){var n,a,o,s,u,l,p,c,d,f,m;if(null==t&&(t=1),null==e&&(e=!0),null==h&&(h=!1),null==this.slope){for(this.dzdx=this.convolve([-1,0,1,-2,0,2,-1,0,1],1/8),this.dzdy=this.convolve([1,2,1,0,0,0,-1,-2,-1],1/8),n=[],u=[],p=c=0,f=this.height;f>c;p=c+=1)for(l=d=0,m=this.width;m>d;l=d+=1){for(a=this.dzdx.getXY(l,p),o=this.dzdy.getXY(l,p),u.push(Math.atan(Math.sqrt(a*a+o*o)/t));e&&a===o;)a+=r.randomNormal(0,.01),o+=r.randomNormal(0,.01);s=a===o&&0===o?0/0:Math.atan2(-o,-a),h&&0>s&&(s+=2*Math.PI),n.push(s)}this.slope=new i(this.width,this.height,u),this.aspect=new i(this.width,this.height,n)}return[this.slope,this.aspect,this.dzdx,this.dzdy]},i.prototype.subset=function(t,e,h,n){var a,o,s,u,l,p,c;for((t+h>this.width||e+n>this.height)&&r.error("subSet: params out of range"),a=[],s=u=e,p=e+n;p>u;s=u+=1)for(o=l=t,c=t+h;c>l;o=l+=1)a.push(this.getXY(o,s));return new i(h,n,a)},i}(),ABM.AscDataSet=t=function(t){function i(t){this.str=null!=t?t:"",i.__super__.constructor.call(this),0!==this.str.length&&this.parse(this.str)}return a(i,t),i.prototype.parse=function(t){var i,e,h,r,n,a,o,s,u;for(this.str=t,r=t.split("\n"),this.header={},i=n=0;5>=n;i=++n)e=r[i].split(/\s+/),this.header[e[0].toLowerCase()]=parseFloat(e[1]);for(i=a=0,s=this.header.nrows;s>a;i=a+=1){for(h=r[6+i].trim().split(" "),i=o=0,u=h.length;u>=0?u>o:o>u;i=u>=0?++o:--o)h[i]=parseFloat(h[i]);this.data=this.data.concat(h)}return this.reset(this.header.ncols,this.header.nrows,this.data)},i}(i),ABM.ImageDataSet=e=function(t){function i(t,e){this.img=t,this.byteFmt=null!=e?e:3,i.__super__.constructor.call(this),null!=this.img&&this.parse(this.img)}return a(i,t),i.imageRowsToData=function(t,i,e,h){var n,a,o,s,u,l,p,c,d;for(p=0,a=new e(t.width*t.height);p<t.height;){for(l=Math.min(t.height-p,i),n=r.imageSliceToCtx(t,0,p,t.width,l),u=r.ctxToImageData(n).data,o=p*t.width,s=c=0,d=u.length/4;d>c;s=c+=1)a[o+s]=h(u,4*s);p+=l}return a},i.prototype.ByteFmts=[[2],[1,2],[0,1,2],[3,0,1,2]],i.prototype.checkByteFmt=function(){var t;return r.isArray(this.byteFmt)?this.byteFmt.length>4||r.aMax(this.byteFmt)>3||r.aMin(this.byteFmt)<0?r.error("bad ImageDataSet byte format array: "+this.byteFmt):void 0:(1!==(t=this.byteFmt)&&2!==t&&3!==t&&4!==t&&8!==t&&16!==t&&24!==t&&32!==t&&r.error("bad ImageDataSet byte/bit format int: "+this.byteFmt),this.byteFmt>4&&(this.byteFmt=this.byteFmt/8),this.byteFmt=this.ByteFmts[this.byteFmt-1])},i.prototype.parse=function(t){var i,e,h,n,a,o,s,u,l;for(this.img=t,this.checkByteFmt(this.byteFmt),this.ctx=r.imageToCtx(this.img),h=r.ctxToImageData(this.ctx).data,i=a=0,u=h.length;u>a;i=a+=4){for(n=0,l=this.byteFmt,o=0,s=l.length;s>o;o++)e=l[o],n=256*n+h[i+e];this.data.push(n)}return this.reset(this.ctx.canvas.width,this.ctx.canvas.height,this.data)},i}(i),ABM.PatchDataSet=h=function(t){function i(t,e,h){var n,a;r.isArray(h)?i.__super__.constructor.call(this,t,e,h):(r.isString(t)&&(t=r.propFcn(t)),i.__super__.constructor.call(this,(a=ABM.patches).numX,a.numY,function(){var i,e,h;for(h=[],i=0,e=a.length;e>i;i++)n=a[i],h.push(t(n));return h}())),this.useNearest=!0}return a(i,t),i.prototype.toPatchVar=function(t){var e,h,r,n;return e=function(){var i,e,a,o;for(a=n=ABM.patches,o=[],h=i=0,e=a.length;e>i;h=++i)r=a[h],o.push(r[t]=this.data[h]);return o}.call(this),new i(n.numX,n.numY,e)},i}(i)}.call(this);