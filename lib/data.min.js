!function(){var t;t=ABM.util,ABM.DataSet=function(){function h(t,h,i){null==t&&(t=0),null==h&&(h=0),null==i&&(i=[]),this.reset(t,h,i)}return h.patchDataSet=function(t){var i,e;return e=ABM.patches,new h(e.numX,e.numY,function(){var h,r,n;for(n=[],h=0,r=e.length;r>h;h++)i=e[h],n.push(i[t]);return n}())},h.imageDataSet=function(i,e){var r;return null==e&&(e=!1),r=new h,t.importImage(i,function(h){var i,n,o,a,s,u,d;for(window.img=h,i=t.imageToCtx(h),r.ctx=i,window.id=o=t.ctxToImageData(i),s=o.data,a=[],n=u=0,d=s.length;d>u;n=u+=4)e?a.push(s[n]):a.push(s[n]<<16|s[n+1]<<8|s[n+2]);return r.reset(i.canvas.width,i.canvas.height,a)}),r},h.ascDataSet=function(t){var i,e,r,n,o,a,s,u,d,l;for(o=t.split("\n"),i={},i.data=[],e=a=0;5>=a;e=++a)r=o[e].split(/\s+/),i[r[0].toLowerCase()]=parseFloat(r[1]);for(e=s=0,d=i.nrows;d>s;e=s+=1){for(n=o[6+e].trim().split(" "),e=u=0,l=n.length;l>=0?l>u:u>l;e=l>=0?++u:--u)n[e]=parseFloat(n[e]);i.data=i.data.concat(n)}return new h(i.ncols,i.nrows,i.data)},h.prototype.reset=function(h,i,e){return this.width=h,this.height=i,this.data=e,e.length!==h*i?t.error("DataSet: data array length error:\ndata.length: "+this.data.length+" width: "+this.width+" height: "+this.height):void 0},h.prototype.checkXY=function(h,i){return h>=0&&h<=this.width-1&&i>=0&&i<=this.height-1?void 0:t.error("x,y out of range: "+h+","+i)},h.prototype.nearest=function(t,h){return this.getXY(Math.round(t),Math.round(h))},h.prototype.bilinear=function(t,h){var i,e,r,n,o,a,s,u,d,l,p,c,f;return this.checkXY(t,h),d=Math.floor(t),l=Math.floor(h),s=this.toIndex(d,l),u=this.width,t-=d,h-=l,i=1-t,e=1-h,r=this.data[s],n=null!=(p=this.data[s+u])?p:0,o=null!=(c=this.data[++s])?c:0,a=null!=(f=this.data[s+u])?f:0,r*i*e+o*t*e+n*i*h+a*t*h},h.prototype.toIndex=function(t,h){return t+h*this.width},h.prototype.toXY=function(t){return[t%this.width,Math.floor(t/this.width)]},h.prototype.getXY=function(t,h){return this.checkXY(t,h),this.data[this.toIndex(t,h)]},h.prototype.setXY=function(t,h,i){return this.checkXY(t,h),this.data[this.toIndex(t,h)]=i},h.prototype.toString=function(h,i){var e,r,n,o,a;for(null==h&&(h=!1),null==i&&(i=2),n="width: "+this.width+" height: "+this.height+" data:",e=h?t.aToFixed(this.data,i):this.data,r=o=0,a=this.height;a>=0?a>o:o>a;r=a>=0?++o:--o)n+="\n"+(""+r+": "+e.slice(r*this.width,(r+1)*this.width));return n},h.prototype.toImage=function(h){var i,e,r,n,o,a,s,u,d;for(null==h&&(h=!0),i=t.createCtx(this.width,this.height),r=i.getImageData(0,0,this.width,this.height),s=r.data,o=t.normalize(this.data,0,Math.pow(2,h?8:24)-1e-6),window.norm=o,e=u=0,d=o.length;d>u;e=++u)a=o[e],n=4*e,s[n+3]=255,h?s[n]=s[n+1]=s[n+2]=Math.floor(a):(s[n]=a>>>16,s[n+1]=255&a>>8,s[n+2]=255&a);return window.ta=t.typedToJS(s),i.putImageData(r,0,0),i.canvas},h.prototype.samplePatchXY=function(t,h){var i;return i=ABM.world,t=t-i.minX+.5,h=i.maxY+.5-h,t*=this.width/i.numX,h*=this.height/i.numY,this.nearest(t,h)},h.prototype.setPatchVar=function(t){var h,i,e,r,n;for(r=ABM.patches,n=[],i=0,e=r.length;e>i;i++)h=r[i],n.push(h[t]=this.samplePatchXY(h.x,h.y));return n},h.prototype.resample=function(t,i){var e,r,n,o,a,s,u,d,l,p,c;if(t===this.width&&i===this.height)return this;for(e=[],a=(this.width-1)/(t-1),d=(this.height-1)/(i-1),r=a>=1||d>=1,console.log([t,i,a,d,r]),u=p=0;i>p;u=p+=1)for(o=c=0;t>c;o=c+=1)s=o*a,l=u*d,n=r?this.nearest(s,l):this.bilinear(s,l),e.push(n);return console.log([o,u,t,i,e,s,l]),new h(t,i,e)},h.prototype.neighborhood=function(h,i,e){var r,n,o,a,s,u;for(null==e&&(e=[]),e.length=0,n=s=-1;1>=s;n=++s)for(r=u=-1;1>=u;r=++u)o=t.clamp(h+r,0,this.width-1),a=t.clamp(i+n,0,this.height-1),e.push(this.data[this.toIndex(o,a)]);return e},h.prototype.convolve=function(i){var e,r,n,o,a,s,u,d;for(e=[],r=[],o=a=0,u=this.height;u>a;o=a+=1)for(n=s=0,d=this.width;d>s;n=s+=1)this.neighborhood(n,o,r),e.push(t.aSum(t.aPairMul(i,r)));return new h(this.width,this.height,e)},h.prototype.subset=function(i,e,r,n){var o,a,s,u,d,l,p;for((i+r>this.width||e+n>this.height)&&t.error("subSet: params out of range"),o=[],s=u=e,l=e+n;l>u;s=u+=1)for(a=d=i,p=i+r;p>d;a=d+=1)o.push(this.getXY(a,s));return new h(r,n,o)},h}()}.call(this);