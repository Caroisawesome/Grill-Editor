!function(){var t;t=ABM.util,ABM.DataSet=function(){function h(t,h,i){null==t&&(t=0),null==h&&(h=0),null==i&&(i=[]),this.reset(t,h,i)}return h.patchDataSet=function(t){var i,e;return e=ABM.patches,new h(e.numX,e.numY,function(){var h,n,r;for(r=[],h=0,n=e.length;n>h;h++)i=e[h],r.push(i[t]);return r}())},h.importImageDataSet=function(i,e,n,r){var a,o=this;return null==e&&(e=!1),null==n&&(n=!1),a=new h,t.importImage(i,function(t){return o.imageDataSet(t,e,n,a),null!=r?r(a):void 0}),a},h.imageDataSet=function(i,e,n,r){var a,o,s,u,l,p,c;for(null==e&&(e=!1),null==n&&(n=!1),null==r&&(r=new h),a=t.imageToCtx(i),s=t.ctxToImageData(a),l=s.data,u=[],o=p=0,c=l.length;c>p;o=p+=4)e?u.push(l[o]):n?u.push(l[o]<<24|l[o+1]<<16|l[o+2]<<8|l[o+3]):u.push(l[o]<<16|l[o+1]<<8|l[o+2]);return r.reset(a.canvas.width,a.canvas.height,u)},h.importAscDataSet=function(i,e){var n,r=this;return n=new h,t.xhrLoadFile(i,"text",function(t){return r.ascDataSet(t,n),null!=e?e(n):void 0}),n},h.ascDataSet=function(t,i){var e,n,r,a,o,s,u,l,p,c;for(null==i&&(i=new h),o=t.split("\n"),e={},e.data=[],n=s=0;5>=s;n=++s)r=o[n].split(/\s+/),e[r[0].toLowerCase()]=parseFloat(r[1]);for(n=u=0,p=e.nrows;p>u;n=u+=1){for(a=o[6+n].trim().split(" "),n=l=0,c=a.length;c>=0?c>l:l>c;n=c>=0?++l:--l)a[n]=parseFloat(a[n]);e.data=e.data.concat(a)}return i.reset(e.ncols,e.nrows,e.data)},h.prototype.reset=function(h,i,e){return this.width=h,this.height=i,this.data=e,e.length!==h*i&&t.error("DataSet: data array length error:\ndata.length: "+this.data.length+" width: "+this.width+" height: "+this.height),this},h.prototype.checkXY=function(h,i){return h>=0&&h<=this.width-1&&i>=0&&i<=this.height-1?void 0:t.error("x,y out of range: "+h+","+i)},h.prototype.nearest=function(t,h){return this.getXY(Math.round(t),Math.round(h))},h.prototype.bilinear=function(t,h){var i,e,n,r,a,o,s,u,l,p,c,d,f;return this.checkXY(t,h),l=Math.floor(t),p=Math.floor(h),s=this.toIndex(l,p),u=this.width,t-=l,h-=p,i=1-t,e=1-h,n=this.data[s],r=null!=(c=this.data[s+u])?c:0,a=null!=(d=this.data[++s])?d:0,o=null!=(f=this.data[s+u])?f:0,n*i*e+a*t*e+r*i*h+o*t*h},h.prototype.toIndex=function(t,h){return t+h*this.width},h.prototype.toXY=function(t){return[t%this.width,Math.floor(t/this.width)]},h.prototype.getXY=function(t,h){return this.checkXY(t,h),this.data[this.toIndex(t,h)]},h.prototype.setXY=function(t,h,i){return this.checkXY(t,h),this.data[this.toIndex(t,h)]=i},h.prototype.toString=function(h,i){var e,n,r,a,o;for(null==h&&(h=!1),null==i&&(i=2),r="width: "+this.width+" height: "+this.height+" data:",e=h?t.aToFixed(this.data,i):this.data,n=a=0,o=this.height;o>=0?o>a:a>o;n=o>=0?++a:--a)r+="\n"+(""+n+": "+e.slice(n*this.width,(n+1)*this.width));return r},h.prototype.toImage=function(h){var i,e,n,r,a,o,s,u,l;for(null==h&&(h=!0),i=t.createCtx(this.width,this.height),n=i.getImageData(0,0,this.width,this.height),s=n.data,a=t.normalize(this.data,0,Math.pow(2,h?8:24)-1e-6),e=u=0,l=a.length;l>u;e=++u)o=a[e],r=4*e,s[r+3]=255,h?s[r]=s[r+1]=s[r+2]=Math.floor(o):(s[r]=o>>>16,s[r+1]=255&o>>8,s[r+2]=255&o);return i.putImageData(n,0,0),i.canvas},h.prototype.toDrawing=function(t){var h;return null==t&&(t=!0),ABM.patches.installDrawing(h=this.toImage(t)),h},h.prototype.setPatchVar=function(t){var h,i,e,n,r,a;for(h=this.resample(ABM.patches.numX,ABM.patches.numY),r=ABM.patches,a=[],e=0,n=r.length;n>e;e++)i=r[e],a.push(i[t]=h.data[i.id]);return a},h.prototype.resample=function(t,i){var e,n,r,a,o,s,u,l,p,c,d;if(t===this.width&&i===this.height)return this;for(e=[],o=(this.width-1)/(t-1),l=(this.height-1)/(i-1),n=o>=1||l>=1,u=c=0;i>c;u=c+=1)for(a=d=0;t>d;a=d+=1)s=a*o,p=u*l,r=n?this.nearest(s,p):this.bilinear(s,p),e.push(r);return new h(t,i,e)},h.prototype.neighborhood=function(h,i,e){var n,r,a,o,s,u;for(null==e&&(e=[]),e.length=0,r=s=-1;1>=s;r=++s)for(n=u=-1;1>=u;n=++u)a=t.clamp(h+n,0,this.width-1),o=t.clamp(i+r,0,this.height-1),e.push(this.data[this.toIndex(a,o)]);return e},h.prototype.convolve=function(i){var e,n,r,a,o,s,u,l;for(e=[],n=[],a=o=0,u=this.height;u>o;a=o+=1)for(r=s=0,l=this.width;l>s;r=s+=1)this.neighborhood(r,a,n),e.push(t.aSum(t.aPairMul(i,n)));return new h(this.width,this.height,e)},h.prototype.subset=function(i,e,n,r){var a,o,s,u,l,p,c;for((i+n>this.width||e+r>this.height)&&t.error("subSet: params out of range"),a=[],s=u=e,p=e+r;p>u;s=u+=1)for(o=l=i,c=i+n;c>l;o=l+=1)a.push(this.getXY(o,s));return new h(n,r,a)},h}()}.call(this);