!function(){var t,i,e,r,h,n={}.hasOwnProperty,s=function(t,i){function e(){this.constructor=t}for(var r in i)n.call(i,r)&&(t[r]=i[r]);return e.prototype=i.prototype,t.prototype=new e,t.__super__=i.prototype,t};h=ABM.util,ABM.DataSet=i=function(){function i(t,i,e){null==t&&(t=0),null==i&&(i=0),null==e&&(e=[]),this.useNearest=!1,this.reset(t,i,e)}return i.patchDataSet=function(t){return new r(t)},i.importImageDataSet=function(t,i,r){var n;return null==i&&(i=3),n=new e(null,i),h.importImage(t,function(t){return n.parse(t),null!=r?r(n):void 0}),n},i.importAscDataSet=function(i,e){var r;return r=new t,h.xhrLoadFile(i,"text",function(t){return r.parse(t),null!=e?e(r):void 0}),r},i.prototype.reset=function(t,i,e){return this.width=t,this.height=i,this.data=e,e.length!==t*i&&h.error("DataSet: data array length error:\ndata.length: "+this.data.length+" width: "+this.width+" height: "+this.height),this},i.prototype.checkXY=function(t,i){return t>=0&&t<=this.width-1&&i>=0&&i<=this.height-1?void 0:h.error("x,y out of range: "+t+","+i)},i.prototype.setSampler=function(t){this.useNearest=t},i.prototype.sample=function(t,i){return this.useNearest?this.nearest(t,i):this.bilinear(t,i)},i.prototype.nearest=function(t,i){return this.getXY(Math.round(t),Math.round(i))},i.prototype.bilinear=function(t,i){var e,r,h,n,s,a,o,u,l,p,c,d,f;return this.checkXY(t,i),l=Math.floor(t),p=Math.floor(i),o=this.toIndex(l,p),u=this.width,t-=l,i-=p,e=1-t,r=1-i,h=this.data[o],n=null!=(c=this.data[o+u])?c:0,s=null!=(d=this.data[++o])?d:0,a=null!=(f=this.data[o+u])?f:0,h*e*r+s*t*r+n*e*i+a*t*i},i.prototype.toIndex=function(t,i){return t+i*this.width},i.prototype.toXY=function(t){return[t%this.width,Math.floor(t/this.width)]},i.prototype.getXY=function(t,i){return this.checkXY(t,i),this.data[this.toIndex(t,i)]},i.prototype.setXY=function(t,i,e){return this.checkXY(t,i),this.data[this.toIndex(t,i)]=e},i.prototype.toString=function(t,i){var e,r,n,s,a;for(null==t&&(t=2),null==i&&(i=", "),n="width: "+this.width+" height: "+this.height+" data:",e=0>t?this.data:h.aToFixed(this.data,t),r=s=0,a=this.height;a>=0?a>s:s>a;r=a>=0?++s:--s)n+="\n"+(""+r+": "+e.slice(r*this.width,(r+1)*this.width));return n.replace(/,/g,i)},i.prototype.toImage=function(t,i,e){var r,n,s,a,o,u,l,p,c,d,f;for(null==t&&(t=!0),null==i&&(i=!0),null==e&&(e=255),r=h.createCtx(this.width,this.height),a=r.getImageData(0,0,this.width,this.height),c=a.data,u=Math.pow(2,t?8:24),l=i?h.normalize(this.data,0,u-1e-6):function(){var t,i,e,r;for(e=this.data,r=[],t=0,i=e.length;i>t;t++)n=e[t],r.push(h.clamp(Math.round(n),0,u-1));return r}.call(this),s=d=0,f=l.length;f>d;s=++d)p=l[s],o=4*s,c[o+3]=e,t?c[o]=c[o+1]=c[o+2]=Math.floor(p):(c[o]=p>>>16,c[o+1]=255&p>>8,c[o+2]=255&p);return r.putImageData(a,0,0),r.canvas},i.prototype.toDrawing=function(t){var i;return null==t&&(t=!0),ABM.patches.installDrawing(i=this.toImage(t)),i},i.prototype.toPatchColors=function(t){var i;return null==t&&(t=!0),ABM.patches.installColors(i=this.toImage(t)),i},i.prototype.toPatchVar=function(t){var i,e,h;return i=function(){var i,r,n,s;for(n=h=ABM.patches,s=[],i=0,r=n.length;r>i;i++)e=n[i],s.push(e[t]=this.patchSample(e.x,e.y));return s}.call(this),new r(h.numX,h.numY,i)},i.prototype.coordSample=function(t,i,e,r,h,n){var s,a;return s=(t-e)*(this.width-1)/h,a=(r-i)*(this.height-1)/n,this.sample(s,a)},i.prototype.patchSample=function(t,i){var e;return e=ABM.world,this.coordSample(t,i,e.minXcor,e.maxYcor,e.numX,e.numY)},i.prototype.resample=function(t,e){var r,h,n,s,a,o,u,l,p;if(t===this.width&&e===this.height)return new i(t,e,this.data);for(r=[],n=(this.width-1)/(t-1),o=(this.height-1)/(e-1),a=l=0;e>l;a=l+=1)for(h=p=0;t>p;h=p+=1)s=h*n,u=a*o,r.push(this.sample(s,u));return new i(t,e,r)},i.prototype.neighborhood=function(t,i,e){var r,n,s,a,o,u;for(null==e&&(e=[]),e.length=0,n=o=-1;1>=o;n=++o)for(r=u=-1;1>=u;r=++u)s=h.clamp(t+r,0,this.width-1),a=h.clamp(i+n,0,this.height-1),e.push(this.data[this.toIndex(s,a)]);return e},i.prototype.convolve=function(t,e){var r,n,s,a,o,u,l,p;for(null==e&&(e=1),r=[],n=[],a=o=0,l=this.height;l>o;a=o+=1)for(s=u=0,p=this.width;p>u;s=u+=1)this.neighborhood(s,a,n),r.push(h.aSum(h.aPairMul(t,n))*e);return new i(this.width,this.height,r)},i.prototype.slopeAndAspect=function(t,e,r){var n,s,a,o,u,l,p,c,d,f,m;if(null==t&&(t=1),null==e&&(e=!0),null==r&&(r=!1),null==this.slope){for(this.dzdx=this.convolve([-1,0,1,-2,0,2,-1,0,1],1/8),this.dzdy=this.convolve([1,2,1,0,0,0,-1,-2,-1],1/8),n=[],u=[],p=c=0,f=this.height;f>c;p=c+=1)for(l=d=0,m=this.width;m>d;l=d+=1){for(s=this.dzdx.getXY(l,p),a=this.dzdy.getXY(l,p),u.push(Math.atan(Math.sqrt(s*s+a*a)/t));e&&s===a;)s+=h.randomNormal(0,.01),a+=h.randomNormal(0,.01);o=s===a&&0===a?0/0:Math.atan2(-a,-s),r&&0>o&&(o+=2*Math.PI),n.push(o)}this.slope=new i(this.width,this.height,u),this.aspect=new i(this.width,this.height,n)}return[this.slope,this.aspect,this.dzdx,this.dzdy]},i.prototype.subset=function(t,e,r,n){var s,a,o,u,l,p,c;for((t+r>this.width||e+n>this.height)&&h.error("subSet: params out of range"),s=[],o=u=e,p=e+n;p>u;o=u+=1)for(a=l=t,c=t+r;c>l;a=l+=1)s.push(this.getXY(a,o));return new i(r,n,s)},i}(),ABM.AscDataSet=t=function(t){function i(t){this.str=null!=t?t:"",i.__super__.constructor.call(this),0!==this.str.length&&this.parse(this.str)}return s(i,t),i.prototype.parse=function(t){var i,e,r,h,n,s,a,o,u;for(this.str=t,h=t.split("\n"),this.header={},i=n=0;5>=n;i=++n)e=h[i].split(/\s+/),this.header[e[0].toLowerCase()]=parseFloat(e[1]);for(i=s=0,o=this.header.nrows;o>s;i=s+=1){for(r=h[6+i].trim().split(" "),i=a=0,u=r.length;u>=0?u>a:a>u;i=u>=0?++a:--a)r[i]=parseFloat(r[i]);this.data=this.data.concat(r)}return this.reset(this.header.ncols,this.header.nrows,this.data)},i}(i),ABM.ImageDataSet=e=function(t){function i(t,e){this.img=t,this.byteFmt=null!=e?e:3,i.__super__.constructor.call(this),null!=this.img&&this.parse(this.img)}return s(i,t),i.prototype.ByteFmts=[[2],[1,2],[0,1,2],[3,0,1,2]],i.prototype.checkByteFmt=function(){var t;return h.isArray(this.byteFmt)?this.byteFmt.length>4||h.aMax(this.byteFmt)>3||h.aMin(this.byteFmt)<0?h.error("bad ImageDataSet byte format array: "+this.byteFmt):void 0:(1!==(t=this.byteFmt)&&2!==t&&3!==t&&4!==t&&8!==t&&16!==t&&24!==t&&32!==t&&h.error("bad ImageDataSet byte/bit format int: "+this.byteFmt),this.byteFmt>4&&(this.byteFmt=this.byteFmt/8),this.byteFmt=this.ByteFmts[this.byteFmt-1])},i.prototype.parse=function(t){var i,e,r,n,s,a,o,u,l;for(this.img=t,this.checkByteFmt(this.byteFmt),this.ctx=h.imageToCtx(this.img),r=h.ctxToImageData(this.ctx).data,i=s=0,u=r.length;u>s;i=s+=4){for(n=0,l=this.byteFmt,a=0,o=l.length;o>a;a++)e=l[a],n=256*n+r[i+e];this.data.push(n)}return this.reset(this.ctx.canvas.width,this.ctx.canvas.height,this.data)},i}(i),ABM.PatchDataSet=r=function(t){function i(t,e,r){var n,s;h.isArray(r)?i.__super__.constructor.call(this,t,e,r):(h.isString(t)&&(t=h.propFcn(t)),i.__super__.constructor.call(this,(s=ABM.patches).numX,s.numY,function(){var i,e,r;for(r=[],i=0,e=s.length;e>i;i++)n=s[i],r.push(t(n));return r}())),this.useNearest=!0}return s(i,t),i.prototype.toPatchVar=function(t){var e,r,h,n;return e=function(){var i,e,s,a;for(s=n=ABM.patches,a=[],r=i=0,e=s.length;e>i;r=++i)h=s[r],a.push(h[t]=this.data[r]);return a}.call(this),new i(n.numX,n.numY,e)},i}(i)}.call(this);