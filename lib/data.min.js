!function(){var t,e,h,i,r={}.hasOwnProperty,n=function(t,e){function h(){this.constructor=t}for(var i in e)r.call(e,i)&&(t[i]=e[i]);return h.prototype=e.prototype,t.prototype=new h,t.__super__=e.prototype,t};i=ABM.util,ABM.DataSet=e=function(){function e(t,e,h){null==t&&(t=0),null==e&&(e=0),null==h&&(h=[]),this.useNearest=!1,this.reset(t,e,h)}return e.patchDataSet=function(t){var h,i;return new e((i=ABM.patches).numX,i.numY,function(){var e,r,n;for(n=[],e=0,r=i.length;r>e;e++)h=i[e],n.push(h[t]);return n}())},e.importImageDataSet=function(t,e,r){var n;return null==e&&(e=3),n=new h,i.importImage(t,function(t){return n.parse(t),null!=r?r(n):void 0}),n},e.importAscDataSet=function(e,h){var r;return r=new t,i.xhrLoadFile(e,"text",function(t){return r.parse(t),null!=h?h(r):void 0}),r},e.prototype.reset=function(t,e,h){return this.width=t,this.height=e,this.data=h,h.length!==t*e&&i.error("DataSet: data array length error:\ndata.length: "+this.data.length+" width: "+this.width+" height: "+this.height),this},e.prototype.checkXY=function(t,e){return t>=0&&t<=this.width-1&&e>=0&&e<=this.height-1?void 0:i.error("x,y out of range: "+t+","+e)},e.prototype.setSampler=function(t){this.useNearest=t},e.prototype.sample=function(t,e){return this.useNearest?this.nearest(t,e):this.bilinear(t,e)},e.prototype.nearest=function(t,e){return this.getXY(Math.round(t),Math.round(e))},e.prototype.bilinear=function(t,e){var h,i,r,n,a,o,s,u,p,l,c,d,f;return this.checkXY(t,e),p=Math.floor(t),l=Math.floor(e),s=this.toIndex(p,l),u=this.width,t-=p,e-=l,h=1-t,i=1-e,r=this.data[s],n=null!=(c=this.data[s+u])?c:0,a=null!=(d=this.data[++s])?d:0,o=null!=(f=this.data[s+u])?f:0,r*h*i+a*t*i+n*h*e+o*t*e},e.prototype.toIndex=function(t,e){return t+e*this.width},e.prototype.toXY=function(t){return[t%this.width,Math.floor(t/this.width)]},e.prototype.getXY=function(t,e){return this.checkXY(t,e),this.data[this.toIndex(t,e)]},e.prototype.setXY=function(t,e,h){return this.checkXY(t,e),this.data[this.toIndex(t,e)]=h},e.prototype.toString=function(t,e){var h,r,n,a,o;for(null==t&&(t=2),null==e&&(e=", "),n="width: "+this.width+" height: "+this.height+" data:",h=0>t?this.data:i.aToFixed(this.data,t),r=a=0,o=this.height;o>=0?o>a:a>o;r=o>=0?++a:--a)n+="\n"+(""+r+": "+h.slice(r*this.width,(r+1)*this.width));return n.replace(/,/g,e)},e.prototype.toImage=function(t,e,h){var r,n,a,o,s,u,p,l,c,d,f;for(null==t&&(t=!0),null==e&&(e=!0),null==h&&(h=255),r=i.createCtx(this.width,this.height),o=r.getImageData(0,0,this.width,this.height),c=o.data,u=Math.pow(2,t?8:24),p=e?i.normalize(this.data,0,u-1e-6):function(){var t,e,h,r;for(h=this.data,r=[],t=0,e=h.length;e>t;t++)n=h[t],r.push(i.clamp(Math.round(n),0,u-1));return r}.call(this),a=d=0,f=p.length;f>d;a=++d)l=p[a],s=4*a,c[s+3]=h,t?c[s]=c[s+1]=c[s+2]=Math.floor(l):(c[s]=l>>>16,c[s+1]=255&l>>8,c[s+2]=255&l);return r.putImageData(o,0,0),r.canvas},e.prototype.toDrawing=function(t){var e;return null==t&&(t=!0),ABM.patches.installDrawing(e=this.toImage(t)),e},e.prototype.toPatchColors=function(t){var e;return null==t&&(t=!0),ABM.patches.installColors(e=this.toImage(t)),e},e.prototype.toPatchVar=function(t){var h,i;return h=function(){var e,h,r,n;for(r=ABM.patches,n=[],e=0,h=r.length;h>e;e++)i=r[e],n.push(i[t]=this.patchSample(i.x,i.y));return n}.call(this),new e(ABM.patches.numX,ABM.patches.numY,h)},e.prototype.coordSample=function(t,e,h,i,r,n){var a,o;return a=(t-h)*(this.width-1)/r,o=(i-e)*(this.height-1)/n,this.sample(a,o)},e.prototype.patchSample=function(t,e){var h;return h=ABM.world,this.coordSample(t,e,h.minXcor,h.maxYcor,h.numX,h.numY)},e.prototype.resample=function(t,h){var i,r,n,a,o,s,u,p,l;if(t===this.width&&h===this.height)return new e(t,h,this.data);for(i=[],n=(this.width-1)/(t-1),s=(this.height-1)/(h-1),o=p=0;h>p;o=p+=1)for(r=l=0;t>l;r=l+=1)a=r*n,u=o*s,i.push(this.sample(a,u));return new e(t,h,i)},e.prototype.neighborhood=function(t,e,h){var r,n,a,o,s,u;for(null==h&&(h=[]),h.length=0,n=s=-1;1>=s;n=++s)for(r=u=-1;1>=u;r=++u)a=i.clamp(t+r,0,this.width-1),o=i.clamp(e+n,0,this.height-1),h.push(this.data[this.toIndex(a,o)]);return h},e.prototype.convolve=function(t,h){var r,n,a,o,s,u,p,l;for(null==h&&(h=1),r=[],n=[],o=s=0,p=this.height;p>s;o=s+=1)for(a=u=0,l=this.width;l>u;a=u+=1)this.neighborhood(a,o,n),r.push(i.aSum(i.aPairMul(t,n))*h);return new e(this.width,this.height,r)},e.prototype.slopeAndAspect=function(t,h){var i,r,n,a,o,s,u,p,l,c,d,f,g;for(null==t&&(t=1),null==h&&(h=!1),r=this.convolve([-1,0,1,-2,0,2,-1,0,1],1/8),n=this.convolve([1,2,1,0,0,0,-1,-2,-1],1/8),i=[],u=[],l=c=0,f=this.height;f>c;l=c+=1)for(p=d=0,g=this.width;g>d;p=d+=1)a=r.getXY(p,l),o=n.getXY(p,l),u.push(Math.atan(Math.sqrt(a*a+o*o)/t)),s=a===o&&0===o?0/0:Math.atan2(-o,-a),h&&0>s&&(s+=2*Math.PI),i.push(s);return u=new e(this.width,this.height,u),i=new e(this.width,this.height,i),[u,i,r,n]},e.prototype.subset=function(t,h,r,n){var a,o,s,u,p,l,c;for((t+r>this.width||h+n>this.height)&&i.error("subSet: params out of range"),a=[],s=u=h,l=h+n;l>u;s=u+=1)for(o=p=t,c=t+r;c>p;o=p+=1)a.push(this.getXY(o,s));return new e(r,n,a)},e}(),ABM.AscDataSet=t=function(t){function e(t){this.str=null!=t?t:"",e.__super__.constructor.call(this),0!==this.str.length&&this.parse(this.str)}return n(e,t),e.prototype.parse=function(t){var e,h,i,r,n,a,o,s,u;for(this.str=t,r=t.split("\n"),this.header={},e=n=0;5>=n;e=++n)h=r[e].split(/\s+/),this.header[h[0].toLowerCase()]=parseFloat(h[1]);for(e=a=0,s=this.header.nrows;s>a;e=a+=1){for(i=r[6+e].trim().split(" "),e=o=0,u=i.length;u>=0?u>o:o>u;e=u>=0?++o:--o)i[e]=parseFloat(i[e]);this.data=this.data.concat(i)}return this.reset(this.header.ncols,this.header.nrows,this.data)},e}(e),ABM.ImageDataSet=h=function(t){function e(t,h){this.img=t,this.byteFmt=null!=h?h:3,e.__super__.constructor.call(this),null!=this.img&&this.parse(this.img)}return n(e,t),e.prototype.ByteFmts=[[2],[1,2],[0,1,2],[3,0,1,2]],e.prototype.checkByteFmt=function(){var t;return i.isArray(this.byteFmt)?this.byteFmt.length>4||i.aMax(this.byteFmt)>3||i.aMin(this.byteFmt)<0?i.error("bad ImageDataSet byte format array: "+this.byteFmt):void 0:(1!==(t=this.byteFmt)&&2!==t&&3!==t&&4!==t&&8!==t&&16!==t&&24!==t&&32!==t&&i.error("bad ImageDataSet byte/bit format int: "+this.byteFmt),this.byteFmt>4&&(this.byteFmt=this.byteFmt/8),this.byteFmt=this.ByteFmts[this.byteFmt-1])},e.prototype.parse=function(t){var e,h,r,n,a,o,s,u,p;for(this.img=t,this.checkByteFmt(this.byteFmt),this.ctx=i.imageToCtx(this.img),r=i.ctxToImageData(this.ctx).data,e=a=0,u=r.length;u>a;e=a+=4){for(n=0,p=this.byteFmt,o=0,s=p.length;s>o;o++)h=p[o],n=256*n+r[e+h];this.data.push(n)}return this.reset(this.ctx.canvas.width,this.ctx.canvas.height,this.data)},e}(e)}.call(this);