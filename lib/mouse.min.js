(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};ABM.Mouse=function(){function e(e,s){this.model=e,this.callback=s,this.delegateMouseOverAndOutEvents=t(this.delegateMouseOverAndOutEvents,this),this.delegateDragEvents=t(this.delegateDragEvents,this),this.computeEventTypes=t(this.computeEventTypes,this),this.handleMouseEvent=t(this.handleMouseEvent,this),this.handleStep=t(this.handleStep,this),this.handleMouseMove=t(this.handleMouseMove,this),this.handleMouseUp=t(this.handleMouseUp,this),this.handleMouseDown=t(this.handleMouseDown,this),this.lastX=1/0,this.lastY=1/0,this.div=this.model.div,this.lastAgents=[],this.draggingAgents=[],this.start()}return e.prototype.start=function(){return this.div.addEventListener("mousedown",this.handleMouseDown,!1),document.body.addEventListener("mouseup",this.handleMouseUp,!1),this.div.addEventListener("mousemove",this.handleMouseMove,!1),this.model.on("step",this.handleStep),this.lastX=this.lastY=this.x=this.y=this.pixX=this.pixY=0/0,this.moved=this.down=!1},e.prototype.stop=function(){return this.div.removeEventListener("mousedown",this.handleMouseDown,!1),document.body.removeEventListener("mouseup",this.handleMouseUp,!1),this.div.removeEventListener("mousemove",this.handleMouseMove,!1),this.model.off("step",this.handleStep),this.lastX=this.lastY=this.x=this.y=this.pixX=this.pixY=0/0,this.moved=this.down=!1},e.prototype.handleMouseDown=function(t){return this.down=!0,this.moved=!1,this.handleMouseEvent(t)},e.prototype.handleMouseUp=function(t){return this.down=!1,this.moved=!1,this.handleMouseEvent(t)},e.prototype.handleMouseMove=function(t){return this.setXY(t),this.moved=!0,this.handleMouseEvent(t)},e.prototype.handleStep=function(){return isNaN(this.x)?void 0:this.delegateMouseOverAndOutEvents(this.x,this.y)},e.prototype.handleMouseEvent=function(t){var e;return e=this.computeEventTypes(),this.delegateEventsToAllAgents(e,t),null!=this.callback?this.callback(t):void 0},e.prototype.setXY=function(t){var e;return this.lastX=this.x,this.lastY=this.y,this.pixX=t.offsetX,this.pixY=t.offsetY,e=this.model.patches.pixelXYtoPatchXY(this.pixX,this.pixY),this.x=e[0],this.y=e[1],this.dx=this.lastX-this.x,this.dy=this.lastY-this.y},e.prototype.computeEventTypes=function(){var t;return t=[],this.down&&!this.moved&&t.push("mousedown"),this.down||this.moved||t.push("mouseup"),this.down&&this.moved&&(this.dragging||t.push("dragstart"),this.dragging=!0),!this.down&&this.dragging&&(this.dragging=!1,this.dragEnd=!0),this.moved&&t.push("mousemove"),t},e.prototype.delegateEventsToAllAgents=function(t,e){return this.delegateEventsToAgentsAtPoint(t,this.x,this.y,e),this.delegateEventsToLinksAtPoint(t,this.x,this.y,e),this.delegateEventsToPatchAtPoint(t,this.x,this.y,e),this.delegateDragEvents(this.x,this.y,e),this.delegateMouseOverAndOutEvents(this.x,this.y,e)},e.prototype.delegateEventsToPatchAtPoint=function(t,e,s,i){var n,h,o,a,r;for(n=this.model.patches.patch(e,s),r=[],o=0,a=t.length;a>o;o++)h=t[o],r.push(this.emitAgentEvent(h,n,this.mouseEvent(n,i)));return r},e.prototype.delegateEventsToAgentsAtPoint=function(t,e,s,i){var n,h,o,a,r,d,u,l;for(h=this.model.patches.patch(e,s),u=h.n.concat(h),l=[],r=0,d=u.length;d>r;r++)o=u[r],l.push(function(){var h,r,d,u;for(d=o.agentsHere(),u=[],h=0,r=d.length;r>h;h++)n=d[h],n.hitTest(e,s)?u.push(function(){var e,s,h;for(h=[],e=0,s=t.length;s>e;e++)a=t[e],h.push(this.emitAgentEvent(a,n,this.mouseEvent(n,i)));return h}.call(this)):u.push(void 0);return u}.call(this));return l},e.prototype.delegateEventsToLinksAtPoint=function(t,e,s,i){var n,h,o,a,r,d,u;for(d=this.model.links,u=[],a=0,r=d.length;r>a;a++)n=d[a],n.hitTest(e,s)?(h=this.mouseEvent(n,i),u.push(function(){var e,s,i;for(i=[],e=0,s=t.length;s>e;e++)o=t[e],i.push(this.emitAgentEvent(o,n,h));return i}.call(this))):u.push(void 0);return u},e.prototype.emitAgentEvent=function(t,e,s){return this.updateDraggingAgents(t,e),e.emit(t,s)},e.prototype.updateDraggingAgents=function(t,e){return"dragstart"===t?this.draggingAgents.push(e):void 0},e.prototype.delegateDragEvents=function(t,e,s){var i,n,h,o,a;for(a=this.draggingAgents,h=0,o=a.length;o>h;h++)i=a[h],n=this.mouseEvent(i,s),this.moved&&i.emit("drag",n),this.dragEnd&&i.emit("dragend",n);return this.dragEnd?(this.draggingAgents=[],this.dragEnd=!1):void 0},e.prototype.delegateMouseOverAndOutEvents=function(t,e,s){var i,n,h,o,a,r,d,l,v,p,g,m,c;for(o={},h=[],r=this.model.patches.patch(t,e),h=u.clone(this.model.links),c=r.n.concat(r),l=0,p=c.length;p>l;l++)d=c[l],h=h.concat(d.agentsHere());for(v=0,g=h.length;g>v;v++)i=h[v],i.hitTest(t,e)&&(null==o[m=i.breed.name]&&(o[m]={}),o[i.breed.name][i.id]=i,this.lastAgents[i.breed.name]&&i.id in this.lastAgents[i.breed.name]||i.emit("mouseover",this.mouseEvent(i,s)));for(a in this.lastAgents)for(n in this.lastAgents[a])o[a]&&n in o[a]||(i=this.lastAgents[a][n],i.emit("mouseout",this.mouseEvent(i,s)));return this.lastAgents=o},e.prototype.mouseEvent=function(t,e){return{target:t,patchX:this.x,patchY:this.y,dx:this.dx,dy:this.dy,originalEvent:e}},e}()}).call(this);