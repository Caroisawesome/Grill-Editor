<html>
  <head>
    <title>AgentScript Model</title>
    <script src="../agentscript.js"></script>
    <script src="../coffee-script.js"></script>
    <script type="text/coffeescript">
    class MyModel extends ABM.Model
      u = ABM.util # utilities; static variable
      setup: -> # called by Model ctor
        @refreshPatches = false # for static patches
        
        # globals
        @population = 4
        @sun = true
        @agents.setDefaultShape "circle"
        @v0max = 1
        @gravExp = -2
        
        window.foo = @patches.nOf(@population)
        for p in @patches.nOf(@population)
          p.sprout 1, (a) =>
            if @sun and a.id is 0
              a.mass = 10000; a.setXY 0,0; a.vx = a.vy = 0
            else
              a.mass = 10 + u.randomInt(1000)
              a.vx = @v0max * (1 - u.randomFloat(2))
              a.vy = @v0max * (1 - u.randomFloat(2))
              a.penDown = true
            a.size = 3 * u.log10(a.mass)
      step: ->
        for a in @agents
          for a1 in @agents.other(a)
            k = Math.pow(10, @gravExp)*a1.mass/Math.max(Math.pow(a.distance(a1),3), .000001)
            a.vx += (a1.x-a.x)*k; a.vy += (a1.y-a.y)*k
        for a in @agents when not (@sun and a.id is 0)
          # if not (@sun and a.id is 0)
          a.setXY u.clamp(a.x+a.vx, @patches.minX, @patches.maxX),
                  u.clamp(a.y+a.vy, @patches.minY, @patches.maxY)
          a.vx = u.sign(-a.x)*.001 if Math.abs(a.x) is @patches.maxX
          a.vy = u.sign(-a.y)*.001 if Math.abs(a.y) is @patches.maxY
          # a.setXY 0,0 if @sun and a.id is 0
        null
        

    # divName, patchSize, minX, maxX, minY, maxY, isTorus = true
    #   NL Defaults: 13, -16, 16, -16, 16, true
    # @APP is window.APP, @ = outer coffeescript wrapper context
    APP=new MyModel "layers", 2, -110, 110, -100, 100, false
    APP.setRootVars()
    
    </script>

  </head>
  <body onload="ABM.model.start()">
    <canvas id="testCanvas">Your browser does not support HTML5 Canvas.</canvas>
    <div id="layers"></div>
  </body>
</html>